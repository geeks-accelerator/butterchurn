!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).butterchurn={})}(this,function(t){"use strict";{const t=(t,e)=>{var s="function"==typeof e,i="function"==typeof e,r="function"==typeof e;Object.defineProperty(Math,t,{configurable:s,enumerable:r,writable:i,value:e})};t("DEG_PER_RAD",Math.PI/180),t("RAD_PER_DEG",180/Math.PI);const e=new Float32Array(1);t("scale",function(t,e,s,i,r){return 0===arguments.length||Number.isNaN(t)||Number.isNaN(e)||Number.isNaN(s)||Number.isNaN(i)||Number.isNaN(r)?NaN:t===1/0||t===-1/0?t:(t-e)*(r-i)/(s-e)+i}),t("fscale",function(t,s,i,r,a){return e[0]=Math.scale(t,s,i,r,a),e[0]}),t("clamp",function(t,e,s){return Math.min(s,Math.max(e,t))}),t("radians",function(t){return t*Math.DEG_PER_RAD}),t("degrees",function(t){return t*Math.RAD_PER_DEG})}var e=1e-5;function s(t,e){let s={destCol:1,srcCol:1,srcLine:1};t.forEach(t=>{t.destCol>e||(s=t)});const i=e-s.destCol;return{column:s.srcCol+i,line:s.srcLine}}window.sqr=function(t){return t*t},window.sqrt=function(t){return Math.sqrt(Math.abs(t))},window.log10=function(t){return Math.log(t)*Math.LOG10E},window.sign=function(t){return t>0?1:t<0?-1:0},window.rand=function(t){var e=Math.floor(t);return e<1?Math.random():Math.random()*e},window.randint=function(t){return Math.floor(rand(t))},window.bnot=function(t){return Math.abs(t)<e?1:0},window.pow=function(t,e){var s,i=Math.pow(t,e);return s=i,!isFinite(s)||isNaN(s)?0:i},window.div=function(t,e){return 0===e?0:t/e},window.mod=function(t,e){return 0===e?0:Math.floor(t)%Math.floor(e)},window.bitor=function(t,e){return Math.floor(t)|Math.floor(e)},window.bitand=function(t,e){return Math.floor(t)&Math.floor(e)},window.sigmoid=function(t,s){var i=1+Math.exp(-t*s);return Math.abs(i)>e?1/i:0},window.bor=function(t,s){return Math.abs(t)>e||Math.abs(s)>e?1:0},window.band=function(t,s){return Math.abs(t)>e&&Math.abs(s)>e?1:0},window.equal=function(t,s){return Math.abs(t-s)<e?1:0},window.above=function(t,e){return t>e?1:0},window.below=function(t,e){return t<e?1:0},window.ifcond=function(t,s,i){return Math.abs(t)>e?s:i},window.memcpy=function(t,e,s,i){let r=e,a=s,o=i;return a<0&&(o+=a,r-=a,a=0),r<0&&(o+=r,a-=r,r=0),o>0&&t.copyWithin(r,a,o),e};var i=function(){var t=function(t,e,s,i){for(s=s||{},i=t.length;i--;s[t[i]]=e);return s},e=[1,18],s=[1,7],i=[1,19],r=[1,20],a=[1,14],o=[1,15],n=[1,16],h=[1,33],l=[1,31],A=[1,23],c=[1,22],g=[1,24],m=[1,25],u=[1,26],d=[1,27],f=[1,28],p=[1,29],b=[1,30],_=[5,8,15,18,20,28,29,32,33,34,35,36,37,38],v=[5,15,18],E=[5,12,15,17,18,24,25,28,29,30],x=[1,57],w=[5,8,12,15,17,18,24,25,28,29,30],y=[15,18],S=[5,8,15,18,28,29,38],P=[5,8,15,18,28,29,32,33,38],T=[5,8,15,18,28,29,32,33,34,37,38],I=[5,8,15,18,28,29,32,33,34,35,36,37,38],R=[5,8,15,18],B=[5,8,15,18,20,22,28,29,32,33,34,35,36,37,38],C={trace:function(){},yy:{},symbols_:{error:2,SCRIPT:3,expression:4,EOF:5,expressionsOptionalTrailingSemi:6,separator:7,";":8,expressions:9,EXPRESSION_BLOCK:10,IDENTIFIER:11,IDENTIFIER_TOKEN:12,argument:13,arguments:14,",":15,FUNCTION_CALL:16,"(":17,")":18,LOGICAL_EXPRESSION:19,LOGICAL_OPERATOR_TOKEN:20,ASSIGNMENT:21,ASSIGNMENT_OPERATOR_TOKEN:22,number:23,DIGITS_TOKEN:24,".":25,NUMBER_LITERAL:26,UNARY_EXPRESSION:27,"-":28,"+":29,"!":30,BINARY_EXPRESSION:31,"*":32,"/":33,"%":34,"&":35,"|":36,"^":37,COMPARISON_TOKEN:38,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",8:";",12:"IDENTIFIER_TOKEN",15:",",17:"(",18:")",20:"LOGICAL_OPERATOR_TOKEN",22:"ASSIGNMENT_OPERATOR_TOKEN",24:"DIGITS_TOKEN",25:".",28:"-",29:"+",30:"!",32:"*",33:"/",34:"%",35:"&",36:"|",37:"^",38:"COMPARISON_TOKEN"},productions_:[0,[3,2],[3,2],[3,1],[7,1],[7,2],[9,2],[9,3],[6,1],[6,2],[10,1],[11,1],[13,1],[13,1],[14,1],[14,3],[16,3],[16,4],[19,3],[21,3],[21,3],[23,1],[23,2],[23,3],[23,2],[23,1],[26,1],[27,2],[27,2],[27,2],[31,3],[31,3],[31,3],[31,3],[31,3],[31,3],[31,3],[31,3],[31,3],[4,1],[4,1],[4,3],[4,1],[4,1],[4,1],[4,1],[4,1],[4,3]],performAction:function(t,e,s,i,r,a,o){var n=a.length-1;switch(r){case 1:return{type:"SCRIPT",body:[a[n-1]],loc:this._$};case 2:return{type:"SCRIPT",body:a[n-1],loc:this._$};case 3:return{type:"SCRIPT",body:[],loc:this._$};case 6:this.$=[a[n-1]];break;case 7:this.$=a[n-2].concat([a[n-1]]);break;case 8:this.$=a[n];break;case 9:this.$=a[n-1].concat([a[n]]);break;case 10:this.$={type:"EXPRESSION_BLOCK",body:a[n],loc:this._$};break;case 11:this.$={type:"IDENTIFIER",value:a[n].toLowerCase(),loc:this._$};break;case 14:this.$=[a[n]];break;case 15:this.$=a[n-2].concat([a[n]]);break;case 16:this.$={type:"CALL_EXPRESSION",callee:a[n-2],arguments:[],loc:this._$};break;case 17:this.$={type:"CALL_EXPRESSION",callee:a[n-3],arguments:a[n-1],loc:this._$};break;case 18:this.$={type:"LOGICAL_EXPRESSION",left:a[n-2],right:a[n],operator:a[n-1],loc:this._$};break;case 19:case 20:this.$={type:"ASSIGNMENT_EXPRESSION",left:a[n-2],operator:a[n-1],right:a[n],loc:this._$};break;case 21:this.$=Number(a[n]);break;case 22:this.$=Number(a[n-1]);break;case 23:this.$=Number(a[n-2]+a[n-1]+a[n]);break;case 24:this.$=Number("0"+a[n-1]+a[n]);break;case 25:this.$=0;break;case 26:this.$={type:"NUMBER_LITERAL",value:a[n],loc:this._$};break;case 27:case 28:case 29:this.$={type:"UNARY_EXPRESSION",value:a[n],operator:a[n-1],loc:this._$};break;case 30:case 31:case 32:case 33:case 34:case 35:case 36:case 37:case 38:this.$={type:"BINARY_EXPRESSION",left:a[n-2],right:a[n],operator:a[n-1],loc:this._$};break;case 41:case 47:this.$=a[n-1]}},table:[{3:1,4:2,5:[1,4],6:3,9:13,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{1:[3]},{5:[1,21],7:32,8:h,20:l,28:A,29:c,32:g,33:m,34:u,35:d,36:f,37:p,38:b},{5:[1,34]},{1:[2,3]},t(_,[2,39]),t(_,[2,40]),{4:35,6:37,9:13,10:36,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},t(_,[2,42]),t(_,[2,43]),t(_,[2,44],{22:[1,38]}),t(_,[2,45],{17:[1,40],22:[1,39]}),t(_,[2,46]),t(v,[2,8],{31:5,27:6,26:8,21:9,16:10,11:11,19:12,23:17,4:41,12:e,17:s,24:i,25:r,28:a,29:o,30:n}),{4:42,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:43,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:44,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},t(_,[2,26]),t([5,8,15,17,18,20,22,28,29,32,33,34,35,36,37,38],[2,11]),t(_,[2,21],{25:[1,45]}),t(_,[2,25],{24:[1,46]}),{1:[2,1]},{4:47,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:48,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:49,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:50,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:51,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:52,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:53,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:54,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:55,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:56,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},t(E,[2,6],{8:x}),t(w,[2,4]),{1:[2,2]},{7:32,8:h,18:[1,58],20:l,28:A,29:c,32:g,33:m,34:u,35:d,36:f,37:p,38:b},{18:[1,59]},t(y,[2,10]),{4:60,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:61,11:11,12:e,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},{4:65,6:37,9:13,10:66,11:11,12:e,13:64,14:63,16:10,17:s,18:[1,62],19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},t(v,[2,9],{7:67,8:h,20:l,28:A,29:c,32:g,33:m,34:u,35:d,36:f,37:p,38:b}),t(S,[2,27],{20:l,32:g,33:m,34:u,35:d,36:f,37:p}),t(S,[2,28],{20:l,32:g,33:m,34:u,35:d,36:f,37:p}),t(S,[2,29],{20:l,32:g,33:m,34:u,35:d,36:f,37:p}),t(_,[2,22],{24:[1,68]}),t(_,[2,24]),t(S,[2,30],{20:l,32:g,33:m,34:u,35:d,36:f,37:p}),t(S,[2,31],{20:l,32:g,33:m,34:u,35:d,36:f,37:p}),t(P,[2,32],{20:l,34:u,35:d,36:f,37:p}),t(P,[2,33],{20:l,34:u,35:d,36:f,37:p}),t(T,[2,34],{20:l,35:d,36:f}),t(I,[2,35],{20:l}),t(I,[2,36],{20:l}),t(T,[2,37],{20:l,35:d,36:f}),t(R,[2,38],{20:l,28:A,29:c,32:g,33:m,34:u,35:d,36:f,37:p,38:b}),t(_,[2,18]),t(w,[2,5]),t(_,[2,41]),t(_,[2,47]),t(R,[2,20],{20:l,28:A,29:c,32:g,33:m,34:u,35:d,36:f,37:p,38:b}),t(R,[2,19],{20:l,28:A,29:c,32:g,33:m,34:u,35:d,36:f,37:p,38:b}),t(B,[2,16]),{15:[1,70],18:[1,69]},t(y,[2,14]),t(y,[2,12],{7:32,8:h,20:l,28:A,29:c,32:g,33:m,34:u,35:d,36:f,37:p,38:b}),t(y,[2,13]),t(E,[2,7],{8:x}),t(_,[2,23]),t(B,[2,17]),{4:65,6:37,9:13,10:66,11:11,12:e,13:71,16:10,17:s,19:12,21:9,23:17,24:i,25:r,26:8,27:6,28:a,29:o,30:n,31:5},t(y,[2,15])],defaultActions:{4:[2,3],21:[2,1],34:[2,2]},parseError:function(t,e){if(!e.recoverable){var s=new Error(t);throw s.hash=e,s}this.trace(t)},parse:function(t){var e=this,s=[0],i=[null],r=[],a=this.table,o="",n=0,h=0,l=r.slice.call(arguments,1),A=Object.create(this.lexer),c={yy:{}};for(var g in this.yy)Object.prototype.hasOwnProperty.call(this.yy,g)&&(c.yy[g]=this.yy[g]);A.setInput(t,c.yy),c.yy.lexer=A,c.yy.parser=this,void 0===A.yylloc&&(A.yylloc={});var m=A.yylloc;r.push(m);var u=A.options&&A.options.ranges;"function"==typeof c.yy.parseError?this.parseError=c.yy.parseError:this.parseError=Object.getPrototypeOf(this).parseError;for(var d,f,p,b,_,v,E,x,w=function(){var t;return"number"!=typeof(t=A.lex()||1)&&(t=e.symbols_[t]||t),t},y={};;){if(f=s[s.length-1],this.defaultActions[f]?p=this.defaultActions[f]:(null==d&&(d=w()),p=a[f]&&a[f][d]),void 0===p||!p.length||!p[0]){var S;for(_ in x=[],a[f])this.terminals_[_]&&_>2&&x.push("'"+this.terminals_[_]+"'");S=A.showPosition?"Parse error on line "+(n+1)+":\n"+A.showPosition()+"\nExpecting "+x.join(", ")+", got '"+(this.terminals_[d]||d)+"'":"Parse error on line "+(n+1)+": Unexpected "+(1==d?"end of input":"'"+(this.terminals_[d]||d)+"'"),this.parseError(S,{text:A.match,token:this.terminals_[d]||d,line:A.yylineno,loc:m,expected:x})}if(p[0]instanceof Array&&p.length>1)throw new Error("Parse Error: multiple actions possible at state: "+f+", token: "+d);switch(p[0]){case 1:s.push(d),i.push(A.yytext),r.push(A.yylloc),s.push(p[1]),d=null,h=A.yyleng,o=A.yytext,n=A.yylineno,m=A.yylloc;break;case 2:if(v=this.productions_[p[1]][1],y.$=i[i.length-v],y._$={first_line:r[r.length-(v||1)].first_line,last_line:r[r.length-1].last_line,first_column:r[r.length-(v||1)].first_column,last_column:r[r.length-1].last_column},u&&(y._$.range=[r[r.length-(v||1)].range[0],r[r.length-1].range[1]]),void 0!==(b=this.performAction.apply(y,[o,h,n,c.yy,p[1],i,r].concat(l))))return b;v&&(s=s.slice(0,-1*v*2),i=i.slice(0,-1*v),r=r.slice(0,-1*v)),s.push(this.productions_[p[1]][0]),i.push(y.$),r.push(y._$),E=a[s[s.length-2]][s[s.length-1]],s.push(E);break;case 3:return!0}}return!0}},L={EOF:1,parseError:function(t,e){if(!this.yy.parser)throw new Error(t);this.yy.parser.parseError(t,e)},setInput:function(t,e){return this.yy=e||this.yy||{},this._input=t,this._more=this._backtrack=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var t=this._input[0];return this.yytext+=t,this.yyleng++,this.offset++,this.match+=t,this.matched+=t,t.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),t},unput:function(t){var e=t.length,s=t.split(/(?:\r\n?|\n)/g);this._input=t+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-e),this.offset-=e;var i=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),s.length-1&&(this.yylineno-=s.length-1);var r=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:s?(s.length===i.length?this.yylloc.first_column:0)+i[i.length-s.length].length-s[0].length:this.yylloc.first_column-e},this.options.ranges&&(this.yylloc.range=[r[0],r[0]+this.yyleng-e]),this.yyleng=this.yytext.length,this},more:function(){return this._more=!0,this},reject:function(){return this.options.backtrack_lexer?(this._backtrack=!0,this):this.parseError("Lexical error on line "+(this.yylineno+1)+". You can only invoke reject() in the lexer when the lexer is of the backtracking persuasion (options.backtrack_lexer = true).\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},less:function(t){this.unput(this.match.slice(t))},pastInput:function(){var t=this.matched.substr(0,this.matched.length-this.match.length);return(t.length>20?"...":"")+t.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var t=this.match;return t.length<20&&(t+=this._input.substr(0,20-t.length)),(t.substr(0,20)+(t.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var t=this.pastInput(),e=new Array(t.length+1).join("-");return t+this.upcomingInput()+"\n"+e+"^"},test_match:function(t,e){var s,i,r;if(this.options.backtrack_lexer&&(r={yylineno:this.yylineno,yylloc:{first_line:this.yylloc.first_line,last_line:this.last_line,first_column:this.yylloc.first_column,last_column:this.yylloc.last_column},yytext:this.yytext,match:this.match,matches:this.matches,matched:this.matched,yyleng:this.yyleng,offset:this.offset,_more:this._more,_input:this._input,yy:this.yy,conditionStack:this.conditionStack.slice(0),done:this.done},this.options.ranges&&(r.yylloc.range=this.yylloc.range.slice(0))),(i=t[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=i.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:i?i[i.length-1].length-i[i.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._backtrack=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],s=this.performAction.call(this,this.yy,this,e,this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),s)return s;if(this._backtrack){for(var a in r)this[a]=r[a];return!1}return!1},next:function(){if(this.done)return this.EOF;var t,e,s,i;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var r=this._currentRules(),a=0;a<r.length;a++)if((s=this._input.match(this.rules[r[a]]))&&(!e||s[0].length>e[0].length)){if(e=s,i=a,this.options.backtrack_lexer){if(!1!==(t=this.test_match(s,r[a])))return t;if(this._backtrack){e=!1;continue}return!1}if(!this.options.flex)break}return e?!1!==(t=this.test_match(e,r[i]))&&t:""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){return this.next()||this.lex()},begin:function(t){this.conditionStack.push(t)},popState:function(){return this.conditionStack.length-1>0?this.conditionStack.pop():this.conditionStack[0]},_currentRules:function(){return this.conditionStack.length&&this.conditionStack[this.conditionStack.length-1]?this.conditions[this.conditionStack[this.conditionStack.length-1]].rules:this.conditions.INITIAL.rules},topState:function(t){return(t=this.conditionStack.length-1-Math.abs(t||0))>=0?this.conditionStack[t]:"INITIAL"},pushState:function(t){this.begin(t)},stateStackSize:function(){return this.conditionStack.length},options:{},performAction:function(t,e,s,i){switch(s){case 0:break;case 1:return 24;case 2:return 38;case 3:return 22;case 4:return 20;case 5:return 12;case 6:return 5;case 7:return e.yytext[0]}},rules:[/^(?:\s+)/,/^(?:[0-9]+)/,/^(?:(==|!=|<=|>=|<|>))/,/^(?:[+\-*/%]?=)/,/^(?:(\&\&)|\|\|)/,/^(?:[a-zA-Z_][a-zA-Z0-9._]*)/,/^(?:$)/,/^(?:.)/],conditions:{INITIAL:{rules:[0,1,2,3,4,5,6,7],inclusive:!0}}};function F(){this.yy={}}return C.lexer=L,F.prototype=C,C.Parser=F,new F}();const r={ASSIGNMENT_EXPRESSION:[{type:"NODE",key:"right"}],SCRIPT:[{type:"ARRAY",key:"body"}],EXPRESSION_BLOCK:[{type:"ARRAY",key:"body"}],UNARY_EXPRESSION:[{type:"NODE",key:"value"}],NUMBER_LITERAL:[],IDENTIFIER:[],CALL_EXPRESSION:[{type:"ARRAY",key:"arguments"},{type:"NODE",key:"callee"}],BINARY_EXPRESSION:[{type:"NODE",key:"left"},{type:"NODE",key:"right"}],LOGICAL_EXPRESSION:[{type:"NODE",key:"left"},{type:"NODE",key:"right"}]};function a(t,e){const s=r[t.type];let i=t;if(null==s)throw new Error(`Unknown children definition for ${t.type}`);return s.forEach(s=>{if("NODE"===s.type){const r=t[s.key],o=a(r,e);o!==r&&(i={...i,[s.key]:o})}else if("ARRAY"===s.type){const r=t[s.key],o=r.map(t=>a(t,e)),n=r.some((t,e)=>t!==o[e]);n&&(i={...i,[s.key]:o})}}),e(i)}function o(t){return[].concat.apply([],t)}function n(t,e){return new Array(t).fill(e).join("")}class h{constructor(){this._map=new Map}get(t,e){const s=null==t?e:`${t}::${e}`;return this._map.has(s)||this._map.set(s,this._map.size),this._map.get(s)}size(){return this._map.size}}class l extends Error{constructor(t,e,s){super(t),this.sourceContext=function(t,e,s=1){const i=Math.max(t.first_line-1-s,0),r=t.last_line+s,a=e.split("\n").slice(i,r).map((e,s)=>{const r=s+i+1;return`${r>=t.first_line&&r<=t.last_line?">":" "} ${r} | ${e}`});if(t.first_line===t.last_line){const e=n(t.first_column," "),s=n(t.last_column-t.first_column,"^"),r=t.first_line-i;a.splice(r,0,`    | ${e}${s}`)}return a.join("\n")}(e,s),this.loc=e}}class A extends l{}function c(t,e,s){return new A(t,e,s)}function g(t,e,s){return new l(t,e,s)}function m(t,e){const i=s(e,t.first_column),r=s(e,t.last_column);return{first_column:i.column,last_column:r.column,first_line:i.line,last_line:r.line}}function u(t){const[e,s]=function(t){const e=[];let s=1,i="",r=0,a=!1,o=!1,n=!1;for(let h=0;h<t.length;h++){const l=t[h];if(n){const t=i.length+1,a=h-r+1;e.push({destCol:t,srcCol:a,srcLine:s}),n=!1}"\n"===l?(a=!1,s++,r=h+1,n=!0):"\r"===l&&"\n"===t[h+1]?(h++,a=!1,s++,r=h+1,n=!0):o&&"*"===l&&"/"===t[h+1]?(o=!1,h++,n=!0):"\\"===l&&"\\"===t[h+1]||"/"===l&&"/"===t[h+1]?(a=!0,h++):"/"===l&&"*"===t[h+1]?(o=!0,h++):a||o||(i+=l)}return[i,e]}(t);try{const r=function(){return i.parse.apply(i,arguments)}(e);return a(r,e=>{if(1!==e.loc.first_line||1!=e.loc.last_line)throw g("Unexpected multiline",e.loc,t);return Object.assign(Object.assign({},e),{loc:m(e.loc,s)})})}catch(e){if(null==e.hash)throw e;throw c(`Parse Error: ${e.message.split("\n")[3]}`,m(e.hash.loc,s),t)}}const d=[0,97,115,109],f=[1,0,0,0],p=1e-5,b=t=>[2,t],_=t=>[3,t],v=t=>[4,t],E=11,x=t=>[13,...W(t)],w=t=>[16,...W(t)],y=t=>[32,...W(t)],S=t=>[33,...W(t)],P=t=>[34,...W(t)],T=t=>[35,...W(t)],I=t=>[36,...W(t)],R=(t,e)=>[43,...W(t),...W(e)],B=(t,e)=>[57,...W(t),...W(e)],C=t=>[65,...Y(t)],L=t=>[68,...G(t)],F=71,M=153,U=161,Q=170,k=176,D=183,V=127,q=124,z=124,N=[M,...L(p),99],X=[M,...L(p),100];function G(t){const e=new Uint8Array(8);return function(t,e){const s=new ArrayBuffer(8);new DataView(s).setFloat64(0,e);const i=new Uint8Array(s).reverse();t.set(i,0)}(e,t),e}const O=t=>[t.length].concat(t.split("").map(t=>t.charCodeAt(0)));function W(t){const e=[];do{let s=127&t;0!=(t>>>=7)&&(s|=128),e.push(s)}while(0!==t);return e}function Y(t){let e=[],s=0,i=Math.ceil(Math.log2(Math.abs(t))),r=t<0,a=!0;for(;a;)s=127&t,t>>=7,r&&(t|=-(1<<i-7)),(0!=t||64&s)&&(-1!=t||64&~s)?s|=128:a=!1,e.push(s);return e}const H=t=>W(t.length).concat(t),J=t=>W(t.length).concat(o(t));function j(t,e){if(0===e.length)return[];const s=H(J(e));return s.unshift(t),s}const K={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,atan2:Math.atan2,rand:t=>Math.random()*t,pow:Math.pow,log:Math.log,log10:Math.log10,exp:Math.exp,sigmoid:function(t,e){const s=1+Math.exp(-t*e);return Math.abs(s)>1e-5?1/s:0}},Z=Math.ceil(2048),$={sqr:{args:[q],returns:[q],binary:[...y(0),...y(0),162]},bor:{args:[q,q],returns:[q],binary:[...y(0),...X,...y(1),...X,114,...C(0),F,D]},band:{args:[q,q],returns:[q],binary:[...y(0),...X,...y(1),...X,113,...C(0),F,D]},sign:{args:[q],returns:[q],binary:[...L(0),...y(0),99,...y(0),...L(0),99,107,D]},mod:{args:[q,q],returns:[q],localVariables:[V],binary:[...y(1),Q,...P(2),...C(0),F,...v(z),...y(0),Q,...y(2),111,D,5,...L(0),E]},bitwiseOr:{args:[q,q],returns:[q],binary:[...y(0),k,...y(1),k,132,185]},bitwiseAnd:{args:[q,q],returns:[q],binary:[...y(0),k,...y(1),k,131,185]},div:{args:[q,q],returns:[q],localVariables:[V],binary:[...y(1),...L(0),98,...v(z),...y(0),...y(1),163,5,...L(0),E]},_getBufferIndex:{args:[q],returns:[V],localVariables:[q,V],binary:[...L(p),...y(0),160,...P(1),Q,...S(2),...C(-1),...y(2),...C(8),108,...y(2),...C(0),72,...y(2),...C(8388607),74,114,27]}};function tt(t,e){var s,i,r;switch(t.type){case"SCRIPT":return o(t.body.map((t,s)=>[...tt(t,e),26]));case"EXPRESSION_BLOCK":return et(t.body,e);case"BINARY_EXPRESSION":{const s=tt(t.left,e),i=tt(t.right,e),r={"+":[160],"-":[U],"*":[162],"/":e.resolveFunc("div"),"%":e.resolveFunc("mod"),"|":e.resolveFunc("bitwiseOr"),"&":e.resolveFunc("bitwiseAnd"),"^":e.resolveFunc("pow"),"==":[U,...N,D],"!=":[U,...X,D],"<":[99,D],">":[100,D],"<=":[101,D],">=":[102,D]}[t.operator];if(null==r)throw g(`Unknown binary expression operator ${t.operator}`,t.loc,e.rawSource);return[...s,...i,...r]}case"CALL_EXPRESSION":{const i=t.callee.value,r=t.arguments,a=s=>{if(r.length<s)throw c(`Too few arguments passed to \`${i}()\`. Expected ${s} but only got ${r.length}.`,t.loc,e.rawSource);if(r.length>s)throw c(`Too many arguments passed to \`${i}()\`. Expected ${s} but got ${r.length}.`,r[s].loc,e.rawSource)};switch(i){case"exec2":return a(2),et(t.arguments,e);case"exec3":return a(3),et(t.arguments,e);case"if":a(3);const[r,o,n]=t.arguments;return function(t,e,s,i){return[...tt(t,i),...X,...v(z),...tt(e,i),5,...tt(s,i),E]}(r,o,n,e);case"while":return a(1),function(t,e){const s=tt(t,e),i=e.resolveLocal(V);return[...C(0),...S(i),..._(64),...y(i),...C(1),106,...P(i),...C(1048576),73,...s,...X,113,...x(0),E,...L(0)]}(t.arguments[0],e);case"loop":return a(2),function(t,e,s){const i=tt(e,s),r=s.resolveLocal(V);return[...b(64),...tt(t,s),Q,...P(r),...C(0),76,...x(1),..._(64),...i,26,...y(r),...C(1),107,...P(r),...C(0),F,...x(0),E,E,...L(0)]}(t.arguments[0],t.arguments[1],e);case"megabuf":case"gmegabuf":a(1);const h=e.resolveLocal(V);return[...tt(t.arguments[0],e),...null!==(s=e.resolveFunc("_getBufferIndex"))&&void 0!==s?s:[],...P(h),...C(-1),F,...v(z),...y(h),...R(3,st(i)),5,...L(0),E];case"assign":a(2);const l=t.arguments[0];if("IDENTIFIER"!=l.type)throw c("Expected the first argument of `assign()` to be an identifier.",l.loc,e.rawSource);const A=e.resolveVar(l.value);return[...tt(t.arguments[1],e),...I(A),...T(A)]}const n=o(t.arguments.map(t=>tt(t,e)));switch(i){case"abs":return a(1),[...n,M];case"sqrt":return a(1),[...n,M,159];case"int":case"floor":return a(1),[...n,156];case"min":return a(2),[...n,164];case"max":return a(2),[...n,165];case"above":return a(2),[...n,100,D];case"below":return a(2),[...n,99,D];case"equal":return a(2),[...n,U,...N,D];case"bnot":return a(1),[...n,...N,D];case"ceil":return a(1),[...n,155]}const h=e.resolveFunc(i);if(null==h||i.startsWith("_"))throw c(`"${i}" is not defined.`,t.callee.loc,e.rawSource);if(null!=K[i])a(K[i].length);else{if(null==$[i])throw g(`Missing arity information for the function \`${i}()\``,t.callee.loc,e.rawSource);a($[i].args.length)}return[...n,...h]}case"ASSIGNMENT_EXPRESSION":{const{left:s}=t,a=tt(t.right,e),o=function(t,e){const s={"+=":[160],"-=":[U],"*=":[162],"/=":[163],"%=":e.resolveFunc("mod"),"=":null}[t.operator];if(void 0===s)throw g(`Unknown assignment operator "${t.operator}"`,t.loc,e.rawSource);return s}(t,e);if("IDENTIFIER"===s.type){const t=e.resolveVar(s.value),i=T(t),r=I(t);return null===o?[...a,...r,...i]:[...i,...a,...o,...r,...i]}if("CALL_EXPRESSION"!==s.type)throw g(`Unexpected left hand side type for assignment: ${s.type}`,t.loc,e.rawSource);const n=e.resolveLocal(V);if(1!==s.arguments.length)throw c(`Expected 1 argument when assigning to a buffer but got ${s.arguments.length}.`,0===s.arguments.length?s.loc:s.arguments[1].loc,e.rawSource);const h=s.callee.value;if("gmegabuf"!==h&&"megabuf"!==h)throw c("The only function calls which may be assigned to are `gmegabuf()` and `megabuf()`.",s.callee.loc,e.rawSource);const l=st(h);if(null===o){const t=e.resolveLocal(V),r=e.resolveLocal(q);return[...a,...S(r),...tt(s.arguments[0],e),...null!==(i=e.resolveFunc("_getBufferIndex"))&&void 0!==i?i:[],...P(t),...C(0),72,...v(z),...L(0),5,...y(t),...P(n),...y(r),...B(3,l),...y(r),E]}const A=e.resolveLocal(V),m=e.resolveLocal(V),u=e.resolveLocal(q),d=e.resolveLocal(q);return[...a,...S(u),...tt(s.arguments[0],e),...null!==(r=e.resolveFunc("_getBufferIndex"))&&void 0!==r?r:[],...P(A),...C(-1),F,...P(m),...v(z),...y(A),...R(3,l),5,...L(0),E,...y(u),...o,...P(d),...y(m),...v(64),...y(A),...y(d),...B(3,l),E]}case"LOGICAL_EXPRESSION":{const s=tt(t.left,e),i=tt(t.right,e),r={"&&":{comparison:N,shortCircuitValue:0},"||":{comparison:X,shortCircuitValue:1}}[t.operator];if(null==r)throw g(`Unknown logical expression operator ${t.operator}`,t.loc,e.rawSource);const{comparison:a,shortCircuitValue:o}=r;return[...s,...a,...v(z),...L(o),5,...i,...X,D,E]}case"UNARY_EXPRESSION":{const s=tt(t.value,e),i={"-":[154],"+":[],"!":[...N,D]}[t.operator];if(null==i)throw g(`Unknown logical unary operator ${t.operator}`,t.loc,e.rawSource);return[...s,...i]}case"IDENTIFIER":const a=t.value;return T(e.resolveVar(a));case"NUMBER_LITERAL":return L(t.value);default:throw g(`Unknown AST node type ${t.type}`,t.loc,e.rawSource)}}function et(t,e){return o(function(t,e){const s=[];for(let i=0;i<t.length;i++)s.push(t[i]),i===t.length-1||s.push(e);return s}(t.map((t,s)=>tt(t,e)),[26]))}function st(t){switch(t){case"gmegabuf":return 67108864;case"megabuf":return 0}}function it({pools:t,functions:e,eelVersion:s=2,preParsed:i=!1}){if(Object.keys(t).includes("shims"))throw new Error('You may not name a pool "shims". "shims" is reserved for injected JavaScript functions.');const r=[];Object.entries(t).forEach(([t,e])=>{e.forEach(e=>{r.push([t,e])})});const a=new h;r.forEach(([t,e])=>{a.get(t,e)});const o=Object.entries(K).map(([t,e])=>({args:new Array(e.length).fill(null).map(t=>q),returns:[q],name:t})),n=[],l=[];Object.entries(e).forEach(([e,{pool:r,code:h}])=>{if(null==t[r]){const s=Object.keys(t);if(0===s.length)throw new Error(`The function "${e}" was declared as using a variable pool named "${r}" but no pools were defined.`);throw new Error(`The function "${e}" was declared as using a variable pool named "${r}" which is not among the variable pools defined. The defined variable pools are: ${function(t){if(0===t.length)throw new Error("Cannot format an empty list");if(1===t.length)return t[0];const e=t.map(t=>`"${t}"`),s=e.pop();return e.join(", ")+` and ${s}`}(s)}.`)}const A=i?h:u(h);if("string"==typeof A)throw new Error("Got passed unparsed code without setting the preParsed flag");if("SCRIPT"!==A.type)throw new Error("Invalid AST");if(0===A.body.length)return;const c=[],g={resolveVar:t=>/^reg\d\d$/.test(t)?a.get(null,t):a.get(r,t),resolveLocal:t=>(c.push(t),c.length-1),resolveFunc:t=>{const e=o.findIndex(e=>e.name===t);if(-1!==e){const i=w(e);return"rand"===t&&1===s?[...i,156]:i}if(null==$[t])return null;let i=n.indexOf(t);return-1===i&&(n.push(t),i=n.length-1),w(i+o.length)},rawSource:h},m=tt(A,g);l.push({binary:m,exportName:e,args:[],returns:[],localVariables:c})});const A=n.map(t=>{const e=$[t];if(null==e)throw new Error(`Undefined local function "${t}"`);return e}),c=t=>[...t.args,"|",...t.returns].join("-"),g=[],m=new Map;function p(t){const e=c(t),s=m.get(e);if(null==s)throw new Error(`Failed to get a type index for key ${e}`);return s}[...o,...A,...l].forEach(t=>{const e=c(t);m.has(e)||(g.push([96,...H(t.args),...H(t.returns)]),m.set(e,g.length-1))});const b=[...r.map(([t,e])=>[...O(t),...O(e),3,q,1]),...o.map((t,e)=>{const s=p(t);return[...O("shims"),...O(t.name),0,...W(s)]})],_=[...A,...l].map(t=>W(p(t))),v=[[1,...W(Z),...W(Z)]],x=a.size()-r.length,y=(S=()=>[q,1,...L(0),E],new Array(x).fill(null).map((t,e)=>S()));var S;const P=[...l].map((t,e)=>{const s=e+o.length+A.length;return[...O(t.exportName),0,...W(s)]}),T=[...A,...l].map(t=>{var e;const s=(null!==(e=t.localVariables)&&void 0!==e?e:[]).map(t=>[...W(1),t]);return H([...J(s),...t.binary,E])});return new Uint8Array([...d,...f,...j(1,g),...j(2,b),...j(3,_),...j(5,v),...j(6,y),...j(7,P),...j(10,T)])}const rt="undefined"!=typeof BigUint64Array,at=Symbol(),ot=new TextDecoder("utf-16le");function nt(t,e){const s=new Uint32Array(t)[e+-4>>>2]>>>1,i=new Uint16Array(t,e,s);return s<=32?String.fromCharCode.apply(String,i):ot.decode(i)}function ht(t){const e={};function s(t,e){return t?nt(t.buffer,e):"<yet unknown>"}const i=t.env=t.env||{};return i.abort=i.abort||function(t,r,a,o){const n=e.memory||i.memory;throw Error(`abort: ${s(n,t)} at ${s(n,r)}:${a}:${o}`)},i.trace=i.trace||function(t,r,...a){const o=e.memory||i.memory;console.log(`trace: ${s(o,t)}${r?" ":""}${a.slice(0,r).join(", ")}`)},i.seed=i.seed||Date.now,t.Math=t.Math||Math,t.Date=t.Date||Date,e}function lt(t,e){const s=e.exports,i=s.memory,r=s.table,a=s.__new,o=s.__retain,n=s.__rtti_base||-1;function h(t){const e=function(t){const e=new Uint32Array(i.buffer);if((t>>>=0)>=e[n>>>2])throw Error(`invalid id: ${t}`);return e[(n+4>>>2)+2*t]}(t);if(!(7&e))throw Error(`not an array: ${t}, flags=${e}`);return e}function l(t){const e=new Uint32Array(i.buffer);if((t>>>=0)>=e[n>>>2])throw Error(`invalid id: ${t}`);return e[(n+4>>>2)+2*t+1]}function A(t){return 31-Math.clz32(t>>>6&31)}function c(t,e,s){const r=i.buffer;if(s)switch(t){case 2:return new Float32Array(r);case 3:return new Float64Array(r)}else switch(t){case 0:return new(e?Int8Array:Uint8Array)(r);case 1:return new(e?Int16Array:Uint16Array)(r);case 2:return new(e?Int32Array:Uint32Array)(r);case 3:return new(e?BigInt64Array:BigUint64Array)(r)}throw Error(`unsupported align: ${t}`)}function g(t){const e=new Uint32Array(i.buffer),s=h(e[t+-8>>>2]),r=A(s);let a=4&s?t:e[t+4>>>2];const o=2&s?e[t+12>>>2]:e[a+-4>>>2]>>>r;return c(r,2048&s,4096&s).subarray(a>>>=r,a+o)}function m(t,e,s){return new t(u(t,e,s))}function u(t,e,s){const r=i.buffer,a=new Uint32Array(r),o=a[s+4>>>2];return new t(r,o,a[o+-4>>>2]>>>e)}function d(e,s,i){t[`__get${s}`]=m.bind(null,e,i),t[`__get${s}View`]=u.bind(null,e,i)}return t.__newString=function(t){if(null==t)return 0;const e=t.length,s=a(e<<1,1),r=new Uint16Array(i.buffer);for(var o=0,n=s>>>1;o<e;++o)r[n+o]=t.charCodeAt(o);return s},t.__getString=function(t){if(!t)return null;const e=i.buffer;if(1!==new Uint32Array(e)[t+-8>>>2])throw Error(`not a string: ${t}`);return nt(e,t)},t.__newArray=function(t,e){const s=h(t),r=A(s),n=e.length,l=a(n<<r,4&s?t:0);let g;if(4&s)g=l;else{const e=a(2&s?16:12,t),h=new Uint32Array(i.buffer);h[e+0>>>2]=o(l),h[e+4>>>2]=l,h[e+8>>>2]=n<<r,2&s&&(h[e+12>>>2]=n),g=e}const m=c(r,2048&s,4096&s);if(16384&s)for(let t=0;t<n;++t)m[(l>>>r)+t]=o(e[t]);else m.set(e,l>>>r);return g},t.__getArrayView=g,t.__getArray=function(t){const e=g(t),s=e.length,i=new Array(s);for(let t=0;t<s;t++)i[t]=e[t];return i},t.__getArrayBuffer=function(t){const e=i.buffer,s=new Uint32Array(e)[t+-4>>>2];return e.slice(t,t+s)},[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array].forEach(t=>{d(t,t.name,31-Math.clz32(t.BYTES_PER_ELEMENT))}),rt&&[BigUint64Array,BigInt64Array].forEach(t=>{d(t,t.name.slice(3),3)}),t.__instanceof=function(t,e){const s=new Uint32Array(i.buffer);let r=s[t+-8>>>2];if(r<=s[n>>>2])do{if(r==e)return!0;r=l(r)}while(r);return!1},t.memory=t.memory||i,t.table=t.table||r,ut(s,t)}function At(t){return"undefined"!=typeof Response&&t instanceof Response}function ct(t){return t instanceof WebAssembly.Module}async function gt(t,e={}){if(At(t=await t))return mt(t,e);const s=ct(t)?t:await WebAssembly.compile(t),i=ht(e),r=await WebAssembly.instantiate(s,e);return{module:s,instance:r,exports:lt(i,r)}}async function mt(t,e={}){if(!WebAssembly.instantiateStreaming)return gt(At(t=await t)?t.arrayBuffer():t,e);const s=ht(e),i=await WebAssembly.instantiateStreaming(t,e),r=lt(s,i.instance);return{...i,exports:r}}function ut(t,e={}){const s=t.__argumentsLength?e=>{t.__argumentsLength.value=e}:t.__setArgumentsLength||t.__setargc||(()=>{});for(let i in t){if(!Object.prototype.hasOwnProperty.call(t,i))continue;const r=t[i];let a=i.split("."),o=e;for(;a.length>1;){let t=a.shift();Object.prototype.hasOwnProperty.call(o,t)||(o[t]={}),o=o[t]}let n=a[0],h=n.indexOf("#");if(h>=0){const e=n.substring(0,h),a=o[e];if(void 0===a||!a.prototype){const t=function(...e){return t.wrap(t.prototype.constructor(0,...e))};t.prototype={valueOf(){return this[at]}},t.wrap=function(e){return Object.create(t.prototype,{[at]:{value:e,writable:!1}})},a&&Object.getOwnPropertyNames(a).forEach(e=>Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))),o[e]=t}if(n=n.substring(h+1),o=o[e].prototype,/^(get|set):/.test(n)){if(!Object.prototype.hasOwnProperty.call(o,n=n.substring(4))){let e=t[i.replace("set:","get:")],s=t[i.replace("get:","set:")];Object.defineProperty(o,n,{get(){return e(this[at])},set(t){s(this[at],t)},enumerable:!0})}}else"constructor"===n?(o[n]=(...t)=>(s(t.length),r(...t))).original=r:(o[n]=function(...t){return s(t.length),r(this[at],...t)}).original=r}else/^(get|set):/.test(n)?Object.prototype.hasOwnProperty.call(o,n=n.substring(4))||Object.defineProperty(o,n,{get:t[i.replace("set:","get:")],set:t[i.replace("get:","set:")],enumerable:!0}):"function"==typeof r&&r!==s?(o[n]=(...t)=>(s(t.length),r(...t))).original=r:o[n]=r}return e}var dt={instantiate:gt,instantiateSync:function(t,e={}){const s=ct(t)?t:new WebAssembly.Module(t),i=ht(e),r=new WebAssembly.Instance(s,e);return{module:s,instance:r,exports:lt(i,r)}},instantiateStreaming:mt,demangle:ut};class ft{constructor(t,e,s=!1){this.samplesIn=t,this.samplesOut=e,this.equalize=s,this.NFREQ=2*e,this.equalize&&this.initEqualizeTable(),this.initBitRevTable(),this.initCosSinTable()}initEqualizeTable(){this.equalizeArr=new Float32Array(this.samplesOut);const t=1/this.samplesOut;for(let e=0;e<this.samplesOut;e++)this.equalizeArr[e]=-.02*Math.log((this.samplesOut-e)*t)}initBitRevTable(){this.bitrevtable=new Uint16Array(this.NFREQ);for(let t=0;t<this.NFREQ;t++)this.bitrevtable[t]=t;let t=0;for(let e=0;e<this.NFREQ;e++){if(t>e){const s=this.bitrevtable[e];this.bitrevtable[e]=this.bitrevtable[t],this.bitrevtable[t]=s}let s=this.NFREQ>>1;for(;s>=1&&t>=s;)t-=s,s>>=1;t+=s}}initCosSinTable(){let t=2,e=0;for(;t<=this.NFREQ;)e+=1,t<<=1;this.cossintable=[new Float32Array(e),new Float32Array(e)],t=2;let s=0;for(;t<=this.NFREQ;){const e=-2*Math.PI/t;this.cossintable[0][s]=Math.cos(e),this.cossintable[1][s]=Math.sin(e),s+=1,t<<=1}}timeToFrequencyDomain(t){const e=new Float32Array(this.NFREQ),s=new Float32Array(this.NFREQ);for(let i=0;i<this.NFREQ;i++){const r=this.bitrevtable[i];r<this.samplesIn?e[i]=t[r]:e[i]=0,s[i]=0}let i=2,r=0;for(;i<=this.NFREQ;){const t=this.cossintable[0][r],a=this.cossintable[1][r];let o=1,n=0;const h=i>>1;for(let r=0;r<h;r++){for(let t=r;t<this.NFREQ;t+=i){const i=t+h,r=o*e[i]-n*s[i],a=o*s[i]+n*e[i];e[i]=e[t]-r,s[i]=s[t]-a,e[t]+=r,s[t]+=a}const l=o;o=l*t-n*a,n=n*t+l*a}i<<=1,r+=1}const a=new Float32Array(this.samplesOut);if(this.equalize)for(let t=0;t<this.samplesOut;t++)a[t]=this.equalizeArr[t]*Math.sqrt(e[t]*e[t]+s[t]*s[t]);else for(let t=0;t<this.samplesOut;t++)a[t]=Math.sqrt(e[t]*e[t]+s[t]*s[t]);return a}}class pt{constructor(t){this.numSamps=2048,this.fftSize=2*this.numSamps,this.smoothingFactor=.8,this.prevTimeArray=null,this.fft=new ft(this.fftSize,512,!0),t&&(this.audioContext=t,this.audible=t.createDelay(),this.analyser=t.createAnalyser(),this.analyser.smoothingTimeConstant=0,this.analyser.fftSize=this.fftSize,this.audible.connect(this.analyser),this.analyserL=t.createAnalyser(),this.analyserL.smoothingTimeConstant=0,this.analyserL.fftSize=this.fftSize,this.analyserR=t.createAnalyser(),this.analyserR.smoothingTimeConstant=0,this.analyserR.fftSize=this.fftSize,this.splitter=t.createChannelSplitter(2),this.audible.connect(this.splitter),this.splitter.connect(this.analyserL,0),this.splitter.connect(this.analyserR,1)),this.timeByteArray=new Uint8Array(this.fftSize),this.timeByteArrayL=new Uint8Array(this.fftSize),this.timeByteArrayR=new Uint8Array(this.fftSize),this.timeArray=new Int8Array(this.fftSize),this.timeByteArraySignedL=new Int8Array(this.fftSize),this.timeByteArraySignedR=new Int8Array(this.fftSize),this.tempTimeArrayL=new Int8Array(this.fftSize),this.tempTimeArrayR=new Int8Array(this.fftSize),this.timeArrayL=new Int8Array(this.numSamps),this.timeArrayR=new Int8Array(this.numSamps)}sampleAudio(){this.analyser.getByteTimeDomainData(this.timeByteArray),this.analyserL.getByteTimeDomainData(this.timeByteArrayL),this.analyserR.getByteTimeDomainData(this.timeByteArrayR),this.processAudio()}updateAudio(t,e,s){this.timeByteArray.set(t),this.timeByteArrayL.set(e),this.timeByteArrayR.set(s),this.processAudio()}processAudio(){for(let t=0,e=0,s=0;t<this.fftSize;t++){const i=this.timeByteArray[t]-128;this.prevTimeArray&&void 0!==this.prevTimeArray[t]?this.timeArray[t]=Math.round(this.smoothingFactor*this.prevTimeArray[t]+(1-this.smoothingFactor)*i):this.timeArray[t]=i,this.timeByteArraySignedL[t]=this.timeByteArrayL[t]-128,this.timeByteArraySignedR[t]=this.timeByteArrayR[t]-128,this.tempTimeArrayL[t]=.5*(this.timeByteArraySignedL[t]+this.timeByteArraySignedL[s]),this.tempTimeArrayR[t]=.5*(this.timeByteArraySignedR[t]+this.timeByteArraySignedR[s]),t%2==0&&(this.timeArrayL[e]=this.tempTimeArrayL[t],this.timeArrayR[e]=this.tempTimeArrayR[t],e+=1),s=t}this.freqArray=this.fft.timeToFrequencyDomain(this.timeArray),this.freqArrayL=this.fft.timeToFrequencyDomain(this.timeByteArraySignedL),this.freqArrayR=this.fft.timeToFrequencyDomain(this.timeByteArraySignedR),this.prevTimeArray=new Int8Array(this.timeArray)}connectAudio(t){t.connect(this.audible)}disconnectAudio(t){t.disconnect(this.audible)}}class bt{constructor(t){let e;this.audio=t,e=this.audio.audioContext?this.audio.audioContext.sampleRate:44100;const s=e/this.audio.fftSize,i=Math.clamp(Math.round(20/s)-1,0,this.audio.numSamps-1),r=Math.clamp(Math.round(320/s)-1,0,this.audio.numSamps-1),a=Math.clamp(Math.round(2800/s)-1,0,this.audio.numSamps-1),o=Math.clamp(Math.round(11025/s)-1,0,this.audio.numSamps-1);this.starts=[i,r,a],this.stops=[r,a,o],this.val=new Float32Array(3),this.imm=new Float32Array(3),this.att=new Float32Array(3),this.avg=new Float32Array(3),this.longAvg=new Float32Array(3),this.att.fill(1),this.avg.fill(1),this.longAvg.fill(1)}get bass(){return this.val[0]}get bass_att(){return this.att[0]}get mid(){return this.val[1]}get mid_att(){return this.att[1]}get treb(){return this.val[2]}get treb_att(){return this.att[2]}static isFiniteNumber(t){return Number.isFinite(t)&&!Number.isNaN(t)}static adjustRateToFPS(t,e,s){return t**(e/s)}updateAudioLevels(t,e){if(this.audio.freqArray.length>0){let s=t;!bt.isFiniteNumber(s)||s<15?s=15:s>144&&(s=144),this.imm.fill(0);for(let t=0;t<3;t++)for(let e=this.starts[t];e<this.stops[t];e++)this.imm[t]+=this.audio.freqArray[e];for(let t=0;t<3;t++){let i;i=this.imm[t]>this.avg[t]?.2:.5,i=bt.adjustRateToFPS(i,30,s),this.avg[t]=this.avg[t]*i+this.imm[t]*(1-i),i=e<50?.9:.992,i=bt.adjustRateToFPS(i,30,s),this.longAvg[t]=this.longAvg[t]*i+this.imm[t]*(1-i),this.longAvg[t]<.001?(this.val[t]=1,this.att[t]=1):(this.val[t]=this.imm[t]/this.longAvg[t],this.att[t]=this.avg[t]/this.longAvg[t])}}}}const _t={baseVals:{gammaadj:1.25,wave_g:.5,mv_x:12,warpscale:1,brighten:0,mv_y:9,wave_scale:1,echo_alpha:0,additivewave:0,sx:1,sy:1,warp:.01,red_blue:0,wave_mode:0,wave_brighten:0,wrap:0,zoomexp:1,fshader:0,wave_r:.5,echo_zoom:1,wave_smoothing:.75,warpanimspeed:1,wave_dots:0,wave_x:.5,wave_y:.5,zoom:1,solarize:0,modwavealphabyvolume:0,dx:0,cx:.5,dy:0,darken_center:0,cy:.5,invert:0,bmotionvectorson:0,rot:0,modwavealphaend:.95,wave_mystery:-.2,decay:.9,wave_a:1,wave_b:.5,rating:5,modwavealphastart:.75,darken:0,echo_orient:0,ib_r:.5,ib_g:.5,ib_b:.5,ib_a:0,ib_size:0,ob_r:.5,ob_g:.5,ob_b:.5,ob_a:0,ob_size:0,mv_dx:0,mv_dy:0,mv_a:0,mv_r:.5,mv_g:.5,mv_b:.5,mv_l:0},init_eqs:function(){return{}},frame_eqs:function(t){return t.rkeys=["warp"],t.zoom=1.01+.02*t.treb_att,t.warp=.15+.25*t.bass_att,t},pixel_eqs:function(t){return t.warp=t.warp+.15*t.rad,t},waves:[{baseVals:{a:1,enabled:0,b:1,g:1,scaling:1,samples:512,additive:0,usedots:0,spectrum:0,r:1,smoothing:.5,thick:0,sep:0},init_eqs:function(t){return t.rkeys=[],t},frame_eqs:function(t){return t},point_eqs:""},{baseVals:{a:1,enabled:0,b:1,g:1,scaling:1,samples:512,additive:0,usedots:0,spectrum:0,r:1,smoothing:.5,thick:0,sep:0},init_eqs:function(t){return t.rkeys=[],t},frame_eqs:function(t){return t},point_eqs:""},{baseVals:{a:1,enabled:0,b:1,g:1,scaling:1,samples:512,additive:0,usedots:0,spectrum:0,r:1,smoothing:.5,thick:0,sep:0},init_eqs:function(t){return t.rkeys=[],t},frame_eqs:function(t){return t},point_eqs:""},{baseVals:{a:1,enabled:0,b:1,g:1,scaling:1,samples:512,additive:0,usedots:0,spectrum:0,r:1,smoothing:.5,thick:0,sep:0},init_eqs:function(t){return t.rkeys=[],t},frame_eqs:function(t){return t},point_eqs:""}],shapes:[{baseVals:{r2:0,a:1,enabled:0,b:0,tex_ang:0,thickoutline:0,g:0,textured:0,g2:1,tex_zoom:1,additive:0,border_a:.1,border_b:1,b2:0,a2:0,r:1,border_g:1,rad:.1,x:.5,y:.5,ang:0,sides:4,border_r:1},init_eqs:function(t){return t.rkeys=[],t},frame_eqs:function(t){return t}},{baseVals:{r2:0,a:1,enabled:0,b:0,tex_ang:0,thickoutline:0,g:0,textured:0,g2:1,tex_zoom:1,additive:0,border_a:.1,border_b:1,b2:0,a2:0,r:1,border_g:1,rad:.1,x:.5,y:.5,ang:0,sides:4,border_r:1},init_eqs:function(t){return t.rkeys=[],t},frame_eqs:function(t){return t}},{baseVals:{r2:0,a:1,enabled:0,b:0,tex_ang:0,thickoutline:0,g:0,textured:0,g2:1,tex_zoom:1,additive:0,border_a:.1,border_b:1,b2:0,a2:0,r:1,border_g:1,rad:.1,x:.5,y:.5,ang:0,sides:4,border_r:1},init_eqs:function(t){return t.rkeys=[],t},frame_eqs:function(t){return t}},{baseVals:{r2:0,a:1,enabled:0,b:0,tex_ang:0,thickoutline:0,g:0,textured:0,g2:1,tex_zoom:1,additive:0,border_a:.1,border_b:1,b2:0,a2:0,r:1,border_g:1,rad:.1,x:.5,y:.5,ang:0,sides:4,border_r:1},init_eqs:function(t){return t.rkeys=[],t},frame_eqs:function(t){return t}}],warp:"shader_body {\nret = texture2D(sampler_main, uv).rgb;\nret -= 0.004;\n}\n",comp:"shader_body {\nret = texture2D(sampler_main, uv).rgb;\nret *= hue_shader;\n}\n"};class vt{static atan2(t,e){let s=Math.atan2(t,e);return s<0&&(s+=2*Math.PI),s}static cloneVars(t){return Object.assign({},t)}static range(t,e){return void 0===e?[...Array(t).keys()]:Array.from({length:e-t},(e,s)=>s+t)}static pick(t,e){const s={};for(let i=0;i<e.length;i++){const r=e[i];s[r]=t[r]||0}return s}static omit(t,e){const s=Object.assign({},t);for(let t=0;t<e.length;t++){delete s[e[t]]}return s}static setWasm(t,e,s){for(let i=0;i<s.length;i++){const r=s[i];t[r].value=e[r]}}static pickWasm(t,e){const s={};for(let i=0;i<e.length;i++){const r=e[i];s[r]=t[r].value}return s}}class Et{constructor(t=1){this.state=new Uint32Array(4),Et.initializeState(this.state,t),this.warmUp()}static initializeState(t,e){t[0]=e,t[1]=2654435769^e,t[2]=1779033703^e,t[3]=3144134277^e}warmUp(){for(let t=0;t<10;t++)this.next()}next(){let t=this.state[3];const e=this.state[0];return this.state[3]=this.state[2],this.state[2]=this.state[1],this.state[1]=e,t^=t<<11,t^=t>>>8,this.state[0]=t^e^e>>>19,(this.state[0]>>>0)/4294967296}nextInt(t){return Math.floor(this.next()*t)}rand(t){return t<1?this.next():Math.floor(this.next()*Math.floor(t))}reset(t){Et.initializeState(this.state,t),this.warmUp()}}function xt(){return{random:Math.random,rand:t=>t<1?Math.random():Math.random()*Math.floor(t),randint:t=>Math.floor((t<1?Math.random():Math.random()*Math.floor(t))+1),getRNG:()=>null,reset:()=>{}}}let wt=null;function yt(t={}){return wt=t.deterministic||t.testMode?function(t=1){const e=new Et(t);return{random:()=>e.next(),rand:t=>e.rand(t),randint:t=>Math.floor(e.rand(t)+1),getRNG:()=>e,reset:s=>{void 0!==s?e.reset(s):e.reset(t)}}}(t.seed||12345):xt(),(t.deterministic||t.testMode)&&(window.rand=t=>wt.rand(t),window.randint=t=>wt.randint(t),Math.random=()=>wt.random()),wt}function St(){return wt||(wt=xt()),wt}class Pt{constructor(t,e,s){this.rng=St(),this.preset=t,this.texsizeX=s.texsizeX,this.texsizeY=s.texsizeY,this.mesh_width=s.mesh_width,this.mesh_height=s.mesh_height,this.aspectx=s.aspectx,this.aspecty=s.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.qs=vt.range(1,33).map(t=>`q${t}`),this.ts=vt.range(1,9).map(t=>`t${t}`),this.regs=vt.range(100).map(t=>t<10?`reg0${t}`:`reg${t}`),this.initializeEquations(e)}initializeEquations(t){this.runVertEQs=""!==this.preset.pixel_eqs,this.mdVSQInit=null,this.mdVSRegs=null,this.mdVSFrame=null,this.mdVSUserKeys=null,this.mdVSFrameMap=null,this.mdVSShapes=null,this.mdVSUserKeysShapes=null,this.mdVSFrameMapShapes=null,this.mdVSWaves=null,this.mdVSUserKeysWaves=null,this.mdVSFrameMapWaves=null,this.mdVSQAfterFrame=null,this.gmegabuf=new Array(1048576).fill(0);const e={frame:t.frame,time:t.time,fps:t.fps,bass:t.bass,bass_att:t.bass_att,mid:t.mid,mid_att:t.mid_att,treb:t.treb,treb_att:t.treb_att,meshx:this.mesh_width,meshy:this.mesh_height,aspectx:this.invAspectx,aspecty:this.invAspecty,pixelsx:this.texsizeX,pixelsy:this.texsizeY,gmegabuf:this.gmegabuf};this.mdVS=Object.assign({},this.preset.baseVals,e),this.mdVS.megabuf=new Array(1048576).fill(0),this.mdVS.rand_start=new Float32Array([this.rng.random(),this.rng.random(),this.rng.random(),this.rng.random()]),this.mdVS.rand_preset=new Float32Array([this.rng.random(),this.rng.random(),this.rng.random(),this.rng.random()]);const s=this.qs.concat(this.regs,Object.keys(this.mdVS)),i=this.preset.init_eqs(vt.cloneVars(this.mdVS));this.mdVSQInit=vt.pick(i,this.qs),this.mdVSRegs=vt.pick(i,this.regs);const r=vt.pick(i,Object.keys(vt.omit(i,s)));if(r.megabuf=i.megabuf,r.gmegabuf=i.gmegabuf,this.mdVSFrame=this.preset.frame_eqs(Object.assign({},this.mdVS,this.mdVSQInit,this.mdVSRegs,r)),this.mdVSUserKeys=Object.keys(vt.omit(this.mdVSFrame,s)),this.mdVSFrameMap=vt.pick(this.mdVSFrame,this.mdVSUserKeys),this.mdVSQAfterFrame=vt.pick(this.mdVSFrame,this.qs),this.mdVSRegs=vt.pick(this.mdVSFrame,this.regs),this.mdVSWaves=[],this.mdVSTWaveInits=[],this.mdVSUserKeysWaves=[],this.mdVSFrameMapWaves=[],this.preset.waves&&this.preset.waves.length>0)for(let t=0;t<this.preset.waves.length;t++){const s=this.preset.waves[t],i=s.baseVals;if(0!==i.enabled){let r=Object.assign({},i,e);const a=this.qs.concat(this.ts,this.regs,Object.keys(r));Object.assign(r,this.mdVSQAfterFrame,this.mdVSRegs),r.megabuf=new Array(1048576).fill(0),s.init_eqs&&(r=s.init_eqs(r),this.mdVSRegs=vt.pick(r,this.regs),Object.assign(r,i)),this.mdVSWaves.push(r),this.mdVSTWaveInits.push(vt.pick(r,this.ts)),this.mdVSUserKeysWaves.push(Object.keys(vt.omit(r,a))),this.mdVSFrameMapWaves.push(vt.pick(r,this.mdVSUserKeysWaves[t]))}else this.mdVSWaves.push({}),this.mdVSTWaveInits.push({}),this.mdVSUserKeysWaves.push([]),this.mdVSFrameMapWaves.push({})}if(this.mdVSShapes=[],this.mdVSTShapeInits=[],this.mdVSUserKeysShapes=[],this.mdVSFrameMapShapes=[],this.preset.shapes&&this.preset.shapes.length>0)for(let t=0;t<this.preset.shapes.length;t++){const s=this.preset.shapes[t],i=s.baseVals;if(0!==i.enabled){let r=Object.assign({},i,e);const a=this.qs.concat(this.ts,this.regs,Object.keys(r));Object.assign(r,this.mdVSQAfterFrame,this.mdVSRegs),r.megabuf=new Array(1048576).fill(0),s.init_eqs&&(r=s.init_eqs(r),this.mdVSRegs=vt.pick(r,this.regs),Object.assign(r,i)),this.mdVSShapes.push(r),this.mdVSTShapeInits.push(vt.pick(r,this.ts)),this.mdVSUserKeysShapes.push(Object.keys(vt.omit(r,a))),this.mdVSFrameMapShapes.push(vt.pick(r,this.mdVSUserKeysShapes[t]))}else this.mdVSShapes.push({}),this.mdVSTShapeInits.push({}),this.mdVSUserKeysShapes.push([]),this.mdVSFrameMapShapes.push({})}}updatePreset(t,e){this.preset=t,this.initializeEquations(e)}updateGlobals(t){this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.mesh_width=t.mesh_width,this.mesh_height=t.mesh_height,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty}runFrameEquations(t){return this.mdVSFrame=Object.assign({},this.mdVS,this.mdVSQInit,this.mdVSFrameMap,t),this.mdVSFrame=this.preset.frame_eqs(this.mdVSFrame),this.mdVSFrameMap=vt.pick(this.mdVSFrame,this.mdVSUserKeys),this.mdVSQAfterFrame=vt.pick(this.mdVSFrame,this.qs),this.mdVSFrame}runPixelEquations(t){return this.preset.pixel_eqs(t)}runShapeFrameEquations(t,e){return this.preset.shapes[t].frame_eqs(e)}runWaveFrameEquations(t,e){return this.preset.waves[t].frame_eqs(e)}runWavePointEquations(t,e){return this.preset.waves[t].point_eqs(e)}}class Tt{constructor(t,e,s){this.rng=St(),this.preset=t,this.texsizeX=s.texsizeX,this.texsizeY=s.texsizeY,this.mesh_width=s.mesh_width,this.mesh_height=s.mesh_height,this.aspectx=s.aspectx,this.aspecty=s.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.qs=vt.range(1,33).map(t=>`q${t}`),this.ts=vt.range(1,9).map(t=>`t${t}`),this.regs=vt.range(100).map(t=>t<10?`reg0${t}`:`reg${t}`),this.globalKeys=["frame","time","fps","bass","bass_att","mid","mid_att","treb","treb_att","meshx","meshy","aspectx","aspecty","pixelsx","pixelsy"],this.frameKeys=["decay","wave_a","wave_r","wave_g","wave_b","wave_x","wave_y","wave_scale","wave_smoothing","wave_mode","old_wave_mode","wave_mystery","ob_size","ob_r","ob_g","ob_b","ob_a","ib_size","ib_r","ib_g","ib_b","ib_a","mv_x","mv_y","mv_dx","mv_dy","mv_l","mv_r","mv_g","mv_b","mv_a","echo_zoom","echo_alpha","echo_orient","wave_dots","wave_thick","additivewave","wave_brighten","modwavealphabyvolume","modwavealphastart","modwavealphaend","darken_center","gammaadj","warp","warpanimspeed","warpscale","zoom","zoomexp","rot","cx","cy","dx","dy","sx","sy","fshader","wrap","invert","brighten","darken","solarize","bmotionvectorson","b1n","b2n","b3n","b1x","b2x","b3x","b1ed"],this.waveFrameKeys=["samples","sep","scaling","spectrum","smoothing","r","g","b","a"],this.waveFrameInputKeys=["samples","r","g","b","a"],this.initializeEquations(e)}getQVars(t){return vt.pickWasm(this.preset.globalPools[t],this.qs)}getTVars(t){return vt.pickWasm(this.preset.globalPools[t],this.ts)}initializeEquations(t){this.runVertEQs=!!this.preset.pixel_eqs,this.mdVSQInit=null,this.mdVSQAfterFrame=null;const e={frame:t.frame,time:t.time,fps:t.fps,bass:t.bass,bass_att:t.bass_att,mid:t.mid,mid_att:t.mid_att,treb:t.treb,treb_att:t.treb_att,meshx:this.mesh_width,meshy:this.mesh_height,aspectx:this.invAspectx,aspecty:this.invAspecty,pixelsx:this.texsizeX,pixelsy:this.texsizeY};if(this.mdVS=Object.assign({},this.preset.baseVals,e),vt.setWasm(this.preset.globalPools.perFrame,this.mdVS,Object.keys(this.mdVS)),this.rand_start=new Float32Array([this.rng.random(),this.rng.random(),this.rng.random(),this.rng.random()]),this.rand_preset=new Float32Array([this.rng.random(),this.rng.random(),this.rng.random(),this.rng.random()]),this.preset.init_eqs(),this.mdVSQInit=this.getQVars("perFrame"),this.preset.frame_eqs(),this.mdVSQAfterFrame=this.getQVars("perFrame"),this.mdVSTWaveInits=[],this.preset.waves&&this.preset.waves.length>0)for(let t=0;t<this.preset.waves.length;t++){const e=this.preset.waves[t],s=e.baseVals;0!==s.enabled?(vt.setWasm(this.preset.globalPools[`wavePerFrame${t}`],s,Object.keys(s)),e.init_eqs&&(e.init_eqs(),vt.setWasm(this.preset.globalPools[`wavePerFrame${t}`],s,Object.keys(s))),this.mdVSTWaveInits.push(this.getTVars(`wavePerFrame${t}`))):this.mdVSTWaveInits.push({})}if(this.mdVSTShapeInits=[],this.preset.shapes&&this.preset.shapes.length>0)for(let t=0;t<this.preset.shapes.length;t++){const e=this.preset.shapes[t],s=e.baseVals;0!==s.enabled?(vt.setWasm(this.preset.globalPools[`shapePerFrame${t}`],s,Object.keys(s)),e.init_eqs&&(e.init_eqs(),vt.setWasm(this.preset.globalPools[`shapePerFrame${t}`],s,Object.keys(s))),this.mdVSTShapeInits.push(this.getTVars(`shapePerFrame${t}`))):this.mdVSTShapeInits.push({})}}updatePreset(t,e){this.preset=t,this.initializeEquations(e)}updateGlobals(t){this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.mesh_width=t.mesh_width,this.mesh_height=t.mesh_height,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty}runFrameEquations(t){vt.setWasm(this.preset.globalPools.perFrame,this.mdVS,this.frameKeys),vt.setWasm(this.preset.globalPools.perFrame,this.mdVSQInit,this.qs),vt.setWasm(this.preset.globalPools.perFrame,t,this.globalKeys),this.preset.frame_eqs(),this.preset.save_qs(),this.mdVSQAfterFrame=this.getQVars("perFrame");const e=vt.pickWasm(this.preset.globalPools.perFrame,[...this.frameKeys,...this.globalKeys]);return e.rand_preset=this.rand_preset,e.rand_start=this.rand_start,e}runWaveFrameEquations(t,e){const s=this.preset.waves[t].baseVals;return vt.setWasm(this.preset.globalPools[`wavePerFrame${t}`],s,this.waveFrameInputKeys),vt.setWasm(this.preset.globalPools[`wavePerFrame${t}`],this.mdVSQAfterFrame,this.qs),vt.setWasm(this.preset.globalPools[`wavePerFrame${t}`],this.mdVSTWaveInits[t],this.ts),vt.setWasm(this.preset.globalPools[`wavePerFrame${t}`],e,this.globalKeys),this.preset.waves[t].frame_eqs(),vt.pickWasm(this.preset.globalPools[`wavePerFrame${t}`],this.waveFrameKeys)}}class It{constructor(t){this.gl=t,this.randomFn=St().random,this.anisoExt=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.noiseTexLQ=this.gl.createTexture(),this.noiseTexLQLite=this.gl.createTexture(),this.noiseTexMQ=this.gl.createTexture(),this.noiseTexHQ=this.gl.createTexture(),this.noiseTexVolLQ=this.gl.createTexture(),this.noiseTexVolHQ=this.gl.createTexture(),this.nTexArrLQ=It.createNoiseTex(256,1,this.randomFn),this.nTexArrLQLite=It.createNoiseTex(32,1,this.randomFn),this.nTexArrMQ=It.createNoiseTex(256,4,this.randomFn),this.nTexArrHQ=It.createNoiseTex(256,8,this.randomFn),this.nTexArrVolLQ=It.createNoiseVolTex(32,1,this.randomFn),this.nTexArrVolHQ=It.createNoiseVolTex(32,4,this.randomFn),this.bindTexture(this.noiseTexLQ,this.nTexArrLQ,256,256),this.bindTexture(this.noiseTexLQLite,this.nTexArrLQLite,32,32),this.bindTexture(this.noiseTexMQ,this.nTexArrMQ,256,256),this.bindTexture(this.noiseTexHQ,this.nTexArrHQ,256,256),this.bindTexture3D(this.noiseTexVolLQ,this.nTexArrVolLQ,32,32,32),this.bindTexture3D(this.noiseTexVolHQ,this.nTexArrVolHQ,32,32,32),this.noiseTexPointLQ=this.gl.createSampler(),t.samplerParameteri(this.noiseTexPointLQ,t.TEXTURE_MIN_FILTER,t.NEAREST_MIPMAP_NEAREST),t.samplerParameteri(this.noiseTexPointLQ,t.TEXTURE_MAG_FILTER,t.NEAREST),t.samplerParameteri(this.noiseTexPointLQ,t.TEXTURE_WRAP_S,t.REPEAT),t.samplerParameteri(this.noiseTexPointLQ,t.TEXTURE_WRAP_T,t.REPEAT)}bindTexture(t,e,s,i){if(this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,s,i,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.anisoExt){const t=this.gl.getParameter(this.anisoExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.gl.texParameterf(this.gl.TEXTURE_2D,this.anisoExt.TEXTURE_MAX_ANISOTROPY_EXT,t)}}bindTexture3D(t,e,s,i,r){if(this.gl.bindTexture(this.gl.TEXTURE_3D,t),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.texImage3D(this.gl.TEXTURE_3D,0,this.gl.RGBA,s,i,r,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.generateMipmap(this.gl.TEXTURE_3D),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_R,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.anisoExt){const t=this.gl.getParameter(this.anisoExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.gl.texParameterf(this.gl.TEXTURE_3D,this.anisoExt.TEXTURE_MAX_ANISOTROPY_EXT,t)}}static fCubicInterpolate(t,e,s,i,r){const a=r*r,o=i-s-t+e;return o*(r*a)+(t-e-o)*a+(s-t)*r+e}static dwCubicInterpolate(t,e,s,i,r){const a=[];for(let o=0;o<4;o++){let n=It.fCubicInterpolate(t[o]/255,e[o]/255,s[o]/255,i[o]/255,r);n=Math.clamp(n,0,1),a[o]=255*n}return a}static createNoiseVolTex(t,e,s){const i=t*t*t,r=new Uint8Array(4*i),a=e>1?216:256,o=.5*a;for(let t=0;t<i;t++)r[4*t+0]=Math.floor(s()*a+o),r[4*t+1]=Math.floor(s()*a+o),r[4*t+2]=Math.floor(s()*a+o),r[4*t+3]=Math.floor(s()*a+o);const n=t*t,h=t;if(e>1){for(let s=0;s<t;s+=e)for(let i=0;i<t;i+=e)for(let a=0;a<t;a++)if(a%e!==0){const o=Math.floor(a/e)*e+t,l=s*n+i*h,A=[],c=[],g=[],m=[];for(let s=0;s<4;s++)A[s]=r[4*l+(o-e)%t*4+s],c[s]=r[4*l+o%t*4+s],g[s]=r[4*l+(o+e)%t*4+s],m[s]=r[4*l+(o+2*e)%t*4+s];const u=a%e/e,d=It.dwCubicInterpolate(A,c,g,m,u);for(let t=0;t<4;t++){r[s*n*4+i*h*4+(4*a+t)]=d[t]}}for(let s=0;s<t;s+=e)for(let i=0;i<t;i++)for(let a=0;a<t;a++)if(a%e!==0){const o=Math.floor(a/e)*e+t,l=s*n,A=[],c=[],g=[],m=[];for(let s=0;s<4;s++){const a=4*i+4*l+s;A[s]=r[(o-e)%t*h*4+a],c[s]=r[o%t*h*4+a],g[s]=r[(o+e)%t*h*4+a],m[s]=r[(o+2*e)%t*h*4+a]}const u=a%e/e,d=It.dwCubicInterpolate(A,c,g,m,u);for(let t=0;t<4;t++){r[a*h*4+(4*i+4*l+t)]=d[t]}}for(let s=0;s<t;s++)for(let i=0;i<t;i++)for(let a=0;a<t;a++)if(a%e!==0){const o=i*h,l=Math.floor(a/e)*e+t,A=[],c=[],g=[],m=[];for(let i=0;i<4;i++){const a=4*s+4*o+i;A[i]=r[(l-e)%t*n*4+a],c[i]=r[l%t*n*4+a],g[i]=r[(l+e)%t*n*4+a],m[i]=r[(l+2*e)%t*n*4+a]}const u=i%e/e,d=It.dwCubicInterpolate(A,c,g,m,u);for(let t=0;t<4;t++){r[a*n*4+(4*s+4*o+t)]=d[t]}}}return r}static createNoiseTex(t,e,s){const i=t*t,r=new Uint8Array(4*i),a=e>1?216:256,o=.5*a;for(let t=0;t<i;t++)r[4*t+0]=Math.floor(s()*a+o),r[4*t+1]=Math.floor(s()*a+o),r[4*t+2]=Math.floor(s()*a+o),r[4*t+3]=Math.floor(s()*a+o);if(e>1){for(let s=0;s<t;s+=e)for(let i=0;i<t;i++)if(i%e!==0){const a=Math.floor(i/e)*e+t,o=s*t,n=[],h=[],l=[],A=[];for(let s=0;s<4;s++)n[s]=r[4*o+(a-e)%t*4+s],h[s]=r[4*o+a%t*4+s],l[s]=r[4*o+(a+e)%t*4+s],A[s]=r[4*o+(a+2*e)%t*4+s];const c=i%e/e,g=It.dwCubicInterpolate(n,h,l,A,c);for(let e=0;e<4;e++)r[s*t*4+4*i+e]=g[e]}for(let s=0;s<t;s++)for(let i=0;i<t;i++)if(i%e!==0){const a=Math.floor(i/e)*e+t,o=[],n=[],h=[],l=[];for(let i=0;i<4;i++)o[i]=r[(a-e)%t*t*4+4*s+i],n[i]=r[a%t*t*4+4*s+i],h[i]=r[(a+e)%t*t*4+4*s+i],l[i]=r[(a+2*e)%t*t*4+4*s+i];const A=i%e/e,c=It.dwCubicInterpolate(o,n,h,l,A);for(let e=0;e<4;e++)r[i*t*4+4*s+e]=c[e]}}return r}}class Rt{constructor(t){this.gl=t,this.anisoExt=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.samplers={},this.clouds2Image=new Image,this.clouds2Image.onload=()=>{this.samplers.clouds2=this.gl.createTexture(),this.bindTexture(this.samplers.clouds2,this.clouds2Image,128,128)},this.clouds2Image.src="data:image/jpeg;base64,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",this.emptyImage=new Image,this.emptyImage.onload=()=>{this.samplers.empty=this.gl.createTexture(),this.bindTexture(this.samplers.empty,this.emptyImage,1,1)},this.emptyImage.src="data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs="}bindTexture(t,e,s,i){if(this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,s,i,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.anisoExt){const t=this.gl.getParameter(this.anisoExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.gl.texParameterf(this.gl.TEXTURE_2D,this.anisoExt.TEXTURE_MAX_ANISOTROPY_EXT,t)}}loadExtraImages(t){Object.keys(t).forEach(e=>{const{data:s,width:i,height:r}=t[e];if(!this.samplers[e]){const t=new Image;t.onload=()=>{this.samplers[e]=this.gl.createTexture(),this.bindTexture(this.samplers[e],t,i,r)},t.src=s}})}getTexture(t){const e=this.samplers[t];return e||this.samplers.clouds2}}const Bt=/uniform sampler2D sampler_(?:.+?);/g,Ct=/uniform sampler2D sampler_(.+?);/;class Lt{static getShaderParts(t){const e=t.indexOf("shader_body");if(t&&e>-1){const s=t.substring(0,e),i=t.substring(e),r=i.indexOf("{"),a=i.lastIndexOf("}");return[s,i.substring(r+1,a)]}return["",t]}static getFragmentFloatPrecision(t){return t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0?"highp":t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}static getUserSamplers(t){const e=[],s=t.match(Bt);if(s&&s.length>0)for(let t=0;t<s.length;t++){const i=s[t].match(Ct);if(i&&i.length>0){const t=i[1];e.push({sampler:t})}}return e}}class Ft{static smoothWave(t,e,s,i=!1){const r=-.15,a=1.15,o=1.15,n=-.15;let h,l=0,A=0,c=1;for(let g=0;g<s-1;g++){h=c,c=Math.min(s-1,g+2);for(let s=0;s<3;s++)e[3*l+s]=t[3*g+s];if(i)for(let s=0;s<3;s++)e[3*(l+1)+s]=.5*(r*t[3*A+s]+a*t[3*g+s]+o*t[3*h+s]+n*t[3*c+s]);else{for(let s=0;s<2;s++)e[3*(l+1)+s]=.5*(r*t[3*A+s]+a*t[3*g+s]+o*t[3*h+s]+n*t[3*c+s]);e[3*(l+1)+2]=0}A=g,l+=2}for(let i=0;i<3;i++)e[3*l+i]=t[3*(s-1)+i]}static smoothWaveAndColor(t,e,s,i,r,a=!1){const o=-.15,n=1.15,h=1.15,l=-.15;let A,c=0,g=0,m=1;for(let u=0;u<r-1;u++){A=m,m=Math.min(r-1,u+2);for(let e=0;e<3;e++)s[3*c+e]=t[3*u+e];if(a)for(let e=0;e<3;e++)s[3*(c+1)+e]=.5*(o*t[3*g+e]+n*t[3*u+e]+h*t[3*A+e]+l*t[3*m+e]);else{for(let e=0;e<2;e++)s[3*(c+1)+e]=.5*(o*t[3*g+e]+n*t[3*u+e]+h*t[3*A+e]+l*t[3*m+e]);s[3*(c+1)+2]=0}for(let t=0;t<4;t++)i[4*c+t]=e[4*u+t],i[4*(c+1)+t]=e[4*u+t];g=u,c+=2}for(let e=0;e<3;e++)s[3*c+e]=t[3*(r-1)+e];for(let t=0;t<4;t++)i[4*c+t]=e[4*(r-1)+t]}}class Mt{constructor(t,e={}){this.gl=t;this.positions=new Float32Array(1536),this.positions2=new Float32Array(1536),this.oldPositions=new Float32Array(1536),this.oldPositions2=new Float32Array(1536),this.smoothedPositions=new Float32Array(3069),this.smoothedPositions2=new Float32Array(3069),this.color=[0,0,0,1],this.texsizeX=e.texsizeX,this.texsizeY=e.texsizeY,this.aspectx=e.aspectx,this.aspecty=e.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader(),this.vertexBuf=this.gl.createBuffer()}updateGlobals(t){this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"\n      #version 300 es\n      in vec3 aPos;\n      uniform vec2 thickOffset;\n      void main(void) {\n        gl_Position = vec4(aPos + vec3(thickOffset, 0.0), 1.0);\n      }\n      ".trim()),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      precision highp int;\n      precision mediump sampler2D;\n      out vec4 fragColor;\n      uniform vec4 u_color;\n      void main(void) {\n        fragColor = u_color;\n      }\n      `.trim()),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.aPosLoc=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.colorLoc=this.gl.getUniformLocation(this.shaderProgram,"u_color"),this.thickOffsetLoc=this.gl.getUniformLocation(this.shaderProgram,"thickOffset")}static processWaveform(t,e){const s=[],i=e.wave_scale/128,r=e.wave_smoothing,a=i*(1-r);s.push(t[0]*i);for(let e=1;e<t.length;e++)s.push(t[e]*a+s[e-1]*r);return s}generateWaveform(t,e,s,i,r){let a=r.wave_a;const o=(r.bass+r.mid+r.treb)/3;if(o>-.01&&a>.001&&s.length>0){const n=Mt.processWaveform(s,r),h=Mt.processWaveform(i,r),l=Math.floor(r.wave_mode)%8,A=Math.floor(r.old_wave_mode)%8,c=2*r.wave_x-1,g=2*r.wave_y-1;this.numVert=0,this.oldNumVert=0;const m=t&&l!==A?2:1;for(let t=0;t<m;t++){const e=0===t?l:A;let s,i,m,u=r.wave_mystery;if(0!==e&&1!==e&&4!==e||!(u<-1||u>1)||(u=.5*u+.5,u-=Math.floor(u),u=Math.abs(u),u=2*u-1),0===t?(i=this.positions,m=this.positions2):(i=this.oldPositions,m=this.oldPositions2),a=r.wave_a,0===e){if(r.modwavealphabyvolume>0){const t=r.modwavealphaend-r.modwavealphastart;a*=(o-r.modwavealphastart)/t}a=Math.clamp(a,0,1),s=Math.floor(n.length/2)+1;const t=1/(s-1),e=Math.floor((n.length-s)/2);for(let a=0;a<s-1;a++){let o=.5+.4*h[a+e]+u;const n=a*t*2*Math.PI+.2*r.time;if(a<s/10){let t=a/(.1*s);t=.5-.5*Math.cos(t*Math.PI);o=(1-t)*(.5+.4*h[a+s+e]+u)+o*t}i[3*a+0]=o*Math.cos(n)*this.aspecty+c,i[3*a+1]=o*Math.sin(n)*this.aspectx+g,i[3*a+2]=0}i[3*(s-1)+0]=i[0],i[3*(s-1)+1]=i[1],i[3*(s-1)+2]=0}else if(1===e){if(a*=1.25,r.modwavealphabyvolume>0){const t=r.modwavealphaend-r.modwavealphastart;a*=(o-r.modwavealphastart)/t}a=Math.clamp(a,0,1),s=Math.floor(n.length/2);for(let t=0;t<s;t++){const e=.53+.43*h[t]+u,s=.5*n[t+32]*Math.PI+2.3*r.time;i[3*t+0]=e*Math.cos(s)*this.aspecty+c,i[3*t+1]=e*Math.sin(s)*this.aspectx+g,i[3*t+2]=0}}else if(2===e){if(this.texsizeX<1024?a*=.09:this.texsizeX>=1024&&this.texsizeX<2048?a*=.11:a*=.13,r.modwavealphabyvolume>0){const t=r.modwavealphaend-r.modwavealphastart;a*=(o-r.modwavealphastart)/t}a=Math.clamp(a,0,1),s=n.length;for(let t=0;t<n.length;t++)i[3*t+0]=h[t]*this.aspecty+c,i[3*t+1]=n[(t+32)%n.length]*this.aspectx+g,i[3*t+2]=0}else if(3===e){if(this.texsizeX<1024?a*=.15:this.texsizeX>=1024&&this.texsizeX<2048?a*=.22:a*=.33,a*=1.3,a*=r.treb*r.treb,r.modwavealphabyvolume>0){const t=r.modwavealphaend-r.modwavealphastart;a*=(o-r.modwavealphastart)/t}a=Math.clamp(a,0,1),s=n.length;for(let t=0;t<n.length;t++)i[3*t+0]=h[t]*this.aspecty+c,i[3*t+1]=n[(t+32)%n.length]*this.aspectx+g,i[3*t+2]=0}else if(4===e){if(r.modwavealphabyvolume>0){const t=r.modwavealphaend-r.modwavealphastart;a*=(o-r.modwavealphastart)/t}a=Math.clamp(a,0,1),s=n.length,s>this.texsizeX/3&&(s=Math.floor(this.texsizeX/3));const t=1/s,e=Math.floor((n.length-s)/2),l=.45+.5*(.5*u+.5),A=1-l;for(let r=0;r<s;r++){let s=2*r*t+(c-1)+.44*h[(r+25+e)%n.length],a=.47*n[r+e]+g;r>1&&(s=s*A+l*(2*i[3*(r-1)+0]-i[3*(r-2)+0]),a=a*A+l*(2*i[3*(r-1)+1]-i[3*(r-2)+1])),i[3*r+0]=s,i[3*r+1]=a,i[3*r+2]=0}}else if(5===e){if(this.texsizeX<1024?a*=.09:this.texsizeX>=1024&&this.texsizeX<2048?a*=.11:a*=.13,r.modwavealphabyvolume>0){const t=r.modwavealphaend-r.modwavealphastart;a*=(o-r.modwavealphastart)/t}a=Math.clamp(a,0,1);const t=Math.cos(.3*r.time),e=Math.sin(.3*r.time);s=n.length;for(let s=0;s<n.length;s++){const r=(s+32)%n.length,a=h[s]*n[r]+n[s]*h[r],o=h[s]*h[s]-n[r]*n[r];i[3*s+0]=(a*t-o*e)*(this.aspecty+c),i[3*s+1]=(a*e+o*t)*(this.aspectx+g),i[3*s+2]=0}}else if(6===e||7===e){if(r.modwavealphabyvolume>0){const t=r.modwavealphaend-r.modwavealphastart;a*=(o-r.modwavealphastart)/t}a=Math.clamp(a,0,1),s=Math.floor(n.length/2),s>this.texsizeX/3&&(s=Math.floor(this.texsizeX/3));const t=Math.floor((n.length-s)/2),l=.5*Math.PI*u;let A=Math.cos(l),d=Math.sin(l);const f=[c*Math.cos(l+.5*Math.PI)-3*A,c*Math.cos(l+.5*Math.PI)+3*A],p=[c*Math.sin(l+.5*Math.PI)-3*d,c*Math.sin(l+.5*Math.PI)+3*d];for(let t=0;t<2;t++)for(let e=0;e<4;e++){let s,i=!1;switch(e){case 0:f[t]>1.1&&(s=(1.1-f[1-t])/(f[t]-f[1-t]),i=!0);break;case 1:f[t]<-1.1&&(s=(-1.1-f[1-t])/(f[t]-f[1-t]),i=!0);break;case 2:p[t]>1.1&&(s=(1.1-p[1-t])/(p[t]-p[1-t]),i=!0);break;case 3:p[t]<-1.1&&(s=(-1.1-p[1-t])/(p[t]-p[1-t]),i=!0)}if(i){const e=f[t]-f[1-t],i=p[t]-p[1-t];f[t]=f[1-t]+e*s,p[t]=p[1-t]+i*s}}A=(f[1]-f[0])/s,d=(p[1]-p[0])/s;const b=Math.atan2(d,A),_=Math.cos(b+.5*Math.PI),v=Math.sin(b+.5*Math.PI);if(6===e)for(let e=0;e<s;e++){const s=n[e+t];i[3*e+0]=f[0]+A*e+.25*_*s,i[3*e+1]=p[0]+d*e+.25*v*s,i[3*e+2]=0}else if(7===e){const e=(.5*g+.5)**2;for(let r=0;r<s;r++){const s=n[r+t];i[3*r+0]=f[0]+A*r+_*(.25*s+e),i[3*r+1]=p[0]+d*r+v*(.25*s+e),i[3*r+2]=0}for(let i=0;i<s;i++){const s=h[i+t];m[3*i+0]=f[0]+A*i+_*(.25*s-e),m[3*i+1]=p[0]+d*i+v*(.25*s-e),m[3*i+2]=0}}}0===t?(this.positions=i,this.positions2=m,this.numVert=s,this.alpha=a):(this.oldPositions=i,this.oldPositions2=m,this.oldNumVert=s,this.oldAlpha=a)}const u=.5-.5*Math.cos(e*Math.PI),d=1-u;this.oldNumVert>0&&(a=u*this.alpha+d*this.oldAlpha);let f=Math.clamp(r.wave_r,0,1),p=Math.clamp(r.wave_g,0,1),b=Math.clamp(r.wave_b,0,1);if(0!==r.wave_brighten){const t=Math.max(f,p,b);t>.01&&(f/=t,p/=t,b/=t)}if(this.color=[f,p,b,a],this.oldNumVert>0)if(7===l){const t=(this.oldNumVert-1)/(2*this.numVert);for(let e=0;e<this.numVert;e++){const s=e*t,i=Math.floor(s),r=s-i,a=this.oldPositions[3*i+0]*(1-r)+this.oldPositions[3*(i+1)+0]*r,o=this.oldPositions[3*i+1]*(1-r)+this.oldPositions[3*(i+1)+1]*r;this.positions[3*e+0]=this.positions[3*e+0]*u+a*d,this.positions[3*e+1]=this.positions[3*e+1]*u+o*d,this.positions[3*e+2]=0}for(let e=0;e<this.numVert;e++){const s=(e+this.numVert)*t,i=Math.floor(s),r=s-i,a=this.oldPositions[3*i+0]*(1-r)+this.oldPositions[3*(i+1)+0]*r,o=this.oldPositions[3*i+1]*(1-r)+this.oldPositions[3*(i+1)+1]*r;this.positions2[3*e+0]=this.positions2[3*e+0]*u+a*d,this.positions2[3*e+1]=this.positions2[3*e+1]*u+o*d,this.positions2[3*e+2]=0}}else if(7===A){const t=this.numVert/2,e=(this.oldNumVert-1)/t;for(let s=0;s<t;s++){const t=s*e,i=Math.floor(t),r=t-i,a=this.oldPositions[3*i+0]*(1-r)+this.oldPositions[3*(i+1)+0]*r,o=this.oldPositions[3*i+1]*(1-r)+this.oldPositions[3*(i+1)+1]*r;this.positions[3*s+0]=this.positions[3*s+0]*u+a*d,this.positions[3*s+1]=this.positions[3*s+1]*u+o*d,this.positions[3*s+2]=0}for(let s=0;s<t;s++){const i=s*e,r=Math.floor(i),a=i-r,o=this.oldPositions2[3*r+0]*(1-a)+this.oldPositions2[3*(r+1)+0]*a,n=this.oldPositions2[3*r+1]*(1-a)+this.oldPositions2[3*(r+1)+1]*a;this.positions2[3*s+0]=this.positions[3*(s+t)+0]*u+o*d,this.positions2[3*s+1]=this.positions[3*(s+t)+1]*u+n*d,this.positions2[3*s+2]=0}}else{const t=(this.oldNumVert-1)/this.numVert;for(let e=0;e<this.numVert;e++){const s=e*t,i=Math.floor(s),r=s-i,a=this.oldPositions[3*i+0]*(1-r)+this.oldPositions[3*(i+1)+0]*r,o=this.oldPositions[3*i+1]*(1-r)+this.oldPositions[3*(i+1)+1]*r;this.positions[3*e+0]=this.positions[3*e+0]*u+a*d,this.positions[3*e+1]=this.positions[3*e+1]*u+o*d,this.positions[3*e+2]=0}}for(let t=0;t<this.numVert;t++)this.positions[3*t+1]=-this.positions[3*t+1];if(this.smoothedNumVert=2*this.numVert-1,Ft.smoothWave(this.positions,this.smoothedPositions,this.numVert),7===l||7===A){for(let t=0;t<this.numVert;t++)this.positions2[3*t+1]=-this.positions2[3*t+1];Ft.smoothWave(this.positions2,this.smoothedPositions2,this.numVert)}return!0}return!1}drawBasicWaveform(t,e,s,i,r){if(this.generateWaveform(t,e,s,i,r)){this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.smoothedPositions,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPosLoc,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosLoc),this.gl.uniform4fv(this.colorLoc,this.color);let t=1;0===r.wave_thick&&0===r.wave_dots||(t=4),0!==r.additivewave?this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE):this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);const e=0!==r.wave_dots?this.gl.POINTS:this.gl.LINE_STRIP;for(let s=0;s<t;s++){const t=2;0===s?this.gl.uniform2fv(this.thickOffsetLoc,[0,0]):1===s?this.gl.uniform2fv(this.thickOffsetLoc,[t/this.texsizeX,0]):2===s?this.gl.uniform2fv(this.thickOffsetLoc,[0,t/this.texsizeY]):3===s&&this.gl.uniform2fv(this.thickOffsetLoc,[t/this.texsizeX,t/this.texsizeY]),this.gl.drawArrays(e,0,this.smoothedNumVert)}if(7===Math.floor(r.wave_mode)%8){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.smoothedPositions2,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPosLoc,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosLoc);for(let s=0;s<t;s++){const t=2;0===s?this.gl.uniform2fv(this.thickOffsetLoc,[0,0]):1===s?this.gl.uniform2fv(this.thickOffsetLoc,[t/this.texsizeX,0]):2===s?this.gl.uniform2fv(this.thickOffsetLoc,[0,t/this.texsizeY]):3===s&&this.gl.uniform2fv(this.thickOffsetLoc,[t/this.texsizeX,t/this.texsizeY]),this.gl.drawArrays(e,0,this.smoothedNumVert)}}}}}class Ut{constructor(t,e,s){this.index=t,this.gl=e;const i=512;this.pointsData=[new Float32Array(i),new Float32Array(i)],this.positions=new Float32Array(1536),this.colors=new Float32Array(2048),this.smoothedPositions=new Float32Array(3069),this.smoothedColors=new Float32Array(4092),this.texsizeX=s.texsizeX,this.texsizeY=s.texsizeY,this.mesh_width=s.mesh_width,this.mesh_height=s.mesh_height,this.aspectx=s.aspectx,this.aspecty=s.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.positionVertexBuf=this.gl.createBuffer(),this.colorVertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader()}updateGlobals(t){this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.mesh_width=t.mesh_width,this.mesh_height=t.mesh_height,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"\n      #version 300 es\n      uniform float uSize;\n      uniform vec2 thickOffset;\n      in vec3 aPos;\n      in vec4 aColor;\n      out vec4 vColor;\n      void main(void) {\n        vColor = aColor;\n        gl_PointSize = uSize;\n        gl_Position = vec4(aPos + vec3(thickOffset, 0.0), 1.0);\n      }\n      ".trim()),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      precision highp int;\n      precision mediump sampler2D;\n      in vec4 vColor;\n      out vec4 fragColor;\n      void main(void) {\n        fragColor = vColor;\n      }\n      `.trim()),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.aPosLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.aColorLocation=this.gl.getAttribLocation(this.shaderProgram,"aColor"),this.sizeLoc=this.gl.getUniformLocation(this.shaderProgram,"uSize"),this.thickOffsetLoc=this.gl.getUniformLocation(this.shaderProgram,"thickOffset")}generateWaveform(t,e,s,i,r,a,o,n){if(0!==o.baseVals.enabled&&t.length>0){let h;if(a.preset.useWASM)h=a.runWaveFrameEquations(this.index,r);else{const t=Object.assign({},a.mdVSWaves[this.index],a.mdVSFrameMapWaves[this.index],a.mdVSQAfterFrame,a.mdVSTWaveInits[this.index],r);h=a.runWaveFrameEquations(this.index,t)}const l=512;Object.prototype.hasOwnProperty.call(h,"samples")?this.samples=h.samples:this.samples=l,this.samples>l&&(this.samples=l),this.samples=Math.floor(this.samples);const A=a.preset.waves[this.index].baseVals,c=Math.floor(h.sep),g=h.scaling,m=h.spectrum,u=h.smoothing,d=A.usedots,f=h.r,p=h.g,b=h.b,_=h.a,v=a.preset.baseVals.wave_scale;if(this.samples-=c,this.samples>=2||0!==d&&this.samples>=1){const r=0!==m,E=(r?.15:.004)*g*v,x=r?s:t,w=r?i:e,y=r?0:Math.floor((l-this.samples)/2-c/2),S=r?0:Math.floor((l-this.samples)/2+c/2),P=r?(l-c)/this.samples:1,T=(.98*u)**.5,I=1-T;this.pointsData[0][0]=x[y],this.pointsData[1][0]=w[S];for(let t=1;t<this.samples;t++){const e=x[Math.floor(t*P+y)],s=w[Math.floor(t*P+S)];this.pointsData[0][t]=e*I+this.pointsData[0][t-1]*T,this.pointsData[1][t]=s*I+this.pointsData[1][t-1]*T}for(let t=this.samples-2;t>=0;t--)this.pointsData[0][t]=this.pointsData[0][t]*I+this.pointsData[0][t+1]*T,this.pointsData[1][t]=this.pointsData[1][t]*I+this.pointsData[1][t+1]*T;for(let t=0;t<this.samples;t++)this.pointsData[0][t]*=E,this.pointsData[1][t]*=E;if(a.preset.useWASM){const t=a.preset.globalPools[`wavePerFrame${this.index}`];for(let e=0;e<this.samples;e++){const s=this.pointsData[0][e],i=this.pointsData[1][e];t.sample.value=e/(this.samples-1),t.value1.value=s,t.value2.value=i,t.x.value=.5+s,t.y.value=.5+i,t.r.value=f,t.g.value=p,t.b.value=b,t.a.value=_,o.point_eqs&&a.preset.waves[this.index].point_eqs();const r=(2*t.x.value-1)*this.invAspectx,h=(-2*t.y.value+1)*this.invAspecty,l=t.r.value,A=t.g.value,c=t.b.value,g=t.a.value;this.positions[3*e+0]=r,this.positions[3*e+1]=h,this.positions[3*e+2]=0,this.colors[4*e+0]=l,this.colors[4*e+1]=A,this.colors[4*e+2]=c,this.colors[4*e+3]=g*n}}else for(let t=0;t<this.samples;t++){const e=this.pointsData[0][t],s=this.pointsData[1][t];h.sample=t/(this.samples-1),h.value1=e,h.value2=s,h.x=.5+e,h.y=.5+s,h.r=f,h.g=p,h.b=b,h.a=_,""!==o.point_eqs&&(h=a.runWavePointEquations(this.index,h));const i=(2*h.x-1)*this.invAspectx,r=(-2*h.y+1)*this.invAspecty,l=h.r,A=h.g,c=h.b,g=h.a;this.positions[3*t+0]=i,this.positions[3*t+1]=r,this.positions[3*t+2]=0,this.colors[4*t+0]=l,this.colors[4*t+1]=A,this.colors[4*t+2]=c,this.colors[4*t+3]=g*n}if(a.preset.useWASM)h.usedots=d,h.thick=A.thick,h.additive=A.additive;else{const t=a.mdVSUserKeysWaves[this.index],e=vt.pick(h,t);a.mdVSFrameMapWaves[this.index]=e}return this.mdVSWaveFrame=h,0===d&&Ft.smoothWaveAndColor(this.positions,this.colors,this.smoothedPositions,this.smoothedColors,this.samples),!0}}return!1}drawCustomWaveform(t,e,s,i,r,a,o,n){if(n&&this.generateWaveform(e,s,i,r,a,o,n,t)){this.gl.useProgram(this.shaderProgram);const t=0!==this.mdVSWaveFrame.usedots,e=0!==this.mdVSWaveFrame.thick,s=0!==this.mdVSWaveFrame.additive;let i,r,a;t?(i=this.positions,r=this.colors,a=this.samples):(i=this.smoothedPositions,r=this.smoothedColors,a=2*this.samples-1),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,i,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPosLocation,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aColorLocation,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aColorLocation);let o=1;t?e?this.gl.uniform1f(this.sizeLoc,2+(this.texsizeX>=1024?1:0)):this.gl.uniform1f(this.sizeLoc,1+(this.texsizeX>=1024?1:0)):(this.gl.uniform1f(this.sizeLoc,1),e&&(o=4)),s?this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE):this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);const n=t?this.gl.POINTS:this.gl.LINE_STRIP;for(let t=0;t<o;t++){const e=2;0===t?this.gl.uniform2fv(this.thickOffsetLoc,[0,0]):1===t?this.gl.uniform2fv(this.thickOffsetLoc,[e/this.texsizeX,0]):2===t?this.gl.uniform2fv(this.thickOffsetLoc,[0,e/this.texsizeY]):3===t&&this.gl.uniform2fv(this.thickOffsetLoc,[e/this.texsizeX,e/this.texsizeY]),this.gl.drawArrays(n,0,a)}}}}let Qt=class{constructor(t,e,s){this.index=t,this.gl=e;this.positions=new Float32Array(309),this.colors=new Float32Array(412),this.uvs=new Float32Array(206),this.borderPositions=new Float32Array(306),this.texsizeX=s.texsizeX,this.texsizeY=s.texsizeY,this.mesh_width=s.mesh_width,this.mesh_height=s.mesh_height,this.aspectx=s.aspectx,this.aspecty=s.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.positionVertexBuf=this.gl.createBuffer(),this.colorVertexBuf=this.gl.createBuffer(),this.uvVertexBuf=this.gl.createBuffer(),this.borderPositionVertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader(),this.createBorderShader(),this.mainSampler=this.gl.createSampler(),e.samplerParameteri(this.mainSampler,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.samplerParameteri(this.mainSampler,e.TEXTURE_MAG_FILTER,e.LINEAR),e.samplerParameteri(this.mainSampler,e.TEXTURE_WRAP_S,e.REPEAT),e.samplerParameteri(this.mainSampler,e.TEXTURE_WRAP_T,e.REPEAT)}updateGlobals(t){this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.mesh_width=t.mesh_width,this.mesh_height=t.mesh_height,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"\n      #version 300 es\n      in vec3 aPos;\n      in vec4 aColor;\n      in vec2 aUv;\n      out vec4 vColor;\n      out vec2 vUv;\n      void main(void) {\n        vColor = aColor;\n        vUv = aUv;\n        gl_Position = vec4(aPos, 1.0);\n      }\n      ".trim()),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      precision highp int;\n      precision mediump sampler2D;\n      uniform sampler2D uTexture;\n      uniform float uTextured;\n      in vec4 vColor;\n      in vec2 vUv;\n      out vec4 fragColor;\n      void main(void) {\n        if (uTextured != 0.0) {\n          fragColor = texture(uTexture, vUv) * vColor;\n        } else {\n          fragColor = vColor;\n        }\n      }\n      `.trim()),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.aPosLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.aColorLocation=this.gl.getAttribLocation(this.shaderProgram,"aColor"),this.aUvLocation=this.gl.getAttribLocation(this.shaderProgram,"aUv"),this.texturedLoc=this.gl.getUniformLocation(this.shaderProgram,"uTextured"),this.textureLoc=this.gl.getUniformLocation(this.shaderProgram,"uTexture")}createBorderShader(){this.borderShaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"\n      #version 300 es\n      in vec3 aBorderPos;\n      uniform vec2 thickOffset;\n      void main(void) {\n        gl_Position = vec4(aBorderPos +\n                            vec3(thickOffset, 0.0), 1.0);\n      }\n      ".trim()),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      precision highp int;\n      precision mediump sampler2D;\n      out vec4 fragColor;\n      uniform vec4 uBorderColor;\n      void main(void) {\n        fragColor = uBorderColor;\n      }\n      `.trim()),this.gl.compileShader(e),this.gl.attachShader(this.borderShaderProgram,t),this.gl.attachShader(this.borderShaderProgram,e),this.gl.linkProgram(this.borderShaderProgram),this.aBorderPosLoc=this.gl.getAttribLocation(this.borderShaderProgram,"aBorderPos"),this.uBorderColorLoc=this.gl.getUniformLocation(this.borderShaderProgram,"uBorderColor"),this.thickOffsetLoc=this.gl.getUniformLocation(this.shaderProgram,"thickOffset")}drawCustomShape(t,e,s,i,r){if(0!==i.baseVals.enabled)if(s.preset.useWASM){this.setupShapeBuffers(s.preset.globalPools.perFrame.wrap.value);const i=s.preset.shapes[this.index].baseVals,a=s.preset.globalPools[`shapePerFrame${this.index}`];vt.setWasm(a,e,s.globalKeys),s.preset.shapes[this.index].frame_eqs||s.preset.restore_qs(),vt.setWasm(a,s.mdVSTShapeInits[this.index],s.ts),s.preset.save_ts(),a.x.value=i.x,a.y.value=i.y,a.rad.value=i.rad,a.ang.value=i.ang,a.r.value=i.r,a.g.value=i.g,a.b.value=i.b,a.a.value=i.a,a.r2.value=i.r2,a.g2.value=i.g2,a.b2.value=i.b2,a.a2.value=i.a2,a.border_r.value=i.border_r,a.border_g.value=i.border_g,a.border_b.value=i.border_b,a.border_a.value=i.border_a,a.thickoutline.value=i.thickoutline,a.textured.value=i.textured,a.tex_zoom.value=i.tex_zoom,a.tex_ang.value=i.tex_ang,a.additive.value=i.additive,s.preset.shapes[this.index].frame_eqs_save();const o=Math.clamp(i.num_inst,1,1024);for(let e=0;e<o;e++){a.instance.value=e,s.preset.shapes[this.index].frame_eqs&&(s.preset.shapes[this.index].frame_eqs_restore(),s.preset.restore_qs(),s.preset.restore_ts(),s.preset.shapes[this.index].frame_eqs());let i=a.sides.value;i=Math.clamp(i,3,100),i=Math.floor(i);const o=a.rad.value,n=a.ang.value,h=2*a.x.value-1,l=-2*a.y.value+1,A=a.r.value,c=a.g.value,g=a.b.value,m=a.a.value,u=a.r2.value,d=a.g2.value,f=a.b2.value,p=a.a2.value,b=a.border_r.value,_=a.border_g.value,v=a.border_b.value,E=a.border_a.value;this.borderColor=[b,_,v,E*t];const x=a.thickoutline.value,w=a.textured.value,y=a.tex_zoom.value,S=a.tex_ang.value,P=a.additive.value,T=this.borderColor[3]>0,I=Math.abs(w)>=1,R=Math.abs(x)>=1,B=Math.abs(P)>=1;this.positions[0]=h,this.positions[1]=l,this.positions[2]=0,this.colors[0]=A,this.colors[1]=c,this.colors[2]=g,this.colors[3]=m*t,I&&(this.uvs[0]=.5,this.uvs[1]=.5);const C=.25*Math.PI;for(let e=1;e<=i+1;e++){const s=2*((e-1)/i)*Math.PI,r=s+n+C;if(this.positions[3*e+0]=h+o*Math.cos(r)*this.aspecty,this.positions[3*e+1]=l+o*Math.sin(r),this.positions[3*e+2]=0,this.colors[4*e+0]=u,this.colors[4*e+1]=d,this.colors[4*e+2]=f,this.colors[4*e+3]=p*t,I){const t=s+S+C;this.uvs[2*e+0]=.5+.5*Math.cos(t)/y*this.aspecty,this.uvs[2*e+1]=.5+.5*Math.sin(t)/y}T&&(this.borderPositions[3*(e-1)+0]=this.positions[3*e+0],this.borderPositions[3*(e-1)+1]=this.positions[3*e+1],this.borderPositions[3*(e-1)+2]=this.positions[3*e+2])}this.drawCustomShapeInstance(r,i,I,T,R,B)}}else{this.setupShapeBuffers(s.mdVSFrame.wrap);let i=Object.assign({},s.mdVSShapes[this.index],s.mdVSFrameMapShapes[this.index],e);""===s.preset.shapes[this.index].frame_eqs_str&&(i=Object.assign(i,s.mdVSQAfterFrame,s.mdVSTShapeInits[this.index]));const a=s.preset.shapes[this.index].baseVals,o=Math.clamp(a.num_inst,1,1024);for(let e=0;e<o;e++){let o;i.instance=e,i.x=a.x,i.y=a.y,i.rad=a.rad,i.ang=a.ang,i.r=a.r,i.g=a.g,i.b=a.b,i.a=a.a,i.r2=a.r2,i.g2=a.g2,i.b2=a.b2,i.a2=a.a2,i.border_r=a.border_r,i.border_g=a.border_g,i.border_b=a.border_b,i.border_a=a.border_a,i.thickoutline=a.thickoutline,i.textured=a.textured,i.tex_zoom=a.tex_zoom,i.tex_ang=a.tex_ang,i.additive=a.additive,""!==s.preset.shapes[this.index].frame_eqs_str?(i=Object.assign(i,s.mdVSQAfterFrame,s.mdVSTShapeInits[this.index]),o=s.runShapeFrameEquations(this.index,i)):o=i;let n=o.sides;n=Math.clamp(n,3,100),n=Math.floor(n);const h=o.rad,l=o.ang,A=2*o.x-1,c=-2*o.y+1,g=o.r,m=o.g,u=o.b,d=o.a,f=o.r2,p=o.g2,b=o.b2,_=o.a2,v=o.border_r,E=o.border_g,x=o.border_b,w=o.border_a;this.borderColor=[v,E,x,w*t];const y=o.thickoutline,S=o.textured,P=o.tex_zoom,T=o.tex_ang,I=o.additive,R=this.borderColor[3]>0,B=Math.abs(S)>=1,C=Math.abs(y)>=1,L=Math.abs(I)>=1;this.positions[0]=A,this.positions[1]=c,this.positions[2]=0,this.colors[0]=g,this.colors[1]=m,this.colors[2]=u,this.colors[3]=d*t,B&&(this.uvs[0]=.5,this.uvs[1]=.5);const F=.25*Math.PI;for(let e=1;e<=n+1;e++){const s=2*((e-1)/n)*Math.PI,i=s+l+F;if(this.positions[3*e+0]=A+h*Math.cos(i)*this.aspecty,this.positions[3*e+1]=c+h*Math.sin(i),this.positions[3*e+2]=0,this.colors[4*e+0]=f,this.colors[4*e+1]=p,this.colors[4*e+2]=b,this.colors[4*e+3]=_*t,B){const t=s+T+F;this.uvs[2*e+0]=.5+.5*Math.cos(t)/P*this.aspecty,this.uvs[2*e+1]=.5+.5*Math.sin(t)/P}R&&(this.borderPositions[3*(e-1)+0]=this.positions[3*e+0],this.borderPositions[3*(e-1)+1]=this.positions[3*e+1],this.borderPositions[3*(e-1)+2]=this.positions[3*e+2])}this.mdVSShapeFrame=o,this.drawCustomShapeInstance(r,n,B,R,C,L)}const n=s.mdVSUserKeysShapes[this.index],h=vt.pick(this.mdVSShapeFrame,n);s.mdVSFrameMapShapes[this.index]=h}}setupShapeBuffers(t){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.positions,this.gl.DYNAMIC_DRAW),this.gl.vertexAttribPointer(this.aPosLocation,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.colors,this.gl.DYNAMIC_DRAW),this.gl.vertexAttribPointer(this.aColorLocation,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aColorLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.uvVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.uvs,this.gl.DYNAMIC_DRAW),this.gl.vertexAttribPointer(this.aUvLocation,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aUvLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.borderPositionVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.borderPositions,this.gl.DYNAMIC_DRAW),this.gl.vertexAttribPointer(this.aBorderPosLoc,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aBorderPosLoc);const e=0!==t?this.gl.REPEAT:this.gl.CLAMP_TO_EDGE;this.gl.samplerParameteri(this.mainSampler,this.gl.TEXTURE_WRAP_S,e),this.gl.samplerParameteri(this.mainSampler,this.gl.TEXTURE_WRAP_T,e)}drawCustomShapeInstance(t,e,s,i,r,a){if(this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionVertexBuf),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.positions,0,3*(e+2)),this.gl.vertexAttribPointer(this.aPosLocation,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorVertexBuf),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.colors,0,4*(e+2)),this.gl.vertexAttribPointer(this.aColorLocation,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aColorLocation),s&&(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.uvVertexBuf),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.uvs,0,2*(e+2)),this.gl.vertexAttribPointer(this.aUvLocation,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aUvLocation)),this.gl.uniform1f(this.texturedLoc,s?1:0),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.bindSampler(0,this.mainSampler),this.gl.uniform1i(this.textureLoc,0),a?this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE):this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLE_FAN,0,e+2),i){this.gl.useProgram(this.borderShaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.borderPositionVertexBuf),this.gl.bufferSubData(this.gl.ARRAY_BUFFER,0,this.borderPositions,0,3*(e+1)),this.gl.vertexAttribPointer(this.aBorderPosLoc,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aBorderPosLoc),this.gl.uniform4fv(this.uBorderColorLoc,this.borderColor);const t=r?4:1;for(let s=0;s<t;s++){const t=2;0===s?this.gl.uniform2fv(this.thickOffsetLoc,[0,0]):1===s?this.gl.uniform2fv(this.thickOffsetLoc,[t/this.texsizeX,0]):2===s?this.gl.uniform2fv(this.thickOffsetLoc,[0,t/this.texsizeY]):3===s&&this.gl.uniform2fv(this.thickOffsetLoc,[t/this.texsizeX,t/this.texsizeY]),this.gl.drawArrays(this.gl.LINE_STRIP,0,e+1)}}}};class kt{constructor(t,e={}){this.gl=t,this.positions=new Float32Array(72),this.aspectx=e.aspectx,this.aspecty=e.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader(),this.vertexBuf=this.gl.createBuffer()}updateGlobals(t){this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"\n      #version 300 es\n      in vec3 aPos;\n      void main(void) {\n        gl_Position = vec4(aPos, 1.0);\n      }\n      ".trim()),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      precision highp int;\n      precision mediump sampler2D;\n      out vec4 fragColor;\n      uniform vec4 u_color;\n      void main(void) {\n        fragColor = u_color;\n      }\n      `.trim()),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.aPosLoc=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.colorLoc=this.gl.getUniformLocation(this.shaderProgram,"u_color")}addTriangle(t,e,s,i){this.positions[t+0]=e[0],this.positions[t+1]=e[1],this.positions[t+2]=e[2],this.positions[t+3]=s[0],this.positions[t+4]=s[1],this.positions[t+5]=s[2],this.positions[t+6]=i[0],this.positions[t+7]=i[1],this.positions[t+8]=i[2]}generateBorder(t,e,s){if(e>0&&t[3]>0){const t=2,i=2,r=t/2,a=i/2,o=s/2,n=e/2+o,h=o*t,l=o*i,A=n*t,c=n*i;let g=[-r+h,-a+c,0],m=[-r+h,a-c,0],u=[-r+A,a-c,0],d=[-r+A,-a+c,0];return this.addTriangle(0,d,m,g),this.addTriangle(9,d,u,m),g=[r-h,-a+c,0],m=[r-h,a-c,0],u=[r-A,a-c,0],d=[r-A,-a+c,0],this.addTriangle(18,g,m,d),this.addTriangle(27,m,u,d),g=[-r+h,-a+l,0],m=[-r+h,c-a,0],u=[r-h,c-a,0],d=[r-h,-a+l,0],this.addTriangle(36,d,m,g),this.addTriangle(45,d,u,m),g=[-r+h,a-l,0],m=[-r+h,a-c,0],u=[r-h,a-c,0],d=[r-h,a-l,0],this.addTriangle(54,g,m,d),this.addTriangle(63,m,u,d),!0}return!1}drawBorder(t,e,s){this.generateBorder(t,e,s)&&(this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.positions,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPosLoc,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosLoc),this.gl.uniform4fv(this.colorLoc,t),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,0,this.positions.length/3))}}class Dt{constructor(t,e){this.gl=t,this.aspectx=e.aspectx,this.aspecty=e.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.generatePositions(),this.colors=new Float32Array([0,0,0,3/32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),this.positionVertexBuf=this.gl.createBuffer(),this.colorVertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader()}updateGlobals(t){this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.generatePositions()}generatePositions(){const t=.05;this.positions=new Float32Array([0,0,0,-.05*this.aspecty,0,0,0,-.05,0,t*this.aspecty,0,0,0,t,0,-.05*this.aspecty,0,0])}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"\n      #version 300 es\n      in vec3 aPos;\n      in vec4 aColor;\n      out vec4 vColor;\n      void main(void) {\n        vColor = aColor;\n        gl_Position = vec4(aPos, 1.0);\n      }\n      ".trim()),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      precision highp int;\n      precision mediump sampler2D;\n      in vec4 vColor;\n      out vec4 fragColor;\n      void main(void) {\n        fragColor = vColor;\n      }\n      `.trim()),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.aPosLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.aColorLocation=this.gl.getAttribLocation(this.shaderProgram,"aColor")}drawDarkenCenter(t){0!==t.darken_center&&(this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.positions,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPosLocation,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.colorVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.colors,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aColorLocation,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aColorLocation),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLE_FAN,0,this.positions.length/3))}}class Vt{constructor(t,e){this.gl=t,this.maxX=64,this.maxY=48,this.positions=new Float32Array(this.maxX*this.maxY*2*3),this.texsizeX=e.texsizeX,this.texsizeY=e.texsizeY,this.mesh_width=e.mesh_width,this.mesh_height=e.mesh_height,this.positionVertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader()}updateGlobals(t){this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.mesh_width=t.mesh_width,this.mesh_height=t.mesh_height}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"\n      #version 300 es\n      in vec3 aPos;\n      void main(void) {\n        gl_Position = vec4(aPos, 1.0);\n      }\n      ".trim()),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      precision highp int;\n      precision mediump sampler2D;\n      out vec4 fragColor;\n      uniform vec4 u_color;\n      void main(void) {\n        fragColor = u_color;\n      }\n      `.trim()),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.aPosLoc=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.colorLoc=this.gl.getUniformLocation(this.shaderProgram,"u_color")}getMotionDir(t,e,s){const i=Math.floor(s*this.mesh_height),r=s*this.mesh_height-i,a=Math.floor(e*this.mesh_width),o=e*this.mesh_width-a,n=a+1,h=i+1,l=this.mesh_width+1;let A,c;return A=t[2*(i*l+a)+0]*(1-o)*(1-r),c=t[2*(i*l+a)+1]*(1-o)*(1-r),A+=t[2*(i*l+n)+0]*o*(1-r),c+=t[2*(i*l+n)+1]*o*(1-r),A+=t[2*(h*l+a)+0]*(1-o)*r,c+=t[2*(h*l+a)+1]*(1-o)*r,A+=t[2*(h*l+n)+0]*o*r,c+=t[2*(h*l+n)+1]*o*r,[A,1-c]}generateMotionVectors(t,e){const s=0===t.bmotionvectorson?0:t.mv_a;let i=Math.floor(t.mv_x),r=Math.floor(t.mv_y);if(s>.001&&i>0&&r>0){let a=t.mv_x-i,o=t.mv_y-r;i>this.maxX&&(i=this.maxX,a=0),r>this.maxY&&(r=this.maxY,o=0);const n=t.mv_dx,h=t.mv_dy,l=t.mv_l,A=1/this.texsizeX;this.numVecVerts=0;for(let t=0;t<r;t++){let s=(t+.25)/(r+o+.25-1);if(s-=h,s>1e-4&&s<.9999)for(let t=0;t<i;t++){let r=(t+.25)/(i+a+.25-1);if(r+=n,r>1e-4&&r<.9999){const t=this.getMotionDir(e,r,s);let i=t[0],a=t[1],o=i-r,n=a-s;o*=l,n*=l;let h=Math.sqrt(o*o+n*n);h<A&&h>1e-8?(h=A/h,o*=h,n*=h):(o=A,o=A),i=r+o,a=s+n;const c=2*r-1,g=2*s-1,m=2*i-1,u=2*a-1;this.positions[3*this.numVecVerts+0]=c,this.positions[3*this.numVecVerts+1]=g,this.positions[3*this.numVecVerts+2]=0,this.positions[3*(this.numVecVerts+1)+0]=m,this.positions[3*(this.numVecVerts+1)+1]=u,this.positions[3*(this.numVecVerts+1)+2]=0,this.numVecVerts+=2}}}if(this.numVecVerts>0)return this.color=[t.mv_r,t.mv_g,t.mv_b,s],!0}return!1}drawMotionVectors(t,e){this.generateMotionVectors(t,e)&&(this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.positions,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.aPosLoc,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosLoc),this.gl.uniform4fv(this.colorLoc,this.color),this.gl.lineWidth(1),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.LINES,0,this.numVecVerts))}}class qt{constructor(t,e,s,i={}){this.gl=t,this.noise=e,this.image=s,this.rng=St(),this.texsizeX=i.texsizeX,this.texsizeY=i.texsizeY,this.mesh_width=i.mesh_width,this.mesh_height=i.mesh_height,this.aspectx=i.aspectx,this.aspecty=i.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.buildPositions(),this.indexBuf=t.createBuffer(),this.positionVertexBuf=this.gl.createBuffer(),this.warpUvVertexBuf=this.gl.createBuffer(),this.warpColorVertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader(),this.mainSampler=this.gl.createSampler(),this.mainSamplerFW=this.gl.createSampler(),this.mainSamplerFC=this.gl.createSampler(),this.mainSamplerPW=this.gl.createSampler(),this.mainSamplerPC=this.gl.createSampler(),t.samplerParameteri(this.mainSampler,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.samplerParameteri(this.mainSampler,t.TEXTURE_MAG_FILTER,t.LINEAR),t.samplerParameteri(this.mainSampler,t.TEXTURE_WRAP_S,t.REPEAT),t.samplerParameteri(this.mainSampler,t.TEXTURE_WRAP_T,t.REPEAT),t.samplerParameteri(this.mainSamplerFW,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.samplerParameteri(this.mainSamplerFW,t.TEXTURE_MAG_FILTER,t.LINEAR),t.samplerParameteri(this.mainSamplerFW,t.TEXTURE_WRAP_S,t.REPEAT),t.samplerParameteri(this.mainSamplerFW,t.TEXTURE_WRAP_T,t.REPEAT),t.samplerParameteri(this.mainSamplerFC,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.samplerParameteri(this.mainSamplerFC,t.TEXTURE_MAG_FILTER,t.LINEAR),t.samplerParameteri(this.mainSamplerFC,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.samplerParameteri(this.mainSamplerFC,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.samplerParameteri(this.mainSamplerPW,t.TEXTURE_MIN_FILTER,t.NEAREST_MIPMAP_NEAREST),t.samplerParameteri(this.mainSamplerPW,t.TEXTURE_MAG_FILTER,t.NEAREST),t.samplerParameteri(this.mainSamplerPW,t.TEXTURE_WRAP_S,t.REPEAT),t.samplerParameteri(this.mainSamplerPW,t.TEXTURE_WRAP_T,t.REPEAT),t.samplerParameteri(this.mainSamplerPC,t.TEXTURE_MIN_FILTER,t.NEAREST_MIPMAP_NEAREST),t.samplerParameteri(this.mainSamplerPC,t.TEXTURE_MAG_FILTER,t.NEAREST),t.samplerParameteri(this.mainSamplerPC,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.samplerParameteri(this.mainSamplerPC,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}buildPositions(){const t=this.mesh_width,e=this.mesh_height,s=t+1,i=e+1,r=2/t,a=2/e,o=[];for(let t=0;t<i;t++){const e=t*a-1;for(let t=0;t<s;t++){const s=t*r-1;o.push(s,-e,0)}}const n=[];for(let i=0;i<e;i++)for(let e=0;e<t;e++){const t=e+s*i,r=e+s*(i+1),a=e+1+s*(i+1),o=e+1+s*i;n.push(t,r,o),n.push(r,a,o)}this.vertices=new Float32Array(o),this.indices=new Uint16Array(n)}updateGlobals(t){this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.mesh_width=t.mesh_width,this.mesh_height=t.mesh_height,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.buildPositions()}createShader(t=""){let e,s;if(0===t.length)e="ret = texture(sampler_main, uv).rgb * decay;",s="";else{const i=Lt.getShaderParts(t);s=i[0],e=i[1]}e=e.replace(/texture2D/g,"texture"),e=e.replace(/texture3D/g,"texture"),this.userTextures=Lt.getUserSamplers(s),this.shaderProgram=this.gl.createProgram();const i=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(i,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      const vec2 halfmad = vec2(0.5);\n      in vec2 aPos;\n      in vec2 aWarpUv;\n      in vec4 aWarpColor;\n      out vec2 uv;\n      out vec2 uv_orig;\n      out vec4 vColor;\n      void main(void) {\n        gl_Position = vec4(aPos, 0.0, 1.0);\n        uv_orig = aPos * halfmad + halfmad;\n        uv = aWarpUv;\n        vColor = aWarpColor;\n      }\n      `.trim()),this.gl.compileShader(i);const r=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(r,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      precision highp int;\n      precision mediump sampler2D;\n      precision mediump sampler3D;\n\n      in vec2 uv;\n      in vec2 uv_orig;\n      in vec4 vColor;\n      out vec4 fragColor;\n      uniform sampler2D sampler_main;\n      uniform sampler2D sampler_fw_main;\n      uniform sampler2D sampler_fc_main;\n      uniform sampler2D sampler_pw_main;\n      uniform sampler2D sampler_pc_main;\n      uniform sampler2D sampler_blur1;\n      uniform sampler2D sampler_blur2;\n      uniform sampler2D sampler_blur3;\n      uniform sampler2D sampler_noise_lq;\n      uniform sampler2D sampler_noise_lq_lite;\n      uniform sampler2D sampler_noise_mq;\n      uniform sampler2D sampler_noise_hq;\n      uniform sampler2D sampler_pw_noise_lq;\n      uniform sampler3D sampler_noisevol_lq;\n      uniform sampler3D sampler_noisevol_hq;\n      uniform float time;\n      uniform float decay;\n      uniform vec2 resolution;\n      uniform vec4 aspect;\n      uniform vec4 texsize;\n      uniform vec4 texsize_noise_lq;\n      uniform vec4 texsize_noise_mq;\n      uniform vec4 texsize_noise_hq;\n      uniform vec4 texsize_noise_lq_lite;\n      uniform vec4 texsize_noisevol_lq;\n      uniform vec4 texsize_noisevol_hq;\n\n      uniform float bass;\n      uniform float mid;\n      uniform float treb;\n      uniform float vol;\n      uniform float bass_att;\n      uniform float mid_att;\n      uniform float treb_att;\n      uniform float vol_att;\n\n      uniform float frame;\n      uniform float fps;\n\n      uniform vec4 _qa;\n      uniform vec4 _qb;\n      uniform vec4 _qc;\n      uniform vec4 _qd;\n      uniform vec4 _qe;\n      uniform vec4 _qf;\n      uniform vec4 _qg;\n      uniform vec4 _qh;\n\n      #define q1 _qa.x\n      #define q2 _qa.y\n      #define q3 _qa.z\n      #define q4 _qa.w\n      #define q5 _qb.x\n      #define q6 _qb.y\n      #define q7 _qb.z\n      #define q8 _qb.w\n      #define q9 _qc.x\n      #define q10 _qc.y\n      #define q11 _qc.z\n      #define q12 _qc.w\n      #define q13 _qd.x\n      #define q14 _qd.y\n      #define q15 _qd.z\n      #define q16 _qd.w\n      #define q17 _qe.x\n      #define q18 _qe.y\n      #define q19 _qe.z\n      #define q20 _qe.w\n      #define q21 _qf.x\n      #define q22 _qf.y\n      #define q23 _qf.z\n      #define q24 _qf.w\n      #define q25 _qg.x\n      #define q26 _qg.y\n      #define q27 _qg.z\n      #define q28 _qg.w\n      #define q29 _qh.x\n      #define q30 _qh.y\n      #define q31 _qh.z\n      #define q32 _qh.w\n\n      uniform vec4 slow_roam_cos;\n      uniform vec4 roam_cos;\n      uniform vec4 slow_roam_sin;\n      uniform vec4 roam_sin;\n\n      uniform float blur1_min;\n      uniform float blur1_max;\n      uniform float blur2_min;\n      uniform float blur2_max;\n      uniform float blur3_min;\n      uniform float blur3_max;\n\n      uniform float scale1;\n      uniform float scale2;\n      uniform float scale3;\n      uniform float bias1;\n      uniform float bias2;\n      uniform float bias3;\n\n      uniform vec4 rand_frame;\n      uniform vec4 rand_preset;\n\n      float PI = ${Math.PI};\n\n      ${s}\n\n      void main(void) {\n        vec3 ret;\n        float rad = length(uv_orig - 0.5);\n        float ang = atan(uv_orig.x - 0.5, uv_orig.y - 0.5);\n\n        ${e}\n\n        fragColor = vec4(ret, 1.0) * vColor;\n      }\n      `.trim()),this.gl.compileShader(r),this.gl.attachShader(this.shaderProgram,i),this.gl.attachShader(this.shaderProgram,r),this.gl.linkProgram(this.shaderProgram),this.positionLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.warpUvLocation=this.gl.getAttribLocation(this.shaderProgram,"aWarpUv"),this.warpColorLocation=this.gl.getAttribLocation(this.shaderProgram,"aWarpColor"),this.textureLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_main"),this.textureFWLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_fw_main"),this.textureFCLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_fc_main"),this.texturePWLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_pw_main"),this.texturePCLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_pc_main"),this.blurTexture1Loc=this.gl.getUniformLocation(this.shaderProgram,"sampler_blur1"),this.blurTexture2Loc=this.gl.getUniformLocation(this.shaderProgram,"sampler_blur2"),this.blurTexture3Loc=this.gl.getUniformLocation(this.shaderProgram,"sampler_blur3"),this.noiseLQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noise_lq"),this.noiseMQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noise_mq"),this.noiseHQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noise_hq"),this.noiseLQLiteLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noise_lq_lite"),this.noisePointLQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_pw_noise_lq"),this.noiseVolLQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noisevol_lq"),this.noiseVolHQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noisevol_hq"),this.decayLoc=this.gl.getUniformLocation(this.shaderProgram,"decay"),this.texsizeLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize"),this.texsizeNoiseLQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noise_lq"),this.texsizeNoiseMQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noise_mq"),this.texsizeNoiseHQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noise_hq"),this.texsizeNoiseLQLiteLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noise_lq_lite"),this.texsizeNoiseVolLQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noisevol_lq"),this.texsizeNoiseVolHQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noisevol_hq"),this.resolutionLoc=this.gl.getUniformLocation(this.shaderProgram,"resolution"),this.aspectLoc=this.gl.getUniformLocation(this.shaderProgram,"aspect"),this.bassLoc=this.gl.getUniformLocation(this.shaderProgram,"bass"),this.midLoc=this.gl.getUniformLocation(this.shaderProgram,"mid"),this.trebLoc=this.gl.getUniformLocation(this.shaderProgram,"treb"),this.volLoc=this.gl.getUniformLocation(this.shaderProgram,"vol"),this.bassAttLoc=this.gl.getUniformLocation(this.shaderProgram,"bass_att"),this.midAttLoc=this.gl.getUniformLocation(this.shaderProgram,"mid_att"),this.trebAttLoc=this.gl.getUniformLocation(this.shaderProgram,"treb_att"),this.volAttLoc=this.gl.getUniformLocation(this.shaderProgram,"vol_att"),this.timeLoc=this.gl.getUniformLocation(this.shaderProgram,"time"),this.frameLoc=this.gl.getUniformLocation(this.shaderProgram,"frame"),this.fpsLoc=this.gl.getUniformLocation(this.shaderProgram,"fps"),this.blur1MinLoc=this.gl.getUniformLocation(this.shaderProgram,"blur1_min"),this.blur1MaxLoc=this.gl.getUniformLocation(this.shaderProgram,"blur1_max"),this.blur2MinLoc=this.gl.getUniformLocation(this.shaderProgram,"blur2_min"),this.blur2MaxLoc=this.gl.getUniformLocation(this.shaderProgram,"blur2_max"),this.blur3MinLoc=this.gl.getUniformLocation(this.shaderProgram,"blur3_min"),this.blur3MaxLoc=this.gl.getUniformLocation(this.shaderProgram,"blur3_max"),this.scale1Loc=this.gl.getUniformLocation(this.shaderProgram,"scale1"),this.scale2Loc=this.gl.getUniformLocation(this.shaderProgram,"scale2"),this.scale3Loc=this.gl.getUniformLocation(this.shaderProgram,"scale3"),this.bias1Loc=this.gl.getUniformLocation(this.shaderProgram,"bias1"),this.bias2Loc=this.gl.getUniformLocation(this.shaderProgram,"bias2"),this.bias3Loc=this.gl.getUniformLocation(this.shaderProgram,"bias3"),this.randPresetLoc=this.gl.getUniformLocation(this.shaderProgram,"rand_preset"),this.randFrameLoc=this.gl.getUniformLocation(this.shaderProgram,"rand_frame"),this.qaLoc=this.gl.getUniformLocation(this.shaderProgram,"_qa"),this.qbLoc=this.gl.getUniformLocation(this.shaderProgram,"_qb"),this.qcLoc=this.gl.getUniformLocation(this.shaderProgram,"_qc"),this.qdLoc=this.gl.getUniformLocation(this.shaderProgram,"_qd"),this.qeLoc=this.gl.getUniformLocation(this.shaderProgram,"_qe"),this.qfLoc=this.gl.getUniformLocation(this.shaderProgram,"_qf"),this.qgLoc=this.gl.getUniformLocation(this.shaderProgram,"_qg"),this.qhLoc=this.gl.getUniformLocation(this.shaderProgram,"_qh"),this.slowRoamCosLoc=this.gl.getUniformLocation(this.shaderProgram,"slow_roam_cos"),this.roamCosLoc=this.gl.getUniformLocation(this.shaderProgram,"roam_cos"),this.slowRoamSinLoc=this.gl.getUniformLocation(this.shaderProgram,"slow_roam_sin"),this.roamSinLoc=this.gl.getUniformLocation(this.shaderProgram,"roam_sin");for(let t=0;t<this.userTextures.length;t++){const e=this.userTextures[t];e.textureLoc=this.gl.getUniformLocation(this.shaderProgram,`sampler_${e.sampler}`)}}updateShader(t){this.createShader(t)}bindBlurVals(t,e){const s=t[0],i=t[1],r=t[2],a=e[0],o=e[1],n=e[2],h=a-s,l=s,A=o-i,c=i,g=n-r,m=r;this.gl.uniform1f(this.blur1MinLoc,s),this.gl.uniform1f(this.blur1MaxLoc,a),this.gl.uniform1f(this.blur2MinLoc,i),this.gl.uniform1f(this.blur2MaxLoc,o),this.gl.uniform1f(this.blur3MinLoc,r),this.gl.uniform1f(this.blur3MaxLoc,n),this.gl.uniform1f(this.scale1Loc,h),this.gl.uniform1f(this.scale2Loc,A),this.gl.uniform1f(this.scale3Loc,g),this.gl.uniform1f(this.bias1Loc,l),this.gl.uniform1f(this.bias2Loc,c),this.gl.uniform1f(this.bias3Loc,m)}renderQuadTexture(t,e,s,i,r,a,o,n,h,l,A){this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuf),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.indices,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.positionLocation,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.warpUvVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,l,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.warpUvLocation,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.warpUvLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.warpColorVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,A,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.warpColorLocation,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.warpColorLocation);const c=0!==n.wrap?this.gl.REPEAT:this.gl.CLAMP_TO_EDGE;this.gl.samplerParameteri(this.mainSampler,this.gl.TEXTURE_WRAP_S,c),this.gl.samplerParameteri(this.mainSampler,this.gl.TEXTURE_WRAP_T,c),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(0,this.mainSampler),this.gl.uniform1i(this.textureLoc,0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(1,this.mainSamplerFW),this.gl.uniform1i(this.textureFWLoc,1),this.gl.activeTexture(this.gl.TEXTURE2),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(2,this.mainSamplerFC),this.gl.uniform1i(this.textureFCLoc,2),this.gl.activeTexture(this.gl.TEXTURE3),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(3,this.mainSamplerPW),this.gl.uniform1i(this.texturePWLoc,3),this.gl.activeTexture(this.gl.TEXTURE4),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(4,this.mainSamplerPC),this.gl.uniform1i(this.texturePCLoc,4),this.gl.activeTexture(this.gl.TEXTURE5),this.gl.bindTexture(this.gl.TEXTURE_2D,s),this.gl.uniform1i(this.blurTexture1Loc,5),this.gl.activeTexture(this.gl.TEXTURE6),this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.uniform1i(this.blurTexture2Loc,6),this.gl.activeTexture(this.gl.TEXTURE7),this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.uniform1i(this.blurTexture3Loc,7),this.gl.activeTexture(this.gl.TEXTURE8),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexLQ),this.gl.uniform1i(this.noiseLQLoc,8),this.gl.activeTexture(this.gl.TEXTURE9),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexMQ),this.gl.uniform1i(this.noiseMQLoc,9),this.gl.activeTexture(this.gl.TEXTURE10),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexHQ),this.gl.uniform1i(this.noiseHQLoc,10),this.gl.activeTexture(this.gl.TEXTURE11),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexLQLite),this.gl.uniform1i(this.noiseLQLiteLoc,11),this.gl.activeTexture(this.gl.TEXTURE12),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexLQ),this.gl.bindSampler(12,this.noise.noiseTexPointLQ),this.gl.uniform1i(this.noisePointLQLoc,12),this.gl.activeTexture(this.gl.TEXTURE13),this.gl.bindTexture(this.gl.TEXTURE_3D,this.noise.noiseTexVolLQ),this.gl.uniform1i(this.noiseVolLQLoc,13),this.gl.activeTexture(this.gl.TEXTURE14),this.gl.bindTexture(this.gl.TEXTURE_3D,this.noise.noiseTexVolHQ),this.gl.uniform1i(this.noiseVolHQLoc,14);for(let t=0;t<this.userTextures.length;t++){const e=this.userTextures[t];this.gl.activeTexture(this.gl.TEXTURE15+t),this.gl.bindTexture(this.gl.TEXTURE_2D,this.image.getTexture(e.sampler)),this.gl.uniform1i(e.textureLoc,15+t)}this.gl.uniform1f(this.decayLoc,n.decay),this.gl.uniform2fv(this.resolutionLoc,[this.texsizeX,this.texsizeY]),this.gl.uniform4fv(this.aspectLoc,[this.aspectx,this.aspecty,this.invAspectx,this.invAspecty]),this.gl.uniform4fv(this.texsizeLoc,[this.texsizeX,this.texsizeY,1/this.texsizeX,1/this.texsizeY]),this.gl.uniform4fv(this.texsizeNoiseLQLoc,[256,256,1/256,1/256]),this.gl.uniform4fv(this.texsizeNoiseMQLoc,[256,256,1/256,1/256]),this.gl.uniform4fv(this.texsizeNoiseHQLoc,[256,256,1/256,1/256]),this.gl.uniform4fv(this.texsizeNoiseLQLiteLoc,[32,32,1/32,1/32]),this.gl.uniform4fv(this.texsizeNoiseVolLQLoc,[32,32,1/32,1/32]),this.gl.uniform4fv(this.texsizeNoiseVolHQLoc,[32,32,1/32,1/32]),this.gl.uniform1f(this.bassLoc,n.bass),this.gl.uniform1f(this.midLoc,n.mid),this.gl.uniform1f(this.trebLoc,n.treb),this.gl.uniform1f(this.volLoc,(n.bass+n.mid+n.treb)/3),this.gl.uniform1f(this.bassAttLoc,n.bass_att),this.gl.uniform1f(this.midAttLoc,n.mid_att),this.gl.uniform1f(this.trebAttLoc,n.treb_att),this.gl.uniform1f(this.volAttLoc,(n.bass_att+n.mid_att+n.treb_att)/3),this.gl.uniform1f(this.timeLoc,n.time),this.gl.uniform1f(this.frameLoc,n.frame),this.gl.uniform1f(this.fpsLoc,n.fps),this.gl.uniform4fv(this.randPresetLoc,n.rand_preset),this.gl.uniform4fv(this.randFrameLoc,new Float32Array([this.rng.random(),this.rng.random(),this.rng.random(),this.rng.random()])),this.gl.uniform4fv(this.qaLoc,new Float32Array([h.q1||0,h.q2||0,h.q3||0,h.q4||0])),this.gl.uniform4fv(this.qbLoc,new Float32Array([h.q5||0,h.q6||0,h.q7||0,h.q8||0])),this.gl.uniform4fv(this.qcLoc,new Float32Array([h.q9||0,h.q10||0,h.q11||0,h.q12||0])),this.gl.uniform4fv(this.qdLoc,new Float32Array([h.q13||0,h.q14||0,h.q15||0,h.q16||0])),this.gl.uniform4fv(this.qeLoc,new Float32Array([h.q17||0,h.q18||0,h.q19||0,h.q20||0])),this.gl.uniform4fv(this.qfLoc,new Float32Array([h.q21||0,h.q22||0,h.q23||0,h.q24||0])),this.gl.uniform4fv(this.qgLoc,new Float32Array([h.q25||0,h.q26||0,h.q27||0,h.q28||0])),this.gl.uniform4fv(this.qhLoc,new Float32Array([h.q29||0,h.q30||0,h.q31||0,h.q32||0])),this.gl.uniform4fv(this.slowRoamCosLoc,[.5+.5*Math.cos(.005*n.time),.5+.5*Math.cos(.008*n.time),.5+.5*Math.cos(.013*n.time),.5+.5*Math.cos(.022*n.time)]),this.gl.uniform4fv(this.roamCosLoc,[.5+.5*Math.cos(.3*n.time),.5+.5*Math.cos(1.3*n.time),.5+.5*Math.cos(5*n.time),.5+.5*Math.cos(20*n.time)]),this.gl.uniform4fv(this.slowRoamSinLoc,[.5+.5*Math.sin(.005*n.time),.5+.5*Math.sin(.008*n.time),.5+.5*Math.sin(.013*n.time),.5+.5*Math.sin(.022*n.time)]),this.gl.uniform4fv(this.roamSinLoc,[.5+.5*Math.sin(.3*n.time),.5+.5*Math.sin(1.3*n.time),.5+.5*Math.sin(5*n.time),.5+.5*Math.sin(20*n.time)]),this.bindBlurVals(a,o),t?this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA):this.gl.disable(this.gl.BLEND),this.gl.drawElements(this.gl.TRIANGLES,this.indices.length,this.gl.UNSIGNED_SHORT,0),t||this.gl.enable(this.gl.BLEND)}}class zt{constructor(t,e,s,i={}){this.gl=t,this.noise=e,this.image=s,this.rng=St(),this.mesh_width=i.mesh_width,this.mesh_height=i.mesh_height,this.texsizeX=i.texsizeX,this.texsizeY=i.texsizeY,this.aspectx=i.aspectx,this.aspecty=i.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.compWidth=32,this.compHeight=24,this.buildPositions(),this.indexBuf=t.createBuffer(),this.positionVertexBuf=this.gl.createBuffer(),this.compColorVertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader(),this.mainSampler=this.gl.createSampler(),this.mainSamplerFW=this.gl.createSampler(),this.mainSamplerFC=this.gl.createSampler(),this.mainSamplerPW=this.gl.createSampler(),this.mainSamplerPC=this.gl.createSampler(),t.samplerParameteri(this.mainSampler,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.samplerParameteri(this.mainSampler,t.TEXTURE_MAG_FILTER,t.LINEAR),t.samplerParameteri(this.mainSampler,t.TEXTURE_WRAP_S,t.REPEAT),t.samplerParameteri(this.mainSampler,t.TEXTURE_WRAP_T,t.REPEAT),t.samplerParameteri(this.mainSamplerFW,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.samplerParameteri(this.mainSamplerFW,t.TEXTURE_MAG_FILTER,t.LINEAR),t.samplerParameteri(this.mainSamplerFW,t.TEXTURE_WRAP_S,t.REPEAT),t.samplerParameteri(this.mainSamplerFW,t.TEXTURE_WRAP_T,t.REPEAT),t.samplerParameteri(this.mainSamplerFC,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.samplerParameteri(this.mainSamplerFC,t.TEXTURE_MAG_FILTER,t.LINEAR),t.samplerParameteri(this.mainSamplerFC,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.samplerParameteri(this.mainSamplerFC,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.samplerParameteri(this.mainSamplerPW,t.TEXTURE_MIN_FILTER,t.NEAREST_MIPMAP_NEAREST),t.samplerParameteri(this.mainSamplerPW,t.TEXTURE_MAG_FILTER,t.NEAREST),t.samplerParameteri(this.mainSamplerPW,t.TEXTURE_WRAP_S,t.REPEAT),t.samplerParameteri(this.mainSamplerPW,t.TEXTURE_WRAP_T,t.REPEAT),t.samplerParameteri(this.mainSamplerPC,t.TEXTURE_MIN_FILTER,t.NEAREST_MIPMAP_NEAREST),t.samplerParameteri(this.mainSamplerPC,t.TEXTURE_MAG_FILTER,t.NEAREST),t.samplerParameteri(this.mainSamplerPC,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.samplerParameteri(this.mainSamplerPC,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}buildPositions(){const t=this.compWidth,e=this.compHeight,s=t+1,i=e+1,r=2/t,a=2/e,o=[];for(let t=0;t<i;t++){const e=t*a-1;for(let t=0;t<s;t++){const s=t*r-1;o.push(s,-e,0)}}const n=[];for(let i=0;i<e;i++)for(let e=0;e<t;e++){const t=e+s*i,r=e+s*(i+1),a=e+1+s*(i+1),o=e+1+s*i;n.push(t,r,o),n.push(r,a,o)}this.vertices=new Float32Array(o),this.indices=new Uint16Array(n)}updateGlobals(t){this.mesh_width=t.mesh_width,this.mesh_height=t.mesh_height,this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.buildPositions()}createShader(t=""){let e,s;if(0===t.length)e="float orient_horiz = mod(echo_orientation, 2.0);\n                        float orient_x = (orient_horiz != 0.0) ? -1.0 : 1.0;\n                        float orient_y = (echo_orientation >= 2.0) ? -1.0 : 1.0;\n                        vec2 uv_echo = ((uv - 0.5) *\n                                        (1.0 / echo_zoom) *\n                                        vec2(orient_x, orient_y)) + 0.5;\n\n                        ret = mix(texture(sampler_main, uv).rgb,\n                                  texture(sampler_main, uv_echo).rgb,\n                                  echo_alpha);\n\n                        ret *= gammaAdj;\n\n                        if(fShader >= 1.0) {\n                          ret *= hue_shader;\n                        } else if(fShader > 0.001) {\n                          ret *= (1.0 - fShader) + (fShader * hue_shader);\n                        }\n\n                        if(brighten != 0) ret = sqrt(ret);\n                        if(darken != 0) ret = ret*ret;\n                        if(solarize != 0) ret = ret * (1.0 - ret) * 4.0;\n                        if(invert != 0) ret = 1.0 - ret;",s="";else{const i=Lt.getShaderParts(t);s=i[0],e=i[1]}e=e.replace(/texture2D/g,"texture"),e=e.replace(/texture3D/g,"texture"),this.userTextures=Lt.getUserSamplers(s),this.shaderProgram=this.gl.createProgram();const i=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(i,"\n      #version 300 es\n      const vec2 halfmad = vec2(0.5);\n      in vec2 aPos;\n      in vec4 aCompColor;\n      out vec2 vUv;\n      out vec4 vColor;\n      void main(void) {\n        gl_Position = vec4(aPos, 0.0, 1.0);\n        vUv = aPos * halfmad + halfmad;\n        vColor = aCompColor;\n      }\n      ".trim()),this.gl.compileShader(i);const r=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(r,`\n      #version 300 es\n      precision ${this.floatPrecision} float;\n      precision highp int;\n      precision mediump sampler2D;\n      precision mediump sampler3D;\n\n      vec3 lum(vec3 v){\n          return vec3(dot(v, vec3(0.32,0.49,0.29)));\n      }\n\n      in vec2 vUv;\n      in vec4 vColor;\n      out vec4 fragColor;\n      uniform sampler2D sampler_main;\n      uniform sampler2D sampler_fw_main;\n      uniform sampler2D sampler_fc_main;\n      uniform sampler2D sampler_pw_main;\n      uniform sampler2D sampler_pc_main;\n      uniform sampler2D sampler_blur1;\n      uniform sampler2D sampler_blur2;\n      uniform sampler2D sampler_blur3;\n      uniform sampler2D sampler_noise_lq;\n      uniform sampler2D sampler_noise_lq_lite;\n      uniform sampler2D sampler_noise_mq;\n      uniform sampler2D sampler_noise_hq;\n      uniform sampler2D sampler_pw_noise_lq;\n      uniform sampler3D sampler_noisevol_lq;\n      uniform sampler3D sampler_noisevol_hq;\n\n      uniform float time;\n      uniform float gammaAdj;\n      uniform float echo_zoom;\n      uniform float echo_alpha;\n      uniform float echo_orientation;\n      uniform int invert;\n      uniform int brighten;\n      uniform int darken;\n      uniform int solarize;\n      uniform vec2 resolution;\n      uniform vec4 aspect;\n      uniform vec4 texsize;\n      uniform vec4 texsize_noise_lq;\n      uniform vec4 texsize_noise_mq;\n      uniform vec4 texsize_noise_hq;\n      uniform vec4 texsize_noise_lq_lite;\n      uniform vec4 texsize_noisevol_lq;\n      uniform vec4 texsize_noisevol_hq;\n\n      uniform float bass;\n      uniform float mid;\n      uniform float treb;\n      uniform float vol;\n      uniform float bass_att;\n      uniform float mid_att;\n      uniform float treb_att;\n      uniform float vol_att;\n\n      uniform float frame;\n      uniform float fps;\n\n      uniform vec4 _qa;\n      uniform vec4 _qb;\n      uniform vec4 _qc;\n      uniform vec4 _qd;\n      uniform vec4 _qe;\n      uniform vec4 _qf;\n      uniform vec4 _qg;\n      uniform vec4 _qh;\n\n      #define q1 _qa.x\n      #define q2 _qa.y\n      #define q3 _qa.z\n      #define q4 _qa.w\n      #define q5 _qb.x\n      #define q6 _qb.y\n      #define q7 _qb.z\n      #define q8 _qb.w\n      #define q9 _qc.x\n      #define q10 _qc.y\n      #define q11 _qc.z\n      #define q12 _qc.w\n      #define q13 _qd.x\n      #define q14 _qd.y\n      #define q15 _qd.z\n      #define q16 _qd.w\n      #define q17 _qe.x\n      #define q18 _qe.y\n      #define q19 _qe.z\n      #define q20 _qe.w\n      #define q21 _qf.x\n      #define q22 _qf.y\n      #define q23 _qf.z\n      #define q24 _qf.w\n      #define q25 _qg.x\n      #define q26 _qg.y\n      #define q27 _qg.z\n      #define q28 _qg.w\n      #define q29 _qh.x\n      #define q30 _qh.y\n      #define q31 _qh.z\n      #define q32 _qh.w\n\n      uniform vec4 slow_roam_cos;\n      uniform vec4 roam_cos;\n      uniform vec4 slow_roam_sin;\n      uniform vec4 roam_sin;\n\n      uniform float blur1_min;\n      uniform float blur1_max;\n      uniform float blur2_min;\n      uniform float blur2_max;\n      uniform float blur3_min;\n      uniform float blur3_max;\n\n      uniform float scale1;\n      uniform float scale2;\n      uniform float scale3;\n      uniform float bias1;\n      uniform float bias2;\n      uniform float bias3;\n\n      uniform vec4 rand_frame;\n      uniform vec4 rand_preset;\n\n      uniform float fShader;\n\n      float PI = ${Math.PI};\n\n      ${s}\n\n      void main(void) {\n        vec3 ret;\n        vec2 uv = vUv;\n        vec2 uv_orig = vUv;\n        uv.y = 1.0 - uv.y;\n        uv_orig.y = 1.0 - uv_orig.y;\n        float rad = length(uv - 0.5);\n        float ang = atan(uv.x - 0.5, uv.y - 0.5);\n        vec3 hue_shader = vColor.rgb;\n\n        ${e}\n\n        fragColor = vec4(ret, vColor.a);\n      }\n      `.trim()),this.gl.compileShader(r),this.gl.attachShader(this.shaderProgram,i),this.gl.attachShader(this.shaderProgram,r),this.gl.linkProgram(this.shaderProgram),this.positionLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.compColorLocation=this.gl.getAttribLocation(this.shaderProgram,"aCompColor"),this.textureLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_main"),this.textureFWLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_fw_main"),this.textureFCLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_fc_main"),this.texturePWLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_pw_main"),this.texturePCLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_pc_main"),this.blurTexture1Loc=this.gl.getUniformLocation(this.shaderProgram,"sampler_blur1"),this.blurTexture2Loc=this.gl.getUniformLocation(this.shaderProgram,"sampler_blur2"),this.blurTexture3Loc=this.gl.getUniformLocation(this.shaderProgram,"sampler_blur3"),this.noiseLQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noise_lq"),this.noiseMQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noise_mq"),this.noiseHQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noise_hq"),this.noiseLQLiteLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noise_lq_lite"),this.noisePointLQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_pw_noise_lq"),this.noiseVolLQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noisevol_lq"),this.noiseVolHQLoc=this.gl.getUniformLocation(this.shaderProgram,"sampler_noisevol_hq"),this.timeLoc=this.gl.getUniformLocation(this.shaderProgram,"time"),this.gammaAdjLoc=this.gl.getUniformLocation(this.shaderProgram,"gammaAdj"),this.echoZoomLoc=this.gl.getUniformLocation(this.shaderProgram,"echo_zoom"),this.echoAlphaLoc=this.gl.getUniformLocation(this.shaderProgram,"echo_alpha"),this.echoOrientationLoc=this.gl.getUniformLocation(this.shaderProgram,"echo_orientation"),this.invertLoc=this.gl.getUniformLocation(this.shaderProgram,"invert"),this.brightenLoc=this.gl.getUniformLocation(this.shaderProgram,"brighten"),this.darkenLoc=this.gl.getUniformLocation(this.shaderProgram,"darken"),this.solarizeLoc=this.gl.getUniformLocation(this.shaderProgram,"solarize"),this.texsizeLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize"),this.texsizeNoiseLQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noise_lq"),this.texsizeNoiseMQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noise_mq"),this.texsizeNoiseHQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noise_hq"),this.texsizeNoiseLQLiteLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noise_lq_lite"),this.texsizeNoiseVolLQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noisevol_lq"),this.texsizeNoiseVolHQLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize_noisevol_hq"),this.resolutionLoc=this.gl.getUniformLocation(this.shaderProgram,"resolution"),this.aspectLoc=this.gl.getUniformLocation(this.shaderProgram,"aspect"),this.bassLoc=this.gl.getUniformLocation(this.shaderProgram,"bass"),this.midLoc=this.gl.getUniformLocation(this.shaderProgram,"mid"),this.trebLoc=this.gl.getUniformLocation(this.shaderProgram,"treb"),this.volLoc=this.gl.getUniformLocation(this.shaderProgram,"vol"),this.bassAttLoc=this.gl.getUniformLocation(this.shaderProgram,"bass_att"),this.midAttLoc=this.gl.getUniformLocation(this.shaderProgram,"mid_att"),this.trebAttLoc=this.gl.getUniformLocation(this.shaderProgram,"treb_att"),this.volAttLoc=this.gl.getUniformLocation(this.shaderProgram,"vol_att"),this.frameLoc=this.gl.getUniformLocation(this.shaderProgram,"frame"),this.fpsLoc=this.gl.getUniformLocation(this.shaderProgram,"fps"),this.blur1MinLoc=this.gl.getUniformLocation(this.shaderProgram,"blur1_min"),this.blur1MaxLoc=this.gl.getUniformLocation(this.shaderProgram,"blur1_max"),this.blur2MinLoc=this.gl.getUniformLocation(this.shaderProgram,"blur2_min"),this.blur2MaxLoc=this.gl.getUniformLocation(this.shaderProgram,"blur2_max"),this.blur3MinLoc=this.gl.getUniformLocation(this.shaderProgram,"blur3_min"),this.blur3MaxLoc=this.gl.getUniformLocation(this.shaderProgram,"blur3_max"),this.scale1Loc=this.gl.getUniformLocation(this.shaderProgram,"scale1"),this.scale2Loc=this.gl.getUniformLocation(this.shaderProgram,"scale2"),this.scale3Loc=this.gl.getUniformLocation(this.shaderProgram,"scale3"),this.bias1Loc=this.gl.getUniformLocation(this.shaderProgram,"bias1"),this.bias2Loc=this.gl.getUniformLocation(this.shaderProgram,"bias2"),this.bias3Loc=this.gl.getUniformLocation(this.shaderProgram,"bias3"),this.randPresetLoc=this.gl.getUniformLocation(this.shaderProgram,"rand_preset"),this.randFrameLoc=this.gl.getUniformLocation(this.shaderProgram,"rand_frame"),this.fShaderLoc=this.gl.getUniformLocation(this.shaderProgram,"fShader"),this.qaLoc=this.gl.getUniformLocation(this.shaderProgram,"_qa"),this.qbLoc=this.gl.getUniformLocation(this.shaderProgram,"_qb"),this.qcLoc=this.gl.getUniformLocation(this.shaderProgram,"_qc"),this.qdLoc=this.gl.getUniformLocation(this.shaderProgram,"_qd"),this.qeLoc=this.gl.getUniformLocation(this.shaderProgram,"_qe"),this.qfLoc=this.gl.getUniformLocation(this.shaderProgram,"_qf"),this.qgLoc=this.gl.getUniformLocation(this.shaderProgram,"_qg"),this.qhLoc=this.gl.getUniformLocation(this.shaderProgram,"_qh"),this.slowRoamCosLoc=this.gl.getUniformLocation(this.shaderProgram,"slow_roam_cos"),this.roamCosLoc=this.gl.getUniformLocation(this.shaderProgram,"roam_cos"),this.slowRoamSinLoc=this.gl.getUniformLocation(this.shaderProgram,"slow_roam_sin"),this.roamSinLoc=this.gl.getUniformLocation(this.shaderProgram,"roam_sin");for(let t=0;t<this.userTextures.length;t++){const e=this.userTextures[t];e.textureLoc=this.gl.getUniformLocation(this.shaderProgram,`sampler_${e.sampler}`)}}updateShader(t){this.createShader(t)}bindBlurVals(t,e){const s=t[0],i=t[1],r=t[2],a=e[0],o=e[1],n=e[2],h=a-s,l=s,A=o-i,c=i,g=n-r,m=r;this.gl.uniform1f(this.blur1MinLoc,s),this.gl.uniform1f(this.blur1MaxLoc,a),this.gl.uniform1f(this.blur2MinLoc,i),this.gl.uniform1f(this.blur2MaxLoc,o),this.gl.uniform1f(this.blur3MinLoc,r),this.gl.uniform1f(this.blur3MaxLoc,n),this.gl.uniform1f(this.scale1Loc,h),this.gl.uniform1f(this.scale2Loc,A),this.gl.uniform1f(this.scale3Loc,g),this.gl.uniform1f(this.bias1Loc,l),this.gl.uniform1f(this.bias2Loc,c),this.gl.uniform1f(this.bias3Loc,m)}static generateHueBase(t){const e=new Float32Array([1,1,1,1,1,1,1,1,1,1,1,1]);for(let s=0;s<4;s++){e[3*s+0]=.6+.3*Math.sin(30*t.time*.0143+3+21*s+t.rand_start[3]),e[3*s+1]=.6+.3*Math.sin(30*t.time*.0107+1+13*s+t.rand_start[1]),e[3*s+2]=.6+.3*Math.sin(30*t.time*.0129+6+9*s+t.rand_start[2]);const i=Math.max(e[3*s],e[3*s+1],e[3*s+2]);for(let t=0;t<3;t++)e[3*s+t]=e[3*s+t]/i,e[3*s+t]=.5+.5*e[3*s+t]}return e}generateCompColors(t,e,s){const i=zt.generateHueBase(e),r=this.compWidth+1,a=this.compHeight+1,o=new Float32Array(r*a*4);let n=0;for(let e=0;e<a;e++)for(let a=0;a<r;a++){let r=a/this.compWidth,h=e/this.compHeight;const l=[1,1,1];for(let t=0;t<3;t++)l[t]=i[0+t]*r*h+i[3+t]*(1-r)*h+i[6+t]*r*(1-h)+i[9+t]*(1-r)*(1-h);let A=1;if(t){r*=this.mesh_width+1,h*=this.mesh_height+1,r=Math.clamp(r,0,this.mesh_width-1),h=Math.clamp(h,0,this.mesh_height-1);const t=Math.floor(r),e=Math.floor(h),i=r-t,a=h-e;A=s[4*(e*(this.mesh_width+1)+t)+3]*(1-i)*(1-a)+s[4*(e*(this.mesh_width+1)+(t+1))+3]*i*(1-a)+s[4*((e+1)*(this.mesh_width+1)+t)+3]*(1-i)*a+s[4*((e+1)*(this.mesh_width+1)+(t+1))+3]*i*a}o[n+0]=l[0],o[n+1]=l[1],o[n+2]=l[2],o[n+3]=A,n+=4}return o}renderQuadTexture(t,e,s,i,r,a,o,n,h,l){const A=this.generateCompColors(t,n,l);this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuf),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.indices,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.positionLocation,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.compColorVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,A,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.compColorLocation,4,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.compColorLocation);const c=0!==n.wrap?this.gl.REPEAT:this.gl.CLAMP_TO_EDGE;this.gl.samplerParameteri(this.mainSampler,this.gl.TEXTURE_WRAP_S,c),this.gl.samplerParameteri(this.mainSampler,this.gl.TEXTURE_WRAP_T,c),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(0,this.mainSampler),this.gl.uniform1i(this.textureLoc,0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(1,this.mainSamplerFW),this.gl.uniform1i(this.textureFWLoc,1),this.gl.activeTexture(this.gl.TEXTURE2),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(2,this.mainSamplerFC),this.gl.uniform1i(this.textureFCLoc,2),this.gl.activeTexture(this.gl.TEXTURE3),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(3,this.mainSamplerPW),this.gl.uniform1i(this.texturePWLoc,3),this.gl.activeTexture(this.gl.TEXTURE4),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.bindSampler(4,this.mainSamplerPC),this.gl.uniform1i(this.texturePCLoc,4),this.gl.activeTexture(this.gl.TEXTURE5),this.gl.bindTexture(this.gl.TEXTURE_2D,s),this.gl.uniform1i(this.blurTexture1Loc,5),this.gl.activeTexture(this.gl.TEXTURE6),this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.uniform1i(this.blurTexture2Loc,6),this.gl.activeTexture(this.gl.TEXTURE7),this.gl.bindTexture(this.gl.TEXTURE_2D,r),this.gl.uniform1i(this.blurTexture3Loc,7),this.gl.activeTexture(this.gl.TEXTURE8),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexLQ),this.gl.uniform1i(this.noiseLQLoc,8),this.gl.activeTexture(this.gl.TEXTURE9),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexMQ),this.gl.uniform1i(this.noiseMQLoc,9),this.gl.activeTexture(this.gl.TEXTURE10),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexHQ),this.gl.uniform1i(this.noiseHQLoc,10),this.gl.activeTexture(this.gl.TEXTURE11),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexLQLite),this.gl.uniform1i(this.noiseLQLiteLoc,11),this.gl.activeTexture(this.gl.TEXTURE12),this.gl.bindTexture(this.gl.TEXTURE_2D,this.noise.noiseTexLQ),this.gl.bindSampler(12,this.noise.noiseTexPointLQ),this.gl.uniform1i(this.noisePointLQLoc,12),this.gl.activeTexture(this.gl.TEXTURE13),this.gl.bindTexture(this.gl.TEXTURE_3D,this.noise.noiseTexVolLQ),this.gl.uniform1i(this.noiseVolLQLoc,13),this.gl.activeTexture(this.gl.TEXTURE14),this.gl.bindTexture(this.gl.TEXTURE_3D,this.noise.noiseTexVolHQ),this.gl.uniform1i(this.noiseVolHQLoc,14);for(let t=0;t<this.userTextures.length;t++){const e=this.userTextures[t];this.gl.activeTexture(this.gl.TEXTURE15+t),this.gl.bindTexture(this.gl.TEXTURE_2D,this.image.getTexture(e.sampler)),this.gl.uniform1i(e.textureLoc,15+t)}this.gl.uniform1f(this.timeLoc,n.time),this.gl.uniform1f(this.gammaAdjLoc,n.gammaadj),this.gl.uniform1f(this.echoZoomLoc,n.echo_zoom),this.gl.uniform1f(this.echoAlphaLoc,n.echo_alpha),this.gl.uniform1f(this.echoOrientationLoc,n.echo_orient),this.gl.uniform1i(this.invertLoc,n.invert),this.gl.uniform1i(this.brightenLoc,n.brighten),this.gl.uniform1i(this.darkenLoc,n.darken),this.gl.uniform1i(this.solarizeLoc,n.solarize),this.gl.uniform2fv(this.resolutionLoc,[this.texsizeX,this.texsizeY]),this.gl.uniform4fv(this.aspectLoc,[this.aspectx,this.aspecty,this.invAspectx,this.invAspecty]),this.gl.uniform4fv(this.texsizeLoc,new Float32Array([this.texsizeX,this.texsizeY,1/this.texsizeX,1/this.texsizeY])),this.gl.uniform4fv(this.texsizeNoiseLQLoc,[256,256,1/256,1/256]),this.gl.uniform4fv(this.texsizeNoiseMQLoc,[256,256,1/256,1/256]),this.gl.uniform4fv(this.texsizeNoiseHQLoc,[256,256,1/256,1/256]),this.gl.uniform4fv(this.texsizeNoiseLQLiteLoc,[32,32,1/32,1/32]),this.gl.uniform4fv(this.texsizeNoiseVolLQLoc,[32,32,1/32,1/32]),this.gl.uniform4fv(this.texsizeNoiseVolHQLoc,[32,32,1/32,1/32]),this.gl.uniform1f(this.bassLoc,n.bass),this.gl.uniform1f(this.midLoc,n.mid),this.gl.uniform1f(this.trebLoc,n.treb),this.gl.uniform1f(this.volLoc,(n.bass+n.mid+n.treb)/3),this.gl.uniform1f(this.bassAttLoc,n.bass_att),this.gl.uniform1f(this.midAttLoc,n.mid_att),this.gl.uniform1f(this.trebAttLoc,n.treb_att),this.gl.uniform1f(this.volAttLoc,(n.bass_att+n.mid_att+n.treb_att)/3),this.gl.uniform1f(this.frameLoc,n.frame),this.gl.uniform1f(this.fpsLoc,n.fps),this.gl.uniform4fv(this.randPresetLoc,n.rand_preset),this.gl.uniform4fv(this.randFrameLoc,new Float32Array([this.rng.random(),this.rng.random(),this.rng.random(),this.rng.random()])),this.gl.uniform1f(this.fShaderLoc,n.fshader),this.gl.uniform4fv(this.qaLoc,new Float32Array([h.q1||0,h.q2||0,h.q3||0,h.q4||0])),this.gl.uniform4fv(this.qbLoc,new Float32Array([h.q5||0,h.q6||0,h.q7||0,h.q8||0])),this.gl.uniform4fv(this.qcLoc,new Float32Array([h.q9||0,h.q10||0,h.q11||0,h.q12||0])),this.gl.uniform4fv(this.qdLoc,new Float32Array([h.q13||0,h.q14||0,h.q15||0,h.q16||0])),this.gl.uniform4fv(this.qeLoc,new Float32Array([h.q17||0,h.q18||0,h.q19||0,h.q20||0])),this.gl.uniform4fv(this.qfLoc,new Float32Array([h.q21||0,h.q22||0,h.q23||0,h.q24||0])),this.gl.uniform4fv(this.qgLoc,new Float32Array([h.q25||0,h.q26||0,h.q27||0,h.q28||0])),this.gl.uniform4fv(this.qhLoc,new Float32Array([h.q29||0,h.q30||0,h.q31||0,h.q32||0])),this.gl.uniform4fv(this.slowRoamCosLoc,[.5+.5*Math.cos(.005*n.time),.5+.5*Math.cos(.008*n.time),.5+.5*Math.cos(.013*n.time),.5+.5*Math.cos(.022*n.time)]),this.gl.uniform4fv(this.roamCosLoc,[.5+.5*Math.cos(.3*n.time),.5+.5*Math.cos(1.3*n.time),.5+.5*Math.cos(5*n.time),.5+.5*Math.cos(20*n.time)]),this.gl.uniform4fv(this.slowRoamSinLoc,[.5+.5*Math.sin(.005*n.time),.5+.5*Math.sin(.008*n.time),.5+.5*Math.sin(.013*n.time),.5+.5*Math.sin(.022*n.time)]),this.gl.uniform4fv(this.roamSinLoc,[.5+.5*Math.sin(.3*n.time),.5+.5*Math.sin(1.3*n.time),.5+.5*Math.sin(5*n.time),.5+.5*Math.sin(20*n.time)]),this.bindBlurVals(a,o),t?this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA):this.gl.disable(this.gl.BLEND),this.gl.drawElements(this.gl.TRIANGLES,this.indices.length,this.gl.UNSIGNED_SHORT,0),t||this.gl.enable(this.gl.BLEND)}}class Nt{constructor(t,e){this.gl=t,this.textureRatio=e.textureRatio,this.texsizeX=e.texsizeX,this.texsizeY=e.texsizeY,this.positions=new Float32Array([-1,-1,1,-1,-1,1,1,1]),this.vertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.useFXAA()?this.createFXAAShader():this.createShader()}useFXAA(){return this.textureRatio<=1}updateGlobals(t){this.textureRatio=t.textureRatio,this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.gl.deleteProgram(this.shaderProgram),this.useFXAA()?this.createFXAAShader():this.createShader()}createFXAAShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"#version 300 es\n       const vec2 halfmad = vec2(0.5);\n       in vec2 aPos;\n       out vec2 v_rgbM;\n       out vec2 v_rgbNW;\n       out vec2 v_rgbNE;\n       out vec2 v_rgbSW;\n       out vec2 v_rgbSE;\n       uniform vec4 texsize;\n       void main(void) {\n         gl_Position = vec4(aPos, 0.0, 1.0);\n\n         v_rgbM = aPos * halfmad + halfmad;\n         v_rgbNW = v_rgbM + (vec2(-1.0, -1.0) * texsize.zx);\n         v_rgbNE = v_rgbM + (vec2(1.0, -1.0) * texsize.zx);\n         v_rgbSW = v_rgbM + (vec2(-1.0, 1.0) * texsize.zx);\n         v_rgbSE = v_rgbM + (vec2(1.0, 1.0) * texsize.zx);\n       }"),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`#version 300 es\n       precision ${this.floatPrecision} float;\n       precision highp int;\n       precision mediump sampler2D;\n\n       in vec2 v_rgbM;\n       in vec2 v_rgbNW;\n       in vec2 v_rgbNE;\n       in vec2 v_rgbSW;\n       in vec2 v_rgbSE;\n       out vec4 fragColor;\n       uniform vec4 texsize;\n       uniform sampler2D uTexture;\n\n       #ifndef FXAA_REDUCE_MIN\n         #define FXAA_REDUCE_MIN   (1.0/ 128.0)\n       #endif\n       #ifndef FXAA_REDUCE_MUL\n         #define FXAA_REDUCE_MUL   (1.0 / 8.0)\n       #endif\n       #ifndef FXAA_SPAN_MAX\n         #define FXAA_SPAN_MAX     8.0\n       #endif\n\n       void main(void) {\n         vec4 color;\n         vec3 rgbNW = textureLod(uTexture, v_rgbNW, 0.0).xyz;\n         vec3 rgbNE = textureLod(uTexture, v_rgbNE, 0.0).xyz;\n         vec3 rgbSW = textureLod(uTexture, v_rgbSW, 0.0).xyz;\n         vec3 rgbSE = textureLod(uTexture, v_rgbSE, 0.0).xyz;\n         vec3 rgbM  = textureLod(uTexture, v_rgbM, 0.0).xyz;\n         vec3 luma = vec3(0.299, 0.587, 0.114);\n         float lumaNW = dot(rgbNW, luma);\n         float lumaNE = dot(rgbNE, luma);\n         float lumaSW = dot(rgbSW, luma);\n         float lumaSE = dot(rgbSE, luma);\n         float lumaM  = dot(rgbM,  luma);\n         float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n         float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\n         mediump vec2 dir;\n         dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n         dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\n         float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n                               (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\n         float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n         dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n                   max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n                   dir * rcpDirMin)) * texsize.zw;\n\n         vec3 rgbA = 0.5 * (\n             textureLod(uTexture, v_rgbM + dir * (1.0 / 3.0 - 0.5), 0.0).xyz +\n             textureLod(uTexture, v_rgbM + dir * (2.0 / 3.0 - 0.5), 0.0).xyz);\n         vec3 rgbB = rgbA * 0.5 + 0.25 * (\n             textureLod(uTexture, v_rgbM + dir * -0.5, 0.0).xyz +\n             textureLod(uTexture, v_rgbM + dir * 0.5, 0.0).xyz);\n\n         float lumaB = dot(rgbB, luma);\n         if ((lumaB < lumaMin) || (lumaB > lumaMax))\n           color = vec4(rgbA, 1.0);\n         else\n           color = vec4(rgbB, 1.0);\n\n         fragColor = color;\n       }`),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.positionLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.textureLoc=this.gl.getUniformLocation(this.shaderProgram,"uTexture"),this.texsizeLoc=this.gl.getUniformLocation(this.shaderProgram,"texsize")}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"#version 300 es\n       const vec2 halfmad = vec2(0.5);\n       in vec2 aPos;\n       out vec2 uv;\n       void main(void) {\n         gl_Position = vec4(aPos, 0.0, 1.0);\n         uv = aPos * halfmad + halfmad;\n       }"),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`#version 300 es\n       precision ${this.floatPrecision} float;\n       precision highp int;\n       precision mediump sampler2D;\n\n       in vec2 uv;\n       out vec4 fragColor;\n       uniform sampler2D uTexture;\n\n       void main(void) {\n         fragColor = vec4(texture(uTexture, uv).rgb, 1.0);\n       }`),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.positionLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.textureLoc=this.gl.getUniformLocation(this.shaderProgram,"uTexture")}renderQuadTexture(t){this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.positions,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.positionLocation,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.uniform1i(this.textureLoc,0),this.useFXAA()&&this.gl.uniform4fv(this.texsizeLoc,new Float32Array([this.texsizeX,this.texsizeY,1/this.texsizeX,1/this.texsizeY])),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}class Xt{constructor(t){this.gl=t,this.positions=new Float32Array([-1,-1,1,-1,-1,1,1,1]),this.vertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader()}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"#version 300 es\n       const vec2 halfmad = vec2(0.5);\n       in vec2 aPos;\n       out vec2 uv;\n       void main(void) {\n         gl_Position = vec4(aPos, 0.0, 1.0);\n         uv = aPos * halfmad + halfmad;\n       }"),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`#version 300 es\n       precision ${this.floatPrecision} float;\n       precision highp int;\n       precision mediump sampler2D;\n\n       in vec2 uv;\n       out vec4 fragColor;\n       uniform sampler2D uTexture;\n\n       void main(void) {\n         fragColor = vec4(texture(uTexture, uv).rgb, 1.0);\n       }`),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.positionLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.textureLoc=this.gl.getUniformLocation(this.shaderProgram,"uTexture")}renderQuadTexture(t){this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.positions,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.positionLocation,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.uniform1i(this.textureLoc,0),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}class Gt{constructor(t,e){this.gl=t,this.blurLevel=e;const s=[4,3.8,3.5,2.9,1.9,1.2,.7,.3],i=s[0]+s[1]+s[2]+s[3],r=s[4]+s[5]+s[6]+s[7],a=0+(s[2]+s[3])/i*2,o=2+(s[6]+s[7])/r*2;this.wds=new Float32Array([i,r,a,o]),this.wDiv=1/(2*(i+r)),this.positions=new Float32Array([-1,-1,1,-1,-1,1,1,1]),this.vertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader()}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"\n      #version 300 es\n      const vec2 halfmad = vec2(0.5);\n      in vec2 aPos;\n      out vec2 uv;\n      void main(void) {\n        gl_Position = vec4(aPos, 0.0, 1.0);\n        uv = aPos * halfmad + halfmad;\n      }\n      ".trim()),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`#version 300 es\n       precision ${this.floatPrecision} float;\n       precision highp int;\n       precision mediump sampler2D;\n\n       in vec2 uv;\n       out vec4 fragColor;\n       uniform sampler2D uTexture;\n       uniform vec4 texsize;\n       uniform float ed1;\n       uniform float ed2;\n       uniform float ed3;\n       uniform vec4 wds;\n       uniform float wdiv;\n\n       void main(void) {\n         float w1 = wds[0];\n         float w2 = wds[1];\n         float d1 = wds[2];\n         float d2 = wds[3];\n\n         vec2 uv2 = uv.xy;\n\n         vec3 blur =\n           ( texture(uTexture, uv2 + vec2(0.0, d1 * texsize.w) ).xyz\n           + texture(uTexture, uv2 + vec2(0.0,-d1 * texsize.w) ).xyz) * w1 +\n           ( texture(uTexture, uv2 + vec2(0.0, d2 * texsize.w) ).xyz\n           + texture(uTexture, uv2 + vec2(0.0,-d2 * texsize.w) ).xyz) * w2;\n\n         blur.xyz *= wdiv;\n\n         float t = min(min(uv.x, uv.y), 1.0 - max(uv.x, uv.y));\n         t = sqrt(t);\n         t = ed1 + ed2 * clamp(t * ed3, 0.0, 1.0);\n         blur.xyz *= t;\n\n         fragColor = vec4(blur, 1.0);\n       }`),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.positionLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.textureLoc=this.gl.getUniformLocation(this.shaderProgram,"uTexture"),this.texsizeLocation=this.gl.getUniformLocation(this.shaderProgram,"texsize"),this.ed1Loc=this.gl.getUniformLocation(this.shaderProgram,"ed1"),this.ed2Loc=this.gl.getUniformLocation(this.shaderProgram,"ed2"),this.ed3Loc=this.gl.getUniformLocation(this.shaderProgram,"ed3"),this.wdsLocation=this.gl.getUniformLocation(this.shaderProgram,"wds"),this.wdivLoc=this.gl.getUniformLocation(this.shaderProgram,"wdiv")}renderQuadTexture(t,e,s){this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.positions,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.positionLocation,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.uniform1i(this.textureLoc,0);const i=0===this.blurLevel?e.b1ed:0;this.gl.uniform4fv(this.texsizeLocation,[s[0],s[1],1/s[0],1/s[1]]),this.gl.uniform1f(this.ed1Loc,1-i),this.gl.uniform1f(this.ed2Loc,i),this.gl.uniform1f(this.ed3Loc,5),this.gl.uniform4fv(this.wdsLocation,this.wds),this.gl.uniform1f(this.wdivLoc,this.wDiv),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}class Ot{constructor(t,e){this.gl=t,this.blurLevel=e;const s=[4,3.8,3.5,2.9,1.9,1.2,.7,.3],i=s[0]+s[1],r=s[2]+s[3],a=s[4]+s[5],o=s[6]+s[7],n=0+2*s[1]/i,h=2+2*s[3]/r,l=4+2*s[5]/a,A=6+2*s[7]/o;this.ws=new Float32Array([i,r,a,o]),this.ds=new Float32Array([n,h,l,A]),this.wDiv=.5/(i+r+a+o),this.positions=new Float32Array([-1,-1,1,-1,-1,1,1,1]),this.vertexBuf=this.gl.createBuffer(),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader()}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"\n      #version 300 es\n      const vec2 halfmad = vec2(0.5);\n      in vec2 aPos;\n      out vec2 uv;\n      void main(void) {\n        gl_Position = vec4(aPos, 0.0, 1.0);\n        uv = aPos * halfmad + halfmad;\n      }\n      ".trim()),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`#version 300 es\n       precision ${this.floatPrecision} float;\n       precision highp int;\n       precision mediump sampler2D;\n\n       in vec2 uv;\n       out vec4 fragColor;\n       uniform sampler2D uTexture;\n       uniform vec4 texsize;\n       uniform float scale;\n       uniform float bias;\n       uniform vec4 ws;\n       uniform vec4 ds;\n       uniform float wdiv;\n\n       void main(void) {\n         float w1 = ws[0];\n         float w2 = ws[1];\n         float w3 = ws[2];\n         float w4 = ws[3];\n         float d1 = ds[0];\n         float d2 = ds[1];\n         float d3 = ds[2];\n         float d4 = ds[3];\n\n         vec2 uv2 = uv.xy;\n\n         vec3 blur =\n           ( texture(uTexture, uv2 + vec2( d1 * texsize.z,0.0) ).xyz\n           + texture(uTexture, uv2 + vec2(-d1 * texsize.z,0.0) ).xyz) * w1 +\n           ( texture(uTexture, uv2 + vec2( d2 * texsize.z,0.0) ).xyz\n           + texture(uTexture, uv2 + vec2(-d2 * texsize.z,0.0) ).xyz) * w2 +\n           ( texture(uTexture, uv2 + vec2( d3 * texsize.z,0.0) ).xyz\n           + texture(uTexture, uv2 + vec2(-d3 * texsize.z,0.0) ).xyz) * w3 +\n           ( texture(uTexture, uv2 + vec2( d4 * texsize.z,0.0) ).xyz\n           + texture(uTexture, uv2 + vec2(-d4 * texsize.z,0.0) ).xyz) * w4;\n\n         blur.xyz *= wdiv;\n         blur.xyz = blur.xyz * scale + bias;\n\n         fragColor = vec4(blur, 1.0);\n       }`),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.positionLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.textureLoc=this.gl.getUniformLocation(this.shaderProgram,"uTexture"),this.texsizeLocation=this.gl.getUniformLocation(this.shaderProgram,"texsize"),this.scaleLoc=this.gl.getUniformLocation(this.shaderProgram,"scale"),this.biasLoc=this.gl.getUniformLocation(this.shaderProgram,"bias"),this.wsLoc=this.gl.getUniformLocation(this.shaderProgram,"ws"),this.dsLocation=this.gl.getUniformLocation(this.shaderProgram,"ds"),this.wdivLoc=this.gl.getUniformLocation(this.shaderProgram,"wdiv")}getScaleAndBias(t,e){const s=[1,1,1],i=[0,0,0];let r,a;return s[0]=1/(e[0]-t[0]),i[0]=-t[0]*s[0],r=(t[1]-t[0])/(e[0]-t[0]),a=(e[1]-t[0])/(e[0]-t[0]),s[1]=1/(a-r),i[1]=-r*s[1],r=(t[2]-t[1])/(e[1]-t[1]),a=(e[2]-t[1])/(e[1]-t[1]),s[2]=1/(a-r),i[2]=-r*s[2],{scale:s[this.blurLevel],bias:i[this.blurLevel]}}renderQuadTexture(t,e,s,i,r){this.gl.useProgram(this.shaderProgram),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.positions,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.positionLocation,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.uniform1i(this.textureLoc,0);const{scale:a,bias:o}=this.getScaleAndBias(s,i);this.gl.uniform4fv(this.texsizeLocation,[r[0],r[1],1/r[0],1/r[1]]),this.gl.uniform1f(this.scaleLoc,a),this.gl.uniform1f(this.biasLoc,o),this.gl.uniform4fv(this.wsLoc,this.ws),this.gl.uniform4fv(this.dsLocation,this.ds),this.gl.uniform1f(this.wdivLoc,this.wDiv),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}}class Wt{constructor(t,e,s,i={}){this.blurLevel=t,this.blurRatios=e,this.gl=s,this.texsizeX=i.texsizeX,this.texsizeY=i.texsizeY,this.anisoExt=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.blurHorizontalFrameBuffer=this.gl.createFramebuffer(),this.blurVerticalFrameBuffer=this.gl.createFramebuffer(),this.blurHorizontalTexture=this.gl.createTexture(),this.blurVerticalTexture=this.gl.createTexture(),this.setupFrameBufferTextures(),this.blurHorizontal=new Ot(s,this.blurLevel,i),this.blurVertical=new Gt(s,this.blurLevel,i)}updateGlobals(t){this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.setupFrameBufferTextures()}getTextureSize(t){let e=Math.max(this.texsizeX*t,16);e=16*Math.floor((e+3)/16);let s=Math.max(this.texsizeY*t,16);return s=4*Math.floor((s+3)/4),[e,s]}setupFrameBufferTextures(){const t=this.blurLevel>0?this.blurRatios[this.blurLevel-1]:[1,1],e=this.blurRatios[this.blurLevel],s=this.getTextureSize(t[1]),i=this.getTextureSize(e[0]);this.bindFrameBufferTexture(this.blurHorizontalFrameBuffer,this.blurHorizontalTexture,i);const r=i,a=this.getTextureSize(e[1]);this.bindFrameBufferTexture(this.blurVerticalFrameBuffer,this.blurVerticalTexture,a),this.horizontalTexsizes=[s,i],this.verticalTexsizes=[r,a]}bindFrambufferAndSetViewport(t,e){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.viewport(0,0,e[0],e[1])}bindFrameBufferTexture(t,e,s){if(this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,s[0],s[1],0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,new Uint8Array(s[0]*s[1]*4)),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.anisoExt){const t=this.gl.getParameter(this.anisoExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.gl.texParameterf(this.gl.TEXTURE_2D,this.anisoExt.TEXTURE_MAX_ANISOTROPY_EXT,t)}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,e,0)}renderBlurTexture(t,e,s,i){this.bindFrambufferAndSetViewport(this.blurHorizontalFrameBuffer,this.horizontalTexsizes[1]),this.blurHorizontal.renderQuadTexture(t,e,s,i,this.horizontalTexsizes[0]),this.gl.bindTexture(this.gl.TEXTURE_2D,this.blurHorizontalTexture),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.bindFrambufferAndSetViewport(this.blurVerticalFrameBuffer,this.verticalTexsizes[1]),this.blurVertical.renderQuadTexture(this.blurHorizontalTexture,e,this.verticalTexsizes[0]),this.gl.bindTexture(this.gl.TEXTURE_2D,this.blurVerticalTexture),this.gl.generateMipmap(this.gl.TEXTURE_2D)}}class Yt{constructor(t,e={}){this.gl=t,this.texsizeX=e.texsizeX,this.texsizeY=e.texsizeY,this.aspectx=e.aspectx,this.aspecty=e.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.buildPositions(),this.textTexture=this.gl.createTexture(),this.indexBuf=t.createBuffer(),this.positionVertexBuf=this.gl.createBuffer(),this.vertexBuf=this.gl.createBuffer(),this.canvas=document.createElement("canvas"),this.canvas.width=this.texsizeX,this.canvas.height=this.texsizeY,this.context2D=this.canvas.getContext("2d",{willReadFrequently:!1}),this.floatPrecision=Lt.getFragmentFloatPrecision(this.gl),this.createShader()}generateTitleTexture(t){this.context2D.clearRect(0,0,this.texsizeX,this.texsizeY),this.fontSize=Math.floor(this.texsizeX/256*16),this.fontSize=Math.max(this.fontSize,6),this.context2D.font=`italic ${this.fontSize}px Times New Roman`;let e=t,s=this.context2D.measureText(e).width;if(s>this.texsizeX){const t=this.texsizeX/s*.91;e=`${e.substring(0,Math.floor(e.length*t))}...`,s=this.context2D.measureText(e).width}this.context2D.fillStyle="#FFFFFF",this.context2D.fillText(e,(this.texsizeX-s)/2,this.texsizeY/2);const i=new Uint8Array(this.context2D.getImageData(0,0,this.texsizeX,this.texsizeY).data.buffer);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.textTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.texsizeX,this.texsizeY,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}updateGlobals(t){this.texsizeX=t.texsizeX,this.texsizeY=t.texsizeY,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.canvas.width=this.texsizeX,this.canvas.height=this.texsizeY}buildPositions(){const t=2/15,e=2/7,s=[];for(let i=0;i<8;i++){const r=i*e-1;for(let e=0;e<16;e++){const i=e*t-1;s.push(i,-r,0)}}const i=[];for(let t=0;t<7;t++)for(let e=0;e<15;e++){const s=e+16*t,r=e+16*(t+1),a=e+1+16*(t+1),o=e+1+16*t;i.push(s,r,o),i.push(r,a,o)}this.vertices=new Float32Array(s),this.indices=new Uint16Array(i)}createShader(){this.shaderProgram=this.gl.createProgram();const t=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(t,"#version 300 es\n       const vec2 halfmad = vec2(0.5);\n       in vec2 aPos;\n       in vec2 aUv;\n       out vec2 uv_orig;\n       out vec2 uv;\n       void main(void) {\n         gl_Position = vec4(aPos, 0.0, 1.0);\n         uv_orig = aPos * halfmad + halfmad;\n         uv = aUv;\n       }"),this.gl.compileShader(t);const e=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(e,`#version 300 es\n       precision ${this.floatPrecision} float;\n       precision highp int;\n       precision mediump sampler2D;\n\n       in vec2 uv_orig;\n       in vec2 uv;\n       out vec4 fragColor;\n       uniform sampler2D uTexture;\n       uniform float textColor;\n\n       void main(void) {\n         fragColor = texture(uTexture, uv) * vec4(textColor);\n       }`),this.gl.compileShader(e),this.gl.attachShader(this.shaderProgram,t),this.gl.attachShader(this.shaderProgram,e),this.gl.linkProgram(this.shaderProgram),this.positionLocation=this.gl.getAttribLocation(this.shaderProgram,"aPos"),this.uvLocation=this.gl.getAttribLocation(this.shaderProgram,"aUv"),this.textureLoc=this.gl.getUniformLocation(this.shaderProgram,"uTexture"),this.textColorLoc=this.gl.getUniformLocation(this.shaderProgram,"textColor")}generateUvs(t,e,s){const i=[];for(let s=0;s<8;s++)for(let r=0;r<16;r++){const a=2*(r/15)-1;let o=2*(.75*(s/7-.5)+.5)-1;t>=1&&(o+=1/this.texsizeY),i.push(a,e?o:-o)}const r=Math.max(0,1-1.5*t)**1.8*1.3;for(let t=0;t<8;t++)for(let e=0;e<16;e++){const a=16*t+e;i[a]+=.07*r*Math.sin(.31*s.time+.39*i[a]-1.94*i[a+1]),i[a]+=.044*r*Math.sin(.81*s.time-1.91*i[a]+.27*i[a+1]),i[a]+=.061*r*Math.sin(1.31*s.time+.61*i[a]+.74*i[a+1]),i[a+1]+=.061*r*Math.sin(.37*s.time+1.83*i[a]+.69*i[a+1]),i[a+1]+=.07*r*Math.sin(.67*s.time+.42*i[a]-1.39*i[a+1]),i[a+1]+=.087*r*Math.sin(1.07*s.time+3.55*i[a]+.89*i[a+1])}const a=1.01/(t**.21+.01);for(let t=0;t<i.length/2;t++)i[2*t]*=a,i[2*t+1]*=a*this.invAspecty,i[2*t]=(i[2*t]+1)/2,i[2*t+1]=(i[2*t+1]+1)/2;return new Float32Array(i)}renderTitle(t,e,s){this.gl.useProgram(this.shaderProgram);const i=this.generateUvs(t,e,s);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuf),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.indices,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionVertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.positionLocation,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuf),this.gl.bufferData(this.gl.ARRAY_BUFFER,i,this.gl.STATIC_DRAW),this.gl.vertexAttribPointer(this.uvLocation,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.uvLocation),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.textTexture),this.gl.uniform1i(this.textureLoc,0),this.gl.uniform1f(this.textColorLoc,t**.3),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawElements(this.gl.TRIANGLES,this.indices.length,this.gl.UNSIGNED_SHORT,0)}}class Ht{constructor(t){this.rng=St(),this.mesh_width=t.mesh_width,this.mesh_height=t.mesh_height,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.vertInfoA=new Float32Array((this.mesh_width+1)*(this.mesh_height+1)),this.vertInfoC=new Float32Array((this.mesh_width+1)*(this.mesh_height+1)),this.createBlendPattern()}static resizeMatrixValues(t,e,s,i,r){const a=new Float32Array((i+1)*(r+1));let o=0;for(let n=0;n<r+1;n++)for(let h=0;h<i+1;h++){let l=h/r,A=n/i;l*=e+1,A*=s+1,l=Math.clamp(l,0,e-1),A=Math.clamp(A,0,s-1);const c=Math.floor(l),g=Math.floor(A),m=l-c,u=A-g,d=t[g*(e+1)+c],f=t[g*(e+1)+(c+1)],p=t[(g+1)*(e+1)+c],b=t[(g+1)*(e+1)+(c+1)];a[o]=d*(1-m)*(1-u)+f*m*(1-u)+p*(1-m)*u+b*m*u,o+=1}return a}updateGlobals(t){const e=this.mesh_width,s=this.mesh_height;this.mesh_width=t.mesh_width,this.mesh_height=t.mesh_height,this.aspectx=t.aspectx,this.aspecty=t.aspecty,this.mesh_width===e&&this.mesh_height===s||(this.vertInfoA=Ht.resizeMatrixValues(this.vertInfoA,e,s,this.mesh_width,this.mesh_height),this.vertInfoC=Ht.resizeMatrixValues(this.vertInfoC,e,s,this.mesh_width,this.mesh_height))}genPlasma(t,e,s,i,r){const a=Math.floor((t+e)/2),o=Math.floor((s+i)/2);let n=this.vertInfoC[s*(this.mesh_width+1)+t],h=this.vertInfoC[s*(this.mesh_width+1)+e],l=this.vertInfoC[i*(this.mesh_width+1)+t],A=this.vertInfoC[i*(this.mesh_width+1)+e];i-s>=2&&(0===t&&(this.vertInfoC[o*(this.mesh_width+1)+t]=.5*(n+l)+(2*this.rng.random()-1)*r*this.aspecty),this.vertInfoC[o*(this.mesh_width+1)+e]=.5*(h+A)+(2*this.rng.random()-1)*r*this.aspecty),e-t>=2&&(0===s&&(this.vertInfoC[s*(this.mesh_width+1)+a]=.5*(n+h)+(2*this.rng.random()-1)*r*this.aspectx),this.vertInfoC[i*(this.mesh_width+1)+a]=.5*(l+A)+(2*this.rng.random()-1)*r*this.aspectx),i-s>=2&&e-t>=2&&(n=this.vertInfoC[o*(this.mesh_width+1)+t],h=this.vertInfoC[o*(this.mesh_width+1)+e],l=this.vertInfoC[s*(this.mesh_width+1)+a],A=this.vertInfoC[i*(this.mesh_width+1)+a],this.vertInfoC[o*(this.mesh_width+1)+a]=.25*(l+A+n+h)+(2*this.rng.random()-1)*r,this.genPlasma(t,a,s,o,.5*r),this.genPlasma(a,e,s,o,.5*r),this.genPlasma(t,a,o,i,.5*r),this.genPlasma(a,e,o,i,.5*r))}createBlendPattern(){const t=1+Math.floor(3*this.rng.random());if(0===t){let t=0;for(let e=0;e<=this.mesh_height;e++)for(let e=0;e<=this.mesh_width;e++)this.vertInfoA[t]=1,this.vertInfoC[t]=0,t+=1}else if(1===t){const t=6.28*this.rng.random(),e=Math.cos(t),s=Math.sin(t),i=.1+.2*this.rng.random(),r=1/i;let a=0;for(let t=0;t<=this.mesh_height;t++){const o=t/this.mesh_height*this.aspecty;for(let t=0;t<=this.mesh_width;t++){let n=(t/this.mesh_width*this.aspectx-.5)*e+(o-.5)*s+.5;n=(n-.5)/Math.sqrt(2)+.5,this.vertInfoA[a]=r*(1+i),this.vertInfoC[a]=r*n-r,a+=1}}}else if(2===t){const t=.12+.13*this.rng.random(),e=1/t;this.vertInfoC[0]=this.rng.random(),this.vertInfoC[this.mesh_width]=this.rng.random(),this.vertInfoC[this.mesh_height*(this.mesh_width+1)]=this.rng.random(),this.vertInfoC[this.mesh_height*(this.mesh_width+1)+this.mesh_width]=this.rng.random(),this.genPlasma(0,this.mesh_width,0,this.mesh_height,.25);let s=this.vertInfoC[0],i=this.vertInfoC[0],r=0;for(let t=0;t<=this.mesh_height;t++)for(let t=0;t<=this.mesh_width;t++)s>this.vertInfoC[r]&&(s=this.vertInfoC[r]),i<this.vertInfoC[r]&&(i=this.vertInfoC[r]),r+=1;const a=1/(i-s);r=0;for(let i=0;i<=this.mesh_height;i++)for(let i=0;i<=this.mesh_width;i++){const i=(this.vertInfoC[r]-s)*a;this.vertInfoA[r]=e*(1+t),this.vertInfoC[r]=e*i-e,r+=1}}else if(3===t){const t=.02+.14*this.rng.random()+.34*this.rng.random(),e=1/t,s=2*Math.floor(2*this.rng.random())-1;let i=0;for(let r=0;r<=this.mesh_height;r++){const a=(r/this.mesh_height-.5)*this.aspecty;for(let r=0;r<=this.mesh_width;r++){const o=(r/this.mesh_width-.5)*this.aspectx;let n=1.41421*Math.sqrt(o*o+a*a);-1===s&&(n=1-n),this.vertInfoA[i]=e*(1+t),this.vertInfoC[i]=e*n-e,i+=1}}}}}class Jt{constructor(t,e,s){this.gl=t,this.audio=e,this.frameNum=0,this.fps=30,this.time=0,this.presetTime=0,this.lastTime=performance.now(),this.timeHist=[0],this.timeHistMax=120,this.blending=!1,this.blendStartTime=0,this.blendProgress=0,this.blendDuration=0,this.targetFPS=s.targetFPS||60,this.frameTime=1e3/this.targetFPS,this.accumulator=0,this.lastFrameTime=performance.now(),this.skipFrameThreshold=1.5*this.frameTime,this.width=s.width||1200,this.height=s.height||900,this.mesh_width=s.meshWidth||48,this.mesh_height=s.meshHeight||36,this.pixelRatio=s.pixelRatio||window.devicePixelRatio||1,this.textureRatio=s.textureRatio||1,this.outputFXAA=s.outputFXAA||!1,this.texsizeX=this.width*this.pixelRatio*this.textureRatio,this.texsizeY=this.height*this.pixelRatio*this.textureRatio,this.aspectx=this.texsizeY>this.texsizeX?this.texsizeX/this.texsizeY:1,this.aspecty=this.texsizeX>this.texsizeY?this.texsizeY/this.texsizeX:1,this.invAspectx=1/this.aspectx,this.invAspecty=1/this.aspecty,this.qs=vt.range(1,33).map(t=>`q${t}`),this.ts=vt.range(1,9).map(t=>`t${t}`),this.regs=vt.range(0,100).map(t=>t<10?`reg0${t}`:`reg${t}`),this.blurRatios=[[.5,.25],[.125,.125],[.0625,.0625]],this.audioLevels=new bt(this.audio),this.prevFrameBuffer=this.gl.createFramebuffer(),this.targetFrameBuffer=this.gl.createFramebuffer(),this.prevTexture=this.gl.createTexture(),this.targetTexture=this.gl.createTexture(),this.compFrameBuffer=this.gl.createFramebuffer(),this.compTexture=this.gl.createTexture(),this.anisoExt=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.bindFrameBufferTexture(this.prevFrameBuffer,this.prevTexture),this.bindFrameBufferTexture(this.targetFrameBuffer,this.targetTexture),this.bindFrameBufferTexture(this.compFrameBuffer,this.compTexture);const i={pixelRatio:this.pixelRatio,textureRatio:this.textureRatio,texsizeX:this.texsizeX,texsizeY:this.texsizeY,mesh_width:this.mesh_width,mesh_height:this.mesh_height,aspectx:this.aspectx,aspecty:this.aspecty};this.noise=new It(t),this.image=new Rt(t),this.warpShader=new qt(t,this.noise,this.image,i),this.compShader=new zt(t,this.noise,this.image,i),this.outputShader=new Nt(t,i),this.prevWarpShader=new qt(t,this.noise,this.image,i),this.prevCompShader=new zt(t,this.noise,this.image,i),this.numBlurPasses=0,this.blurShader1=new Wt(0,this.blurRatios,t,i),this.blurShader2=new Wt(1,this.blurRatios,t,i),this.blurShader3=new Wt(2,this.blurRatios,t,i),this.blurTexture1=this.blurShader1.blurVerticalTexture,this.blurTexture2=this.blurShader2.blurVerticalTexture,this.blurTexture3=this.blurShader3.blurVerticalTexture,this.basicWaveform=new Mt(t,i),this.customWaveforms=vt.range(4).map(e=>new Ut(e,t,i)),this.customShapes=vt.range(4).map(e=>new Qt(e,t,i)),this.prevCustomWaveforms=vt.range(4).map(e=>new Ut(e,t,i)),this.prevCustomShapes=vt.range(4).map(e=>new Qt(e,t,i)),this.darkenCenter=new Dt(t,i),this.innerBorder=new kt(t,i),this.outerBorder=new kt(t,i),this.motionVectors=new Vt(t,i),this.titleText=new Yt(t,i),this.blendPattern=new Ht(i),this.resampleShader=new Xt(t),this.supertext={startTime:-1},this.warpUVs=new Float32Array((this.mesh_width+1)*(this.mesh_height+1)*2),this.warpColor=new Float32Array((this.mesh_width+1)*(this.mesh_height+1)*4),this.prevWarpColor=new Float32Array((this.mesh_width+1)*(this.mesh_height+1)*4),this.gl.clearColor(0,0,0,1),this.blankPreset=_t;const r={frame:0,time:0,fps:45,bass:1,bass_att:1,mid:1,mid_att:1,treb:1,treb_att:1};this.preset=_t,this.prevPreset=this.preset,this.presetEquationRunner=new Pt(this.preset,r,i),this.prevPresetEquationRunner=new Pt(this.prevPreset,r,i),this.preset.useWASM||(this.regVars=this.presetEquationRunner.mdVSRegs)}static getHighestBlur(t){return/sampler_blur3/.test(t)?3:/sampler_blur2/.test(t)?2:/sampler_blur1/.test(t)?1:0}loadPreset(t,e){console.log("[loadPreset] Current preset before switch:",this.preset===this.blankPreset?"BLANK PRESET":"real preset"),console.log("[loadPreset] New preset has desc?",t.desc?`Yes: ${t.desc}`:"No");!t.frame_eqs_str&&!t.pixel_eqs_str&&!t.comp_eqs_str&&t!==this.blankPreset&&console.warn("[loadPreset] WARNING: Preset appears to be empty (no equations). Loading anyway..."),this.blendPattern.createBlendPattern();const s=this.preset===this.blankPreset,i=null!=this.presetEquationRunner&&!s;this.blending=i&&e>0,this.blendStartTime=this.time,this.blendDuration=e,this.blendProgress=0,this.prevPresetEquationRunner=this.presetEquationRunner,this.prevPreset=this.preset,this.preset=t,this.presetTime=this.time;const r={frame:this.frameNum,time:this.time,fps:this.fps,bass:this.audioLevels.bass,bass_att:this.audioLevels.bass_att,mid:this.audioLevels.mid,mid_att:this.audioLevels.mid_att,treb:this.audioLevels.treb,treb_att:this.audioLevels.treb_att},a={pixelRatio:this.pixelRatio,textureRatio:this.textureRatio,texsizeX:this.texsizeX,texsizeY:this.texsizeY,mesh_width:this.mesh_width,mesh_height:this.mesh_height,aspectx:this.aspectx,aspecty:this.aspecty};t.useWASM?(this.preset.globalPools.perFrame.old_wave_mode.value=this.prevPreset.baseVals.wave_mode,this.preset.baseVals.old_wave_mode=this.prevPreset.baseVals.wave_mode,this.presetEquationRunner=new Tt(this.preset,r,a),this.preset.pixel_eqs_initialize_array&&this.preset.pixel_eqs_initialize_array(this.mesh_width,this.mesh_height)):(this.preset.baseVals.old_wave_mode=this.prevPreset.baseVals.wave_mode,this.presetEquationRunner=new Pt(this.preset,r,a),this.regVars=this.presetEquationRunner.mdVSRegs);const o=this.prevWarpShader;this.prevWarpShader=this.warpShader,this.warpShader=o;const n=this.prevCompShader;this.prevCompShader=this.compShader,this.compShader=n;const h=this.preset.warp.trim(),l=this.preset.comp.trim();this.warpShader.updateShader(h),this.compShader.updateShader(l),0===h.length?this.numBlurPasses=0:this.numBlurPasses=Jt.getHighestBlur(h),0!==l.length&&(this.numBlurPasses=Math.max(this.numBlurPasses,Jt.getHighestBlur(l)))}loadExtraImages(t){this.image.loadExtraImages(t)}setRendererSize(t,e,s){const i=this.texsizeX,r=this.texsizeY;if(this.width=t,this.height=e,this.mesh_width=s.meshWidth||this.mesh_width,this.mesh_height=s.meshHeight||this.mesh_height,this.pixelRatio=s.pixelRatio||this.pixelRatio,this.textureRatio=s.textureRatio||this.textureRatio,this.texsizeX=t*this.pixelRatio*this.textureRatio,this.texsizeY=e*this.pixelRatio*this.textureRatio,this.aspectx=this.texsizeY>this.texsizeX?this.texsizeX/this.texsizeY:1,this.aspecty=this.texsizeX>this.texsizeY?this.texsizeY/this.texsizeX:1,this.texsizeX!==i||this.texsizeY!==r){const t=this.gl.createTexture();this.bindFrameBufferTexture(this.targetFrameBuffer,t),this.bindFrambufferAndSetViewport(this.targetFrameBuffer,this.texsizeX,this.texsizeY),this.resampleShader.renderQuadTexture(this.targetTexture),this.targetTexture=t,this.bindFrameBufferTexture(this.prevFrameBuffer,this.prevTexture),this.bindFrameBufferTexture(this.compFrameBuffer,this.compTexture)}this.updateGlobals(),this.frameNum>0&&this.renderToScreen()}setInternalMeshSize(t,e){this.mesh_width=t,this.mesh_height=e,this.updateGlobals()}setOutputAA(t){this.outputFXAA=t}updateGlobals(){const t={pixelRatio:this.pixelRatio,textureRatio:this.textureRatio,texsizeX:this.texsizeX,texsizeY:this.texsizeY,mesh_width:this.mesh_width,mesh_height:this.mesh_height,aspectx:this.aspectx,aspecty:this.aspecty};this.presetEquationRunner.updateGlobals(t),this.prevPresetEquationRunner.updateGlobals(t),this.warpShader.updateGlobals(t),this.prevWarpShader.updateGlobals(t),this.compShader.updateGlobals(t),this.prevCompShader.updateGlobals(t),this.outputShader.updateGlobals(t),this.blurShader1.updateGlobals(t),this.blurShader2.updateGlobals(t),this.blurShader3.updateGlobals(t),this.basicWaveform.updateGlobals(t),this.customWaveforms.forEach(e=>e.updateGlobals(t)),this.customShapes.forEach(e=>e.updateGlobals(t)),this.prevCustomWaveforms.forEach(e=>e.updateGlobals(t)),this.prevCustomShapes.forEach(e=>e.updateGlobals(t)),this.darkenCenter.updateGlobals(t),this.innerBorder.updateGlobals(t),this.outerBorder.updateGlobals(t),this.motionVectors.updateGlobals(t),this.titleText.updateGlobals(t),this.blendPattern.updateGlobals(t),this.warpUVs=new Float32Array((this.mesh_width+1)*(this.mesh_height+1)*2),this.warpColor=new Float32Array((this.mesh_width+1)*(this.mesh_height+1)*4),this.prevWarpColor=new Float32Array((this.mesh_width+1)*(this.mesh_height+1)*4),this.preset.pixel_eqs_initialize_array&&this.preset.pixel_eqs_initialize_array(this.mesh_width,this.mesh_height)}calcTimeAndFPS(t){let e;if(t)e=t;else{const t=performance.now();e=(t-this.lastTime)/1e3,(e>1||e<0||this.frame<2)&&(e=1/30),this.lastTime=t}this.time+=1/this.fps,this.blending&&(this.blendProgress=(this.time-this.blendStartTime)/this.blendDuration,this.blendProgress>1&&(this.blending=!1));const s=this.timeHist[this.timeHist.length-1]+e;this.timeHist.push(s),this.timeHist.length>this.timeHistMax&&this.timeHist.shift();const i=this.timeHist.length/(s-this.timeHist[0]);if(Math.abs(i-this.fps)>3&&this.frame>this.timeHistMax)this.fps=i;else{const t=.93;this.fps=t*this.fps+(1-t)*i}}runPixelEquations(t,e,s,i){const r=this.mesh_width,a=this.mesh_height,o=r+1,n=a+1,h=this.time*e.warpanimspeed,l=1/e.warpscale,A=11.68+4*Math.cos(1.413*h+10),c=8.77+3*Math.cos(1.113*h+7),g=10.54+3*Math.cos(1.233*h+3),m=11.49+4*Math.cos(.933*h+5),u=0/this.texsizeX,d=0/this.texsizeY,f=this.aspectx,p=this.aspecty;let b=0,_=0;if(t.preset.useWASM){const r=t.preset.globalPools.perVertex;if(vt.setWasm(r,s,t.globalKeys),vt.setWasm(r,t.mdVSQAfterFrame,t.qs),r.zoom.value=e.zoom,r.zoomexp.value=e.zoomexp,r.rot.value=e.rot,r.warp.value=e.warp,r.cx.value=e.cx,r.cy.value=e.cy,r.dx.value=e.dx,r.dy.value=e.dy,r.sx.value=e.sx,r.sy.value=e.sy,t.preset.pixel_eqs_wasm(t.runVertEQs,this.mesh_width,this.mesh_height,this.time,e.warpanimspeed,e.warpscale,this.aspectx,this.aspecty),i){const e=t.preset.pixel_eqs_get_array();let s=0,i=0;for(let t=0;t<n;t++)for(let t=0;t<o;t++){const t=e[s],r=e[s+1];let a=this.blendPattern.vertInfoA[s/2]*this.blendProgress+this.blendPattern.vertInfoC[s/2];a=Math.clamp(a,0,1),this.warpUVs[s]=this.warpUVs[s]*a+t*(1-a),this.warpUVs[s+1]=this.warpUVs[s+1]*a+r*(1-a),this.warpColor[i+0]=1,this.warpColor[i+1]=1,this.warpColor[i+2]=1,this.warpColor[i+3]=1-a,this.prevWarpColor[i+0]=1,this.prevWarpColor[i+1]=1,this.prevWarpColor[i+2]=1,this.prevWarpColor[i+3]=a,s+=2,i+=4}}else this.warpUVs=t.preset.pixel_eqs_get_array(),this.warpColor.fill(1),this.prevWarpColor.fill(0)}else{i||this.prevWarpColor.fill(0);let s=vt.cloneVars(e),v=s.warp,E=s.zoom,x=s.zoomexp,w=s.cx,y=s.cy,S=s.sx,P=s.sy,T=s.dx,I=s.dy,R=s.rot;for(let B=0;B<n;B++)for(let n=0;n<o;n++){const o=n/r*2-1,C=B/a*2-1,L=Math.sqrt(o*o*f*f+C*C*p*p);if(t.runVertEQs){let i;i=B===a/2&&n===r/2?0:vt.atan2(C*p,o*f),s.x=.5*o*f+.5,s.y=-.5*C*p+.5,s.rad=L,s.ang=i,s.zoom=e.zoom,s.zoomexp=e.zoomexp,s.rot=e.rot,s.warp=e.warp,s.cx=e.cx,s.cy=e.cy,s.dx=e.dx,s.dy=e.dy,s.sx=e.sx,s.sy=e.sy,s=t.runPixelEquations(s),v=s.warp,E=s.zoom,x=s.zoomexp,w=s.cx,y=s.cy,S=s.sx,P=s.sy,T=s.dx,I=s.dy,R=s.rot}const F=1/E**(x**(2*L-1));let M=.5*o*f*F+.5,U=.5*-C*p*F+.5;M=(M-w)/S+w,U=(U-y)/P+y,0!==v&&(M+=.0035*v*Math.sin(.333*h+l*(o*A-C*m)),U+=.0035*v*Math.cos(.375*h-l*(o*g+C*c)),M+=.0035*v*Math.cos(.753*h-l*(o*c-C*g)),U+=.0035*v*Math.sin(.825*h+l*(o*A+C*m)));const Q=M-w,k=U-y,D=Math.cos(R),V=Math.sin(R);if(M=Q*D-k*V+w,U=Q*V+k*D+y,M-=T,U-=I,M=(M-.5)/f+.5,U=(U-.5)/p+.5,M+=u,U+=d,i){let t=this.blendPattern.vertInfoA[b/2]*this.blendProgress+this.blendPattern.vertInfoC[b/2];t=Math.clamp(t,0,1),this.warpUVs[b]=this.warpUVs[b]*t+M*(1-t),this.warpUVs[b+1]=this.warpUVs[b+1]*t+U*(1-t),this.warpColor[_+0]=1,this.warpColor[_+1]=1,this.warpColor[_+2]=1,this.warpColor[_+3]=1-t,this.prevWarpColor[_+0]=1,this.prevWarpColor[_+1]=1,this.prevWarpColor[_+2]=1,this.prevWarpColor[_+3]=t}else this.warpUVs[b]=M,this.warpUVs[b+1]=U,this.warpColor[_+0]=1,this.warpColor[_+1]=1,this.warpColor[_+2]=1,this.warpColor[_+3]=1;b+=2,_+=4}this.mdVSVertex=s}}static mixFrameEquations(t,e,s){const i=.5-.5*Math.cos(t*Math.PI),r=1-i,a=.5,o=vt.cloneVars(e);return o.decay=i*e.decay+r*s.decay,o.wave_a=i*e.wave_a+r*s.wave_a,o.wave_r=i*e.wave_r+r*s.wave_r,o.wave_g=i*e.wave_g+r*s.wave_g,o.wave_b=i*e.wave_b+r*s.wave_b,o.wave_x=i*e.wave_x+r*s.wave_x,o.wave_y=i*e.wave_y+r*s.wave_y,o.wave_mystery=i*e.wave_mystery+r*s.wave_mystery,o.ob_size=i*e.ob_size+r*s.ob_size,o.ob_r=i*e.ob_r+r*s.ob_r,o.ob_g=i*e.ob_g+r*s.ob_g,o.ob_b=i*e.ob_b+r*s.ob_b,o.ob_a=i*e.ob_a+r*s.ob_a,o.ib_size=i*e.ib_size+r*s.ib_size,o.ib_r=i*e.ib_r+r*s.ib_r,o.ib_g=i*e.ib_g+r*s.ib_g,o.ib_b=i*e.ib_b+r*s.ib_b,o.ib_a=i*e.ib_a+r*s.ib_a,o.mv_x=i*e.mv_x+r*s.mv_x,o.mv_y=i*e.mv_y+r*s.mv_y,o.mv_dx=i*e.mv_dx+r*s.mv_dx,o.mv_dy=i*e.mv_dy+r*s.mv_dy,o.mv_l=i*e.mv_l+r*s.mv_l,o.mv_r=i*e.mv_r+r*s.mv_r,o.mv_g=i*e.mv_g+r*s.mv_g,o.mv_b=i*e.mv_b+r*s.mv_b,o.mv_a=i*e.mv_a+r*s.mv_a,o.echo_zoom=i*e.echo_zoom+r*s.echo_zoom,o.echo_alpha=i*e.echo_alpha+r*s.echo_alpha,o.echo_orient=i*e.echo_orient+r*s.echo_orient,o.wave_dots=i<a?s.wave_dots:e.wave_dots,o.wave_thick=i<a?s.wave_thick:e.wave_thick,o.additivewave=i<a?s.additivewave:e.additivewave,o.wave_brighten=i<a?s.wave_brighten:e.wave_brighten,o.darken_center=i<a?s.darken_center:e.darken_center,o.gammaadj=i<a?s.gammaadj:e.gammaadj,o.wrap=i<a?s.wrap:e.wrap,o.invert=i<a?s.invert:e.invert,o.brighten=i<a?s.brighten:e.brighten,o.darken=i<a?s.darken:e.darken,o.solarize=i<a?s.brighten:e.solarize,o.b1n=i*e.b1n+r*s.b1n,o.b2n=i*e.b2n+r*s.b2n,o.b3n=i*e.b3n+r*s.b3n,o.b1x=i*e.b1x+r*s.b1x,o.b2x=i*e.b2x+r*s.b2x,o.b3x=i*e.b3x+r*s.b3x,o.b1ed=i*e.b1ed+r*s.b1ed,o}static getBlurValues(t){let e=t.b1n,s=t.b2n,i=t.b3n,r=t.b1x,a=t.b2x,o=t.b3x;const n=.1;if(r-e<n){const t=.5*(e+r);e=t-.05,r=t-.05}if(a=Math.min(r,a),s=Math.max(e,s),a-s<n){const t=.5*(s+a);s=t-.05,a=t-.05}if(o=Math.min(a,o),i=Math.max(s,i),o-i<n){const t=.5*(i+o);i=t-.05,o=t-.05}return{blurMins:[e,s,i],blurMaxs:[r,a,o]}}bindFrambufferAndSetViewport(t,e,s){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.viewport(0,0,e,s)}bindFrameBufferTexture(t,e){if(this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.texsizeX,this.texsizeY,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,new Uint8Array(this.texsizeX*this.texsizeY*4)),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.anisoExt){const t=this.gl.getParameter(this.anisoExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT);this.gl.texParameterf(this.gl.TEXTURE_2D,this.anisoExt.TEXTURE_MAX_ANISOTROPY_EXT,t)}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,e,0)}render({audioLevels:t,elapsedTime:e}={}){this.calcTimeAndFPS(e),this.frameNum+=1,t?this.audio.updateAudio(t.timeByteArray,t.timeByteArrayL,t.timeByteArrayR):this.audio.sampleAudio(),this.audioLevels.updateAudioLevels(this.fps,this.frameNum);const s={frame:this.frameNum,time:this.time,fps:this.fps,bass:this.audioLevels.bass,bass_att:this.audioLevels.bass_att,mid:this.audioLevels.mid,mid_att:this.audioLevels.mid_att,treb:this.audioLevels.treb,treb_att:this.audioLevels.treb_att,meshx:this.mesh_width,meshy:this.mesh_height,aspectx:this.invAspectx,aspecty:this.invAspecty,pixelsx:this.texsizeX,pixelsy:this.texsizeY},i=Object.assign({},s);this.prevPreset.useWASM||(i.gmegabuf=this.prevPresetEquationRunner.gmegabuf),this.preset.useWASM||(s.gmegabuf=this.presetEquationRunner.gmegabuf,Object.assign(s,this.regVars));const r=this.presetEquationRunner.runFrameEquations(s);let a;this.runPixelEquations(this.presetEquationRunner,r,s,!1),this.preset.useWASM||(Object.assign(this.regVars,vt.pick(this.mdVSVertex,this.regs)),Object.assign(s,this.regVars)),this.blending?(this.prevMDVSFrame=this.prevPresetEquationRunner.runFrameEquations(i),this.runPixelEquations(this.prevPresetEquationRunner,this.prevMDVSFrame,i,!0),a=Jt.mixFrameEquations(this.blendProgress,r,this.prevMDVSFrame)):a=r;const o=this.targetTexture;this.targetTexture=this.prevTexture,this.prevTexture=o;const n=this.targetFrameBuffer;this.targetFrameBuffer=this.prevFrameBuffer,this.prevFrameBuffer=n,this.gl.bindTexture(this.gl.TEXTURE_2D,this.prevTexture),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.bindFrambufferAndSetViewport(this.targetFrameBuffer,this.texsizeX,this.texsizeY),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);const{blurMins:h,blurMaxs:l}=Jt.getBlurValues(a);this.blending&&this.prevPresetEquationRunner?(this.prevWarpShader.renderQuadTexture(!1,this.prevTexture,this.blurTexture1,this.blurTexture2,this.blurTexture3,h,l,this.prevMDVSFrame,this.prevPresetEquationRunner.mdVSQAfterFrame,this.warpUVs,this.prevWarpColor),this.warpShader.renderQuadTexture(!0,this.prevTexture,this.blurTexture1,this.blurTexture2,this.blurTexture3,h,l,a,this.presetEquationRunner.mdVSQAfterFrame,this.warpUVs,this.warpColor)):this.warpShader.renderQuadTexture(!1,this.prevTexture,this.blurTexture1,this.blurTexture2,this.blurTexture3,h,l,r,this.presetEquationRunner.mdVSQAfterFrame,this.warpUVs,this.warpColor),this.numBlurPasses>0&&(this.blurShader1.renderBlurTexture(this.targetTexture,r,h,l),this.numBlurPasses>1&&(this.blurShader2.renderBlurTexture(this.blurTexture1,r,h,l),this.numBlurPasses>2&&this.blurShader3.renderBlurTexture(this.blurTexture2,r,h,l)),this.bindFrambufferAndSetViewport(this.targetFrameBuffer,this.texsizeX,this.texsizeY)),this.motionVectors.drawMotionVectors(a,this.warpUVs),this.preset.shapes&&this.preset.shapes.length>0&&this.customShapes.forEach((t,e)=>{this.preset.shapes[e]&&t.drawCustomShape(this.blending?this.blendProgress:1,s,this.presetEquationRunner,this.preset.shapes[e],this.prevTexture)}),this.preset.waves&&this.preset.waves.length>0&&this.customWaveforms.forEach((t,e)=>{this.preset.waves[e]&&t.drawCustomWaveform(this.blending?this.blendProgress:1,this.audio.timeArrayL,this.audio.timeArrayR,this.audio.freqArrayL,this.audio.freqArrayR,s,this.presetEquationRunner,this.preset.waves[e])}),this.blending&&(this.prevPreset.shapes&&this.prevPreset.shapes.length>0&&this.prevCustomShapes.forEach((t,e)=>{this.prevPreset.shapes[e]&&t.drawCustomShape(1-this.blendProgress,i,this.prevPresetEquationRunner,this.prevPreset.shapes[e],this.prevTexture)}),this.prevPreset.waves&&this.prevPreset.waves.length>0&&this.prevCustomWaveforms.forEach((t,e)=>{this.prevPreset.waves[e]&&t.drawCustomWaveform(1-this.blendProgress,this.audio.timeArrayL,this.audio.timeArrayR,this.audio.freqArrayL,this.audio.freqArrayR,i,this.prevPresetEquationRunner,this.prevPreset.waves[e])})),this.basicWaveform.drawBasicWaveform(this.blending,this.blendProgress,this.audio.timeArrayL,this.audio.timeArrayR,a),this.darkenCenter.drawDarkenCenter(a);const A=[a.ob_r,a.ob_g,a.ob_b,a.ob_a];this.outerBorder.drawBorder(A,a.ob_size,0);const c=[a.ib_r,a.ib_g,a.ib_b,a.ib_a];if(this.innerBorder.drawBorder(c,a.ib_size,a.ob_size),this.supertext.startTime>=0){const t=(this.time-this.supertext.startTime)/this.supertext.duration;t>=1&&this.titleText.renderTitle(t,!0,s)}this.globalVars=s,this.mdVSFrame=r,this.mdVSFrameMixed=a,this.renderToScreen()}renderToScreen(){this.outputFXAA?this.bindFrambufferAndSetViewport(this.compFrameBuffer,this.texsizeX,this.texsizeY):this.bindFrambufferAndSetViewport(null,this.width,this.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.enable(this.gl.BLEND),this.gl.blendEquation(this.gl.FUNC_ADD),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);const{blurMins:t,blurMaxs:e}=Jt.getBlurValues(this.mdVSFrameMixed);if(this.blending&&this.prevPresetEquationRunner?(this.prevCompShader.renderQuadTexture(!1,this.targetTexture,this.blurTexture1,this.blurTexture2,this.blurTexture3,t,e,this.prevMDVSFrame,this.prevPresetEquationRunner.mdVSQAfterFrame,this.prevWarpColor),this.compShader.renderQuadTexture(!0,this.targetTexture,this.blurTexture1,this.blurTexture2,this.blurTexture3,t,e,this.mdVSFrameMixed,this.presetEquationRunner.mdVSQAfterFrame,this.warpColor)):this.compShader.renderQuadTexture(!1,this.targetTexture,this.blurTexture1,this.blurTexture2,this.blurTexture3,t,e,this.mdVSFrame,this.presetEquationRunner.mdVSQAfterFrame,this.warpColor),this.supertext.startTime>=0){const t=(this.time-this.supertext.startTime)/this.supertext.duration;this.titleText.renderTitle(t,!1,this.globalVars),t>=1&&(this.supertext.startTime=-1)}this.outputFXAA&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.compTexture),this.gl.generateMipmap(this.gl.TEXTURE_2D),this.bindFrambufferAndSetViewport(null,this.width,this.height),this.outputShader.renderQuadTexture(this.compTexture))}launchSongTitleAnim(t){this.supertext={startTime:this.time,duration:1.7},this.titleText.generateTitleTexture(t)}toDataURL(){const t=new Uint8Array(this.texsizeX*this.texsizeY*4),e=this.gl.createFramebuffer(),s=this.gl.createTexture();this.bindFrameBufferTexture(e,s);const{blurMins:i,blurMaxs:r}=Jt.getBlurValues(this.mdVSFrameMixed);this.compShader.renderQuadTexture(!1,this.targetTexture,this.blurTexture1,this.blurTexture2,this.blurTexture3,i,r,this.mdVSFrame,this.presetEquationRunner.mdVSQAfterFrame,this.warpColor),this.gl.readPixels(0,0,this.texsizeX,this.texsizeY,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),Array.from({length:this.texsizeY},(e,s)=>t.slice(s*this.texsizeX*4,(s+1)*this.texsizeX*4)).forEach((e,s)=>t.set(e,(this.texsizeY-s-1)*this.texsizeX*4));const a=document.createElement("canvas");a.width=this.texsizeX,a.height=this.texsizeY;const o=a.getContext("2d",{willReadFrequently:!1}),n=o.createImageData(this.texsizeX,this.texsizeY);return n.data.set(t),o.putImageData(n,0,0),this.gl.deleteTexture(s),this.gl.deleteFramebuffer(e),a.toDataURL()}warpBufferToDataURL(){const t=new Uint8Array(this.texsizeX*this.texsizeY*4);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.targetFrameBuffer),this.gl.readPixels(0,0,this.texsizeX,this.texsizeY,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t);const e=document.createElement("canvas");e.width=this.texsizeX,e.height=this.texsizeY;const s=e.getContext("2d",{willReadFrequently:!1}),i=s.createImageData(this.texsizeX,this.texsizeY);return i.data.set(t),s.putImageData(i,0,0),e.toDataURL()}}class jt{constructor(t,e,s){this.opts=s,this.rng=yt(s),this.deterministicMode=s.deterministic||s.testMode,this.audio=new pt(t);const i=s.width||1200,r=s.height||900;this.canvas=e,this.canvas.width=i,this.canvas.height=r,this.gl=e.getContext("webgl2",{alpha:!1,antialias:!1,depth:!1,stencil:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),this.baseValsDefaults={decay:.98,gammaadj:2,echo_zoom:2,echo_alpha:0,echo_orient:0,red_blue:0,brighten:0,darken:0,wrap:1,darken_center:0,solarize:0,invert:0,bmotionvectorson:1,fshader:0,b1n:0,b2n:0,b3n:0,b1x:1,b2x:1,b3x:1,b1ed:.25,wave_mode:0,additivewave:0,wave_dots:0,wave_thick:0,wave_a:.8,wave_scale:1,wave_smoothing:.75,wave_mystery:0,modwavealphabyvolume:0,modwavealphastart:.75,modwavealphaend:.95,wave_r:1,wave_g:1,wave_b:1,wave_x:.5,wave_y:.5,wave_brighten:1,mv_x:12,mv_y:9,mv_dx:0,mv_dy:0,mv_l:.9,mv_r:1,mv_g:1,mv_b:1,mv_a:1,warpanimspeed:1,warpscale:1,zoomexp:1,zoom:1,rot:0,cx:.5,cy:.5,dx:0,dy:0,warp:1,sx:1,sy:1,ob_size:.01,ob_r:0,ob_g:0,ob_b:0,ob_a:0,ib_size:.01,ib_r:.25,ib_g:.25,ib_b:.25,ib_a:0},this.shapeBaseValsDefaults={enabled:0,sides:4,additive:0,thickoutline:0,textured:0,num_inst:1,tex_zoom:1,tex_ang:0,x:.5,y:.5,rad:.1,ang:0,r:1,g:0,b:0,a:1,r2:0,g2:1,b2:0,a2:0,border_r:1,border_g:1,border_b:1,border_a:.1},this.waveBaseValsDefaults={enabled:0,samples:512,sep:0,scaling:1,smoothing:.5,r:1,g:1,b:1,a:1,spectrum:0,usedots:0,thick:0,additive:0},this.qs=vt.range(1,33).map(t=>`q${t}`),this.ts=vt.range(1,9).map(t=>`t${t}`),this.globalPerFrameVars=["old_wave_mode","frame","time","fps","bass","bass_att","mid","mid_att","treb","treb_att","meshx","meshy","aspectx","aspecty","pixelsx","pixelsy","rand_start","rand_preset"],this.globalPerPixelVars=["frame","time","fps","bass","bass_att","mid","mid_att","treb","treb_att","meshx","meshy","aspectx","aspecty","pixelsx","pixelsy","rand_start","rand_preset","x","y","rad","ang"],this.globalShapeVars=["frame","time","fps","bass","bass_att","mid","mid_att","treb","treb_att","meshx","meshy","aspectx","aspecty","pixelsx","pixelsy","rand_start","rand_preset","instance"],this.shapeBaseVars=["x","y","rad","ang","r","g","b","a","r2","g2","b2","a2","border_r","border_g","border_b","border_a","thickoutline","textured","tex_zoom","tex_ang","additive"],this.globalWaveVars=["frame","time","fps","bass","bass_att","mid","mid_att","treb","treb_att","meshx","meshy","aspectx","aspecty","pixelsx","pixelsy","rand_start","rand_preset","x","y","sample","value1","value2"],this.renderer=new Jt(this.gl,this.audio,s)}loseGLContext(){this.gl.getExtension("WEBGL_lose_context").loseContext()}connectAudio(t){this.audioNode=t,this.audio.connectAudio(t)}disconnectAudio(t){this.audio.disconnectAudio(t)}static overrideDefaultVars(t,e){const s={};return e?(Object.keys(t).forEach(i=>{Object.prototype.hasOwnProperty.call(e,i)?s[i]=e[i]:s[i]=t[i]}),s):{...t}}createQVars(){const t={};return this.qs.forEach(e=>{t[e]=new WebAssembly.Global({value:"f64",mutable:!0},0)}),t}createTVars(){const t={};return this.ts.forEach(e=>{t[e]=new WebAssembly.Global({value:"f64",mutable:!0},0)}),t}createPerFramePool(t){const e={};return Object.keys(this.baseValsDefaults).forEach(s=>{e[s]=new WebAssembly.Global({value:"f64",mutable:!0},t[s])}),this.globalPerFrameVars.forEach(t=>{e[t]=new WebAssembly.Global({value:"f64",mutable:!0},0)}),e}createPerPixelPool(t){const e={};return Object.keys(this.baseValsDefaults).forEach(s=>{e[s]=new WebAssembly.Global({value:"f64",mutable:!0},t[s])}),this.globalPerPixelVars.forEach(t=>{e[t]=new WebAssembly.Global({value:"f64",mutable:!0},0)}),e}createCustomShapePerFramePool(t){const e={};return Object.keys(this.shapeBaseValsDefaults).forEach(s=>{e[s]=new WebAssembly.Global({value:"f64",mutable:!0},t[s])}),this.globalShapeVars.forEach(t=>{e[t]=new WebAssembly.Global({value:"f64",mutable:!0},0)}),e}createCustomWavePerFramePool(t){const e={};return Object.keys(this.waveBaseValsDefaults).forEach(s=>{e[s]=new WebAssembly.Global({value:"f64",mutable:!0},t[s])}),this.globalWaveVars.forEach(t=>{e[t]=new WebAssembly.Global({value:"f64",mutable:!0},0)}),e}static makeShapeResetPool(t,e,s){return e.reduce((e,i)=>({...e,[`${i}_${s}`]:t[i]}),{})}static base64ToArrayBuffer(t){for(var e=window.atob(t),s=e.length,i=new Uint8Array(s),r=0;r<s;r++)i[r]=e.charCodeAt(r);return i.buffer}async loadPreset(t,e=0){try{const s=JSON.parse(JSON.stringify(t));s.baseVals=jt.overrideDefaultVars(this.baseValsDefaults,s.baseVals);for(let t=0;t<s.shapes.length;t++)s.shapes[t].baseVals||void 0===s.shapes[t].enabled||(s.shapes[t].baseVals=Object.assign({},s.shapes[t])),s.shapes[t].baseVals=jt.overrideDefaultVars(this.shapeBaseValsDefaults,s.shapes[t].baseVals);for(let t=0;t<s.waves.length;t++)s.waves[t].baseVals||void 0===s.waves[t].enabled||(s.waves[t].baseVals=Object.assign({},s.waves[t])),s.waves[t].baseVals=jt.overrideDefaultVars(this.waveBaseValsDefaults,s.waves[t].baseVals);const i=s.useJS&&!this.opts.onlyUseWASM;Object.prototype.hasOwnProperty.call(s,"init_eqs_eel")&&!i?(s.useWASM=!0,await this.loadWASMPreset(s,e)):this.opts.onlyUseWASM?console.warn("Tried to load a preset that doesn't support WASM with onlyUseWASM on"):Object.prototype.hasOwnProperty.call(s,"init_eqs_str")?this.loadJSPreset(s,e):console.warn("Tried to load a JS preset that doesn't have converted strings")}catch(t){throw console.error("[Visualizer] Error loading preset:",t),t}}async loadWASMPreset(t,e){const s=this.createQVars(),i=this.createTVars(),r={perFrame:{...s,...this.createPerFramePool(t.baseVals)},perVertex:{...s,...this.createPerPixelPool(t.baseVals)}},a={presetInit:{pool:"perFrame",code:t.init_eqs_eel},perFrame:{pool:"perFrame",code:t.frame_eqs_eel}};""!==t.pixel_eqs_eel&&(a.perPixel={pool:"perVertex",code:t.pixel_eqs_eel});for(let e=0;e<t.shapes.length;e++)r[`shapePerFrame${e}`]={...s,...i,...this.createCustomShapePerFramePool(t.shapes[e].baseVals)},0!==t.shapes[e].baseVals.enabled&&(a[`shapes_${e}_init_eqs`]={pool:`shapePerFrame${e}`,code:t.shapes[e].init_eqs_eel},a[`shapes_${e}_frame_eqs`]={pool:`shapePerFrame${e}`,code:t.shapes[e].frame_eqs_eel});for(let e=0;e<t.waves.length;e++)0!==t.waves[e].baseVals.enabled&&(r[`wavePerFrame${e}`]={...s,...i,...this.createCustomWavePerFramePool(t.waves[e].baseVals)},a[`waves_${e}_init_eqs`]={pool:`wavePerFrame${e}`,code:t.waves[e].init_eqs_eel},a[`waves_${e}_frame_eqs`]={pool:`wavePerFrame${e}`,code:t.waves[e].frame_eqs_eel},t.waves[e].point_eqs_eel&&""!==t.waves[e].point_eqs_eel&&(a[`waves_${e}_point_eqs`]={pool:`wavePerFrame${e}`,code:t.waves[e].point_eqs_eel}));const o=await async function({pools:t,functions:e,eelVersion:s=2}){let i={};Object.entries(t).forEach(([t,e])=>{i[t]=new Set(Object.keys(e))});const r=it({pools:i,functions:e,eelVersion:s}),a=await WebAssembly.compile(r);var o=Object.assign(Object.assign({},t),{shims:K});return await WebAssembly.instantiate(a,o)}({pools:r,functions:a,eelVersion:t.version||2}),n=t=>t||(()=>{}),h=await dt.instantiate(jt.base64ToArrayBuffer("AGFzbQEAAAABPQpgAABgAXwBfGACfHwBfGACf38AYAR/f39/AGAJf39/f3x8fHx8AGADf399AGABfwF/YAJ/fwF/YAF+AX8CuBWMAQNlbnYFYWJvcnQABAhwaXhlbEVxcwtwZXJQaXhlbEVxcwAADHBpeGVsVmFyUG9vbAR3YXJwA3wBDHBpeGVsVmFyUG9vbAR6b29tA3wBDHBpeGVsVmFyUG9vbAd6b29tZXhwA3wBDHBpeGVsVmFyUG9vbAJjeAN8AQxwaXhlbFZhclBvb2wCY3kDfAEMcGl4ZWxWYXJQb29sAnN4A3wBDHBpeGVsVmFyUG9vbAJzeQN8AQxwaXhlbFZhclBvb2wCZHgDfAEMcGl4ZWxWYXJQb29sAmR5A3wBDHBpeGVsVmFyUG9vbANyb3QDfAEMcGl4ZWxWYXJQb29sA3JhZAN8AQxwaXhlbFZhclBvb2wDYW5nA3wBDHBpeGVsVmFyUG9vbAF4A3wBDHBpeGVsVmFyUG9vbAF5A3wBCHFWYXJQb29sAnExA3wBCHFWYXJQb29sAnEyA3wBCHFWYXJQb29sAnEzA3wBCHFWYXJQb29sAnE0A3wBCHFWYXJQb29sAnE1A3wBCHFWYXJQb29sAnE2A3wBCHFWYXJQb29sAnE3A3wBCHFWYXJQb29sAnE4A3wBCHFWYXJQb29sAnE5A3wBCHFWYXJQb29sA3ExMAN8AQhxVmFyUG9vbANxMTEDfAEIcVZhclBvb2wDcTEyA3wBCHFWYXJQb29sA3ExMwN8AQhxVmFyUG9vbANxMTQDfAEIcVZhclBvb2wDcTE1A3wBCHFWYXJQb29sA3ExNgN8AQhxVmFyUG9vbANxMTcDfAEIcVZhclBvb2wDcTE4A3wBCHFWYXJQb29sA3ExOQN8AQhxVmFyUG9vbANxMjADfAEIcVZhclBvb2wDcTIxA3wBCHFWYXJQb29sA3EyMgN8AQhxVmFyUG9vbANxMjMDfAEIcVZhclBvb2wDcTI0A3wBCHFWYXJQb29sA3EyNQN8AQhxVmFyUG9vbANxMjYDfAEIcVZhclBvb2wDcTI3A3wBCHFWYXJQb29sA3EyOAN8AQhxVmFyUG9vbANxMjkDfAEIcVZhclBvb2wDcTMwA3wBCHFWYXJQb29sA3EzMQN8AQhxVmFyUG9vbANxMzIDfAEIdFZhclBvb2wCdDEDfAEIdFZhclBvb2wCdDIDfAEIdFZhclBvb2wCdDMDfAEIdFZhclBvb2wCdDQDfAEIdFZhclBvb2wCdDUDfAEIdFZhclBvb2wCdDYDfAEIdFZhclBvb2wCdDcDfAEIdFZhclBvb2wCdDgDfAEKc2hhcGVQb29sMAN4XzADfAEKc2hhcGVQb29sMAN5XzADfAEKc2hhcGVQb29sMAVyYWRfMAN8AQpzaGFwZVBvb2wwBWFuZ18wA3wBCnNoYXBlUG9vbDADcl8wA3wBCnNoYXBlUG9vbDADZ18wA3wBCnNoYXBlUG9vbDADYl8wA3wBCnNoYXBlUG9vbDADYV8wA3wBCnNoYXBlUG9vbDAEcjJfMAN8AQpzaGFwZVBvb2wwBGcyXzADfAEKc2hhcGVQb29sMARiMl8wA3wBCnNoYXBlUG9vbDAEYTJfMAN8AQpzaGFwZVBvb2wwCmJvcmRlcl9yXzADfAEKc2hhcGVQb29sMApib3JkZXJfZ18wA3wBCnNoYXBlUG9vbDAKYm9yZGVyX2JfMAN8AQpzaGFwZVBvb2wwCmJvcmRlcl9hXzADfAEKc2hhcGVQb29sMA50aGlja291dGxpbmVfMAN8AQpzaGFwZVBvb2wwCnRleHR1cmVkXzADfAEKc2hhcGVQb29sMAp0ZXhfem9vbV8wA3wBCnNoYXBlUG9vbDAJdGV4X2FuZ18wA3wBCnNoYXBlUG9vbDAKYWRkaXRpdmVfMAN8AQpzaGFwZVBvb2wxA3hfMQN8AQpzaGFwZVBvb2wxA3lfMQN8AQpzaGFwZVBvb2wxBXJhZF8xA3wBCnNoYXBlUG9vbDEFYW5nXzEDfAEKc2hhcGVQb29sMQNyXzEDfAEKc2hhcGVQb29sMQNnXzEDfAEKc2hhcGVQb29sMQNiXzEDfAEKc2hhcGVQb29sMQNhXzEDfAEKc2hhcGVQb29sMQRyMl8xA3wBCnNoYXBlUG9vbDEEZzJfMQN8AQpzaGFwZVBvb2wxBGIyXzEDfAEKc2hhcGVQb29sMQRhMl8xA3wBCnNoYXBlUG9vbDEKYm9yZGVyX3JfMQN8AQpzaGFwZVBvb2wxCmJvcmRlcl9nXzEDfAEKc2hhcGVQb29sMQpib3JkZXJfYl8xA3wBCnNoYXBlUG9vbDEKYm9yZGVyX2FfMQN8AQpzaGFwZVBvb2wxDnRoaWNrb3V0bGluZV8xA3wBCnNoYXBlUG9vbDEKdGV4dHVyZWRfMQN8AQpzaGFwZVBvb2wxCnRleF96b29tXzEDfAEKc2hhcGVQb29sMQl0ZXhfYW5nXzEDfAEKc2hhcGVQb29sMQphZGRpdGl2ZV8xA3wBCnNoYXBlUG9vbDIDeF8yA3wBCnNoYXBlUG9vbDIDeV8yA3wBCnNoYXBlUG9vbDIFcmFkXzIDfAEKc2hhcGVQb29sMgVhbmdfMgN8AQpzaGFwZVBvb2wyA3JfMgN8AQpzaGFwZVBvb2wyA2dfMgN8AQpzaGFwZVBvb2wyA2JfMgN8AQpzaGFwZVBvb2wyA2FfMgN8AQpzaGFwZVBvb2wyBHIyXzIDfAEKc2hhcGVQb29sMgRnMl8yA3wBCnNoYXBlUG9vbDIEYjJfMgN8AQpzaGFwZVBvb2wyBGEyXzIDfAEKc2hhcGVQb29sMgpib3JkZXJfcl8yA3wBCnNoYXBlUG9vbDIKYm9yZGVyX2dfMgN8AQpzaGFwZVBvb2wyCmJvcmRlcl9iXzIDfAEKc2hhcGVQb29sMgpib3JkZXJfYV8yA3wBCnNoYXBlUG9vbDIOdGhpY2tvdXRsaW5lXzIDfAEKc2hhcGVQb29sMgp0ZXh0dXJlZF8yA3wBCnNoYXBlUG9vbDIKdGV4X3pvb21fMgN8AQpzaGFwZVBvb2wyCXRleF9hbmdfMgN8AQpzaGFwZVBvb2wyCmFkZGl0aXZlXzIDfAEKc2hhcGVQb29sMwN4XzMDfAEKc2hhcGVQb29sMwN5XzMDfAEKc2hhcGVQb29sMwVyYWRfMwN8AQpzaGFwZVBvb2wzBWFuZ18zA3wBCnNoYXBlUG9vbDMDcl8zA3wBCnNoYXBlUG9vbDMDZ18zA3wBCnNoYXBlUG9vbDMDYl8zA3wBCnNoYXBlUG9vbDMDYV8zA3wBCnNoYXBlUG9vbDMEcjJfMwN8AQpzaGFwZVBvb2wzBGcyXzMDfAEKc2hhcGVQb29sMwRiMl8zA3wBCnNoYXBlUG9vbDMEYTJfMwN8AQpzaGFwZVBvb2wzCmJvcmRlcl9yXzMDfAEKc2hhcGVQb29sMwpib3JkZXJfZ18zA3wBCnNoYXBlUG9vbDMKYm9yZGVyX2JfMwN8AQpzaGFwZVBvb2wzCmJvcmRlcl9hXzMDfAEKc2hhcGVQb29sMw50aGlja291dGxpbmVfMwN8AQpzaGFwZVBvb2wzCnRleHR1cmVkXzMDfAEKc2hhcGVQb29sMwp0ZXhfem9vbV8zA3wBCnNoYXBlUG9vbDMJdGV4X2FuZ18zA3wBCnNoYXBlUG9vbDMKYWRkaXRpdmVfMwN8AQMZGAgDBwkBAQICAQYFAAAAAAAAAAAAAAAAAAUDAQABBuwMigF8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt8AUQAAAAAAAAAAAt/AUEAC3wBRAAAAAAAAAAAC3wBRAAAAAAAAAAAC34BQgALB9kB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"),{pixelEqs:{perPixelEqs:n(o.exports.perPixel)},pixelVarPool:{warp:r.perVertex.warp,zoom:r.perVertex.zoom,zoomexp:r.perVertex.zoomexp,cx:r.perVertex.cx,cy:r.perVertex.cy,sx:r.perVertex.sx,sy:r.perVertex.sy,dx:r.perVertex.dx,dy:r.perVertex.dy,rot:r.perVertex.rot,x:r.perVertex.x,y:r.perVertex.y,ang:r.perVertex.ang,rad:r.perVertex.rad},qVarPool:s,tVarPool:i,shapePool0:jt.makeShapeResetPool(r.shapePerFrame0,this.shapeBaseVars,0),shapePool1:jt.makeShapeResetPool(r.shapePerFrame1,this.shapeBaseVars,1),shapePool2:jt.makeShapeResetPool(r.shapePerFrame2,this.shapeBaseVars,2),shapePool3:jt.makeShapeResetPool(r.shapePerFrame3,this.shapeBaseVars,3),console:{logi:t=>{console.log("logi: "+t)},logf:t=>{console.log("logf: "+t)}},env:{abort:()=>{}}});t.globalPools=r,t.init_eqs=n(o.exports.presetInit),t.frame_eqs=n(o.exports.perFrame),t.save_qs=h.exports.saveQs,t.restore_qs=h.exports.restoreQs,t.save_ts=h.exports.saveTs,t.restore_ts=h.exports.restoreTs,o.exports.perPixel&&(t.pixel_eqs=o.exports.perPixel),t.pixel_eqs_initialize_array=(e,s)=>{const i=h.exports.createFloat32Array((e+1)*(s+1)*2);t.pixel_eqs_array=i},t.pixel_eqs_get_array=()=>h.exports.__getFloat32ArrayView(t.pixel_eqs_array),t.pixel_eqs_wasm=(...e)=>h.exports.runPixelEquations(t.pixel_eqs_array,...e);for(let e=0;e<t.shapes.length;e++)0!==t.shapes[e].baseVals.enabled&&(t.shapes[e].init_eqs=n(o.exports[`shapes_${e}_init_eqs`]),t.shapes[e].frame_eqs=o.exports[`shapes_${e}_frame_eqs`],t.shapes[e].frame_eqs_save=()=>h.exports[`shape${e}_save`](),t.shapes[e].frame_eqs_restore=()=>h.exports[`shape${e}_restore`]());for(let e=0;e<t.waves.length;e++)if(0!==t.waves[e].baseVals.enabled){const s={init_eqs:n(o.exports[`waves_${e}_init_eqs`]),frame_eqs:n(o.exports[`waves_${e}_frame_eqs`])};t.waves[e].point_eqs_eel&&""!==t.waves[e].point_eqs_eel?s.point_eqs=o.exports[`waves_${e}_point_eqs`]:s.point_eqs="",t.waves[e]=Object.assign({},t.waves[e],s)}this.renderer.loadPreset(t,e)}loadJSPreset(t,e){if("function"!=typeof t.init_eqs){t.init_eqs=new Function("a",`${t.init_eqs_str} return a;`),t.frame_eqs=new Function("a",`${t.frame_eqs_str} return a;`),t.pixel_eqs_str&&""!==t.pixel_eqs_str?t.pixel_eqs=new Function("a",`${t.pixel_eqs_str} return a;`):t.pixel_eqs="";for(let e=0;e<t.shapes.length;e++)0!==t.shapes[e].baseVals.enabled&&(t.shapes[e]=Object.assign({},t.shapes[e],{init_eqs:new Function("a",`${t.shapes[e].init_eqs_str} return a;`),frame_eqs:new Function("a",`${t.shapes[e].frame_eqs_str} return a;`)}));for(let e=0;e<t.waves.length;e++)if(0!==t.waves[e].baseVals.enabled){const s={init_eqs:new Function("a",`${t.waves[e].init_eqs_str} return a;`),frame_eqs:new Function("a",`${t.waves[e].frame_eqs_str} return a;`)};t.waves[e].point_eqs_str&&""!==t.waves[e].point_eqs_str?s.point_eqs=new Function("a",`${t.waves[e].point_eqs_str} return a;`):s.point_eqs="",t.waves[e]=Object.assign({},t.waves[e],s)}}this.renderer.loadPreset(t,e)}loadExtraImages(t){this.renderer.loadExtraImages(t)}setRendererSize(t,e,s={}){this.internalCanvas.width=t,this.internalCanvas.height=e,this.renderer.setRendererSize(t,e,s)}setInternalMeshSize(t,e){this.renderer.setInternalMeshSize(t,e)}setOutputAA(t){this.renderer.setOutputAA(t)}setCanvas(t){console.warn("setCanvas called - may need to recreate WebGL context"),this.canvas=t}render(t){return this.renderer.render(t)}launchSongTitleAnim(t){this.renderer.launchSongTitleAnim(t)}toDataURL(){return this.renderer.toDataURL()}warpBufferToDataURL(){return this.renderer.warpBufferToDataURL()}}const Kt=new class{constructor(t={}){this.thresholds={blackFrame:t.blackFrameThreshold||60,stuckFrame:t.stuckFrameThreshold||120,solidColor:t.solidColorThreshold||180,...t.thresholds},this.sensitivity={blackThreshold:t.blackThreshold||.95,colorVariance:t.colorVariance||10,frameChangeThreshold:t.changeThreshold||.01,...t.sensitivity},this.frameHistory=[],this.maxHistorySize=Math.max(...Object.values(this.thresholds)),this.state={frameCount:0,lastFrameHash:null,identicalFrameCount:0,blackFrameCount:0,solidColorCount:0,lastAnalysis:null},this.sampleSize=t.sampleSize||1e3,this.sampleIndices=null}analyzeFrame(t,e,s){this.state.frameCount++,this.sampleIndices||(this.sampleIndices=this.generateSampleIndices(e*s));const i=this.calculateFrameMetrics(t);this.updateFrameHistory(i);const r={frameNumber:this.state.frameCount,isProblematic:!1,reason:null,confidence:0,metrics:i,details:{}};return this.isBlackFrame(i)?(this.state.blackFrameCount++,this.state.blackFrameCount>=this.thresholds.blackFrame&&(r.isProblematic=!0,r.reason="black_frame",r.confidence=this.state.blackFrameCount/this.thresholds.blackFrame,r.details.blackFrameCount=this.state.blackFrameCount)):this.state.blackFrameCount=0,this.isStuckFrame(i)?(this.state.identicalFrameCount++,this.state.identicalFrameCount>=this.thresholds.stuckFrame&&(r.isProblematic=!0,r.reason="stuck_frame",r.confidence=this.state.identicalFrameCount/this.thresholds.stuckFrame,r.details.identicalFrameCount=this.state.identicalFrameCount)):this.state.identicalFrameCount=0,this.isSolidColorFrame(i)?(this.state.solidColorCount++,this.state.solidColorCount>=this.thresholds.solidColor&&(r.isProblematic=!0,r.reason="solid_color",r.confidence=this.state.solidColorCount/this.thresholds.solidColor,r.details.solidColorCount=this.state.solidColorCount,r.details.dominantColor=i.dominantColor)):this.state.solidColorCount=0,this.state.lastAnalysis=r,r}calculateFrameMetrics(t){const e={hash:0,brightness:0,blackPixelRatio:0,colorVariance:{r:0,g:0,b:0},dominantColor:{r:0,g:0,b:0},isEmpty:!1,hasChanged:!0},s=this.samplePixels(t);let i=0,r=0,a=0,o=0;s.forEach(t=>{i+=t.r,r+=t.g,a+=t.b;(t.r+t.g+t.b)/3<10&&o++});const n=this.calculateFNVHash(s),h=s.length;e.dominantColor.r=Math.round(i/h),e.dominantColor.g=Math.round(r/h),e.dominantColor.b=Math.round(a/h),e.brightness=(e.dominantColor.r+e.dominantColor.g+e.dominantColor.b)/3,e.blackPixelRatio=o/h,e.hash=n;let l=0,A=0,c=0;return s.forEach(t=>{l+=Math.pow(t.r-e.dominantColor.r,2),A+=Math.pow(t.g-e.dominantColor.g,2),c+=Math.pow(t.b-e.dominantColor.b,2)}),e.colorVariance.r=Math.sqrt(l/h),e.colorVariance.g=Math.sqrt(A/h),e.colorVariance.b=Math.sqrt(c/h),e.isEmpty=e.blackPixelRatio>.99,null!==this.state.lastFrameHash&&(e.hasChanged=Math.abs(e.hash-this.state.lastFrameHash)>100),this.state.lastFrameHash=e.hash,e}calculateFNVHash(t){const e=16777619;let s=2166136261;for(let i=0;i<t.length;i++){const r=t[i];s^=r.r,s=Math.imul(s,e),s^=r.g,s=Math.imul(s,e),s^=r.b,s=Math.imul(s,e)}return s>>>0}samplePixels(t){const e=[],s=t.length/4;for(let i=0;i<this.sampleSize&&i<s;i++){const s=4*this.sampleIndices[i];e.push({r:t[s],g:t[s+1],b:t[s+2],a:t[s+3]})}return e}generateSampleIndices(t){const e=[],s=Math.floor(t/this.sampleSize);for(let i=0;i<this.sampleSize;i++){const r=i*s,a=Math.min((i+1)*s,t),o=r+Math.floor(Math.random()*(a-r));e.push(Math.min(o,t-1))}return e}updateFrameHistory(t){this.frameHistory.push({timestamp:Date.now(),metrics:t}),this.frameHistory.length>this.maxHistorySize&&this.frameHistory.shift()}isBlackFrame(t){return t.blackPixelRatio>this.sensitivity.blackThreshold||t.brightness<5}isStuckFrame(t){return!t.hasChanged&&!t.isEmpty}isSolidColorFrame(t){return(t.colorVariance.r+t.colorVariance.g+t.colorVariance.b)/3<this.sensitivity.colorVariance&&t.brightness>10&&t.brightness<245}getState(){return{...this.state,historySize:this.frameHistory.length,thresholds:this.thresholds,sensitivity:this.sensitivity}}reset(){this.state={frameCount:0,lastFrameHash:null,identicalFrameCount:0,blackFrameCount:0,solidColorCount:0,lastAnalysis:null},this.frameHistory=[],console.log("[LiveFrameAnalyzer] State reset")}analyzeHistory(){if(this.frameHistory.length<10)return{message:"Not enough history for analysis"};const t=this.frameHistory.slice(-60),e={avgBrightness:0,avgBlackRatio:0,changeFrequency:0,dominantIssue:null};let s=0,i=null;return t.forEach(t=>{e.avgBrightness+=t.metrics.brightness,e.avgBlackRatio+=t.metrics.blackPixelRatio,null!==i&&t.metrics.hash!==i&&s++,i=t.metrics.hash}),e.avgBrightness/=t.length,e.avgBlackRatio/=t.length,e.changeFrequency=s/t.length,e.avgBlackRatio>.8?e.dominantIssue="mostly_black":e.changeFrequency<.1?e.dominantIssue="low_activity":e.avgBrightness<20?e.dominantIssue="too_dark":e.avgBrightness>235&&(e.dominantIssue="too_bright"),e}adjustForDevice(t){switch(t){case"mobile":this.thresholds.blackFrame=90,this.thresholds.stuckFrame=180,this.thresholds.solidColor=240;break;case"low_end":this.thresholds.blackFrame=75,this.thresholds.stuckFrame=150,this.thresholds.solidColor=210;break;case"high_end":this.thresholds.blackFrame=30,this.thresholds.stuckFrame=60,this.thresholds.solidColor=120}console.log(`[LiveFrameAnalyzer] Adjusted thresholds for ${t} device`)}};const Zt=new class{constructor(){this.sessionLog={session_id:Date.now(),device:null,failures:{},started:(new Date).toISOString()},this.aggregateLog=this.loadAggregateLog(),this.blocklist=this.loadBlocklist(),this.initialized=!1,this.autoSaveInterval=3e4,this.autoSaveTimer=null}async initialize(){if(!this.initialized){try{this.sessionLog.device=await this.getDeviceFingerprint(),this.initialized=!0}catch(t){console.warn("[PresetFailureLogger] Device fingerprint failed, using fallback:",t),this.sessionLog.device={tier:"unknown",memory:4,cores:2,gpu:"unknown",browser:navigator.userAgent,timestamp:Date.now()},this.initialized=!0}this.startAutoSave()}}async getDeviceFingerprint(){const t=navigator.deviceMemory||4,e=navigator.hardwareConcurrency||2;let s="mid_range";return t<=2||e<=2?s="low_end":t>=8&&e>=8?s="high_end":/Mobile|Android|iPhone/i.test(navigator.userAgent)&&(s="mobile"),{tier:s,memory:t,cores:e,gpu:this.detectGPUInfo(),browser:navigator.userAgent,timestamp:Date.now()}}detectGPUInfo(){try{const t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return"unknown";const s=e.getExtension("WEBGL_debug_renderer_info");return s?e.getParameter(s.UNMASKED_RENDERER_WEBGL):"unknown"}catch(t){return"unknown"}}startAutoSave(){this.autoSaveTimer&&clearInterval(this.autoSaveTimer),this.autoSaveTimer=setInterval(()=>{this.saveToFile()},this.autoSaveInterval)}loadAggregateLog(){try{if("undefined"==typeof localStorage)return{};const t=localStorage.getItem("preset-failures-aggregate.json");return t?JSON.parse(t):{}}catch(t){return console.warn("[PresetFailureLogger] Failed to load aggregate log:",t),{}}}loadBlocklist(){try{if("undefined"==typeof localStorage)return this.createEmptyBlocklist();const t=localStorage.getItem("preset-blocklist-permanent.json");if(!t)return this.createEmptyBlocklist();const e=JSON.parse(t);return e.permanent=new Set(e.permanent),e}catch(t){return console.warn("[PresetFailureLogger] Failed to load blocklist:",t),this.createEmptyBlocklist()}}createEmptyBlocklist(){return{version:1,permanent:new Set,conditional:{mobile:[],low_memory:[],integrated_gpu:[]},metadata:{},created:(new Date).toISOString()}}logFailure(t,e,s){if(!this.initialized)return void console.warn("[PresetFailureLogger] Attempted to log failure before initialization. Log discarded.");this.sessionLog.failures[t]||(this.sessionLog.failures[t]={count:0,reasons:[],first_failure:Date.now(),last_failure:null});const i=this.sessionLog.failures[t];i.count++,i.last_failure=Date.now(),i.reasons.push({time:Date.now(),reason:e,audio_playing:s.audioLevel>.01,fps:s.fps,memory:"undefined"!=typeof performance&&performance.memory?performance.memory.usedJSHeapSize:void 0,frame_data:s.frameData||null}),this.updateAggregateStats(t,e),this.shouldBlocklist(t)&&this.addToBlocklist(t,"high_failure_rate"),console.log(`[PresetFailure] ${t}: ${e} (${i.count} failures)`),i.count%10==0&&this.saveToFile()}updateAggregateStats(t,e){this.aggregateLog[t]||(this.aggregateLog[t]={first_seen:Date.now(),total_attempts:0,total_failures:0,failure_reasons:{},devices_failed:[],last_failure:null});const s=this.aggregateLog[t];s.total_attempts++,s.total_failures++,s.last_failure=Date.now(),s.failure_reasons[e]||(s.failure_reasons[e]=0),s.failure_reasons[e]++;const i=`${this.sessionLog.device.tier}_${this.sessionLog.device.memory}`;s.devices_failed.includes(i)||s.devices_failed.push(i),s.failure_rate=s.total_failures/s.total_attempts}shouldBlocklist(t){const e=this.aggregateLog[t];return e&&(e.failure_rate>.8||e.total_failures>50)}addToBlocklist(t,e){this.blocklist.permanent.add(t),this.blocklist.metadata[t]||(this.blocklist.metadata[t]={added:Date.now(),reasons:[],auto_blocked:!0,failure_stats:{...this.aggregateLog[t]}}),this.blocklist.metadata[t].reasons.push({reason:e,timestamp:Date.now()});const s=this.sessionLog.device;"mobile"!==s.tier||this.blocklist.conditional.mobile.includes(t)||this.blocklist.conditional.mobile.push(t),s.memory<4&&!this.blocklist.conditional.low_memory.includes(t)&&this.blocklist.conditional.low_memory.push(t),s.gpu&&s.gpu.includes("Intel")&&!this.blocklist.conditional.integrated_gpu.includes(t)&&this.blocklist.conditional.integrated_gpu.push(t),console.warn(`[Blocklist] Added ${t} to permanent blocklist: ${e}`),this.saveToFile()}isBlocked(t,e=null){return e=e||this.sessionLog.device,this.blocklist.permanent.has(t)?{blocked:!0,reason:"permanent"}:e?"mobile"===e.tier&&this.blocklist.conditional.mobile.includes(t)?{blocked:!0,reason:"mobile_incompatible"}:e.memory&&e.memory<4&&this.blocklist.conditional.low_memory.includes(t)?{blocked:!0,reason:"insufficient_memory"}:e.gpu&&e.gpu.includes("Intel")&&this.blocklist.conditional.integrated_gpu.includes(t)?{blocked:!0,reason:"gpu_incompatible"}:{blocked:!1}:{blocked:!1}}saveToFile(){try{if("undefined"==typeof localStorage)return;localStorage.setItem(`preset-failures-${this.sessionLog.session_id}.json`,JSON.stringify(this.sessionLog)),localStorage.setItem("preset-failures-aggregate.json",JSON.stringify(this.aggregateLog)),localStorage.setItem("preset-blocklist-permanent.json",JSON.stringify(this.exportBlocklist()))}catch(t){console.error("[PresetFailureLogger] Failed to save logs:",t)}}exportBlocklist(){return{version:this.blocklist.version,generated:Date.now(),permanent:Array.from(this.blocklist.permanent),conditional:this.blocklist.conditional,metadata:this.blocklist.metadata,stats:{total_blocked:this.blocklist.permanent.size,mobile_blocked:this.blocklist.conditional.mobile.length,low_memory_blocked:this.blocklist.conditional.low_memory.length,integrated_gpu_blocked:this.blocklist.conditional.integrated_gpu.length}}}importBlocklist(t){try{const e="string"==typeof t?JSON.parse(t):t;return e.permanent.forEach(t=>{this.blocklist.permanent.add(t),this.blocklist.metadata[t]||(this.blocklist.metadata[t]=e.metadata[t]||{added:Date.now(),reasons:["imported"],auto_blocked:!1})}),["mobile","low_memory","integrated_gpu"].forEach(t=>{e.conditional[t]&&e.conditional[t].forEach(e=>{this.blocklist.conditional[t].includes(e)||this.blocklist.conditional[t].push(e)})}),console.log(`[Blocklist] Imported ${e.permanent.length} permanent blocks, ${e.stats?e.stats.total_blocked:"unknown"} total`),this.saveToFile(),!0}catch(t){return console.error("[PresetFailureLogger] Failed to import blocklist:",t),!1}}getStatistics(){return{session:{id:this.sessionLog.session_id,started:this.sessionLog.started,failures:Object.keys(this.sessionLog.failures).length,device:this.sessionLog.device},aggregate:{total_presets:Object.keys(this.aggregateLog).length,total_failures:Object.values(this.aggregateLog).reduce((t,e)=>t+e.total_failures,0)},blocklist:{permanent:this.blocklist.permanent.size,mobile:this.blocklist.conditional.mobile.length,low_memory:this.blocklist.conditional.low_memory.length,integrated_gpu:this.blocklist.conditional.integrated_gpu.length}}}clearAllLogs(){"undefined"!=typeof localStorage&&Object.keys(localStorage).filter(t=>t.startsWith("preset-failures-")||t.startsWith("preset-blocklist-")).forEach(t=>localStorage.removeItem(t)),this.sessionLog.failures={},this.aggregateLog={},this.blocklist=this.createEmptyBlocklist(),console.log("[PresetFailureLogger] All logs cleared")}destroy(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null),this.saveToFile()}};const $t=new class{constructor(){this.emergencyPresets={minimal:this.getMinimalPreset(),basic_reactive:this.getBasicReactivePreset(),crowd_pleaser:this.getCrowdPleaserPreset()},this.usage={minimal:0,basic_reactive:0,crowd_pleaser:0,lastUsed:null,lastSwitchTime:0}}getEmergencyPreset(t={}){let e="minimal";if("high_end"===t.deviceTier||"mid_range"===t.deviceTier?e=t.audioLevel>.5?"crowd_pleaser":"basic_reactive":"low_end"===t.deviceTier&&(e=t.audioLevel>.3?"basic_reactive":"minimal"),e===this.usage.lastUsed&&Date.now()-this.usage.lastSwitchTime<1e4){const t=Object.keys(this.emergencyPresets).filter(t=>t!==e);e=t[Math.floor(Math.random()*t.length)]}return this.usage[e]++,this.usage.lastUsed=e,this.usage.lastSwitchTime=Date.now(),console.log(`[EmergencyPresetManager] Activating ${e} preset`),{preset:this.emergencyPresets[e],key:e,isEmergency:!0}}getMinimalPreset(){return{id:"emergency_minimal",name:"Emergency: Minimal",init_eqs_str:"\n        a.decay = 0.98;\n        a.wave_r = 0.5;\n        a.wave_g = 0.5;\n        a.wave_b = 0.5;\n        a.wave_a = 0.8;\n        a.wave_mystery = -0.5;\n        a.wave_mode = 0;\n        a.wave_dots = 0;\n        a.wave_thick = 1;\n        a.wave_brighten = 1;\n        a.zoom = 1.0;\n        a.rot = 0.0;\n        a.cx = 0.5;\n        a.cy = 0.5;\n      ",frame_eqs_str:"\n        // Pulsing colors based on audio\n        a.wave_r = 0.2 + 0.3 * Math.sin(a.time * 2.0) * 0.85 + a.bass * 0.5;\n        a.wave_g = 0.1 + a.mid * 0.3;\n        a.wave_b = 0.4 + a.treb * 0.2;\n\n        // Audio-reactive zoom with baseline\n        a.zoom = 1.0 + Math.sin(a.time) * 0.02 + a.bass * 0.05;\n\n        // Slight rotation based on time\n        a.rot = Math.sin(a.time * 0.5) * 0.01;\n\n        // Keep decay high for minimal effect\n        a.decay = 0.98;\n      ",pixel_eqs_str:"\n        // Add subtle zoom variation based on radius\n        var dist = Math.sqrt((a.x - 0.5) * (a.x - 0.5) + (a.y - 0.5) * (a.y - 0.5));\n        a.zoom = a.zoom + Math.sin(dist * 10.0 + a.time * 2.0) * 0.01;\n      ",waves:[{baseVals:{enabled:1,thick:1,additive:0,scaling:1,smoothing:.5,r:1,g:1,b:1,a:.8},init_eqs_str:"",frame_eqs_str:"",point_eqs_str:""}],shapes:[],warp:"",comp:""}}getBasicReactivePreset(){return{id:"emergency_basic_reactive",name:"Emergency: Basic Reactive",init_eqs_str:"\n        a.decay = 0.96;\n        a.wave_r = 0.5;\n        a.wave_g = 0.5;\n        a.wave_b = 0.5;\n        a.wave_a = 1.0;\n        a.wave_mystery = 0;\n        a.wave_mode = 1;\n        a.wave_dots = 0;\n        a.wave_thick = 1;\n        a.wave_brighten = 1;\n        a.zoom = 1.0;\n        a.rot = 0.0;\n        a.cx = 0.5;\n        a.cy = 0.5;\n        a.dx = 0.0;\n        a.dy = 0.0;\n        a.echo_alpha = 0.3;\n        a.echo_zoom = 1.02;\n      ",frame_eqs_str:"\n        // Color waves based on frequency\n        var wave = Math.sin(a.time * 2.0) * 0.5 + 0.5;\n        a.wave_r = 0.15 + a.bass * wave + wave * 0.2;\n        a.wave_g = 0.15 + a.mid * (1.0 - wave) + (1.0 - wave) * 0.1;\n        a.wave_b = 0.15 + a.treb * 0.5 + 0.2;\n\n        // Audio-driven zoom\n        a.zoom = 1.0 + a.bass * 0.1;\n\n        // Motion blur effect via decay\n        a.decay = 0.96 - a.bass * 0.04;\n\n        // Add motion offset\n        a.dx = Math.cos(a.time * 2.0) * 0.003;\n        a.dy = Math.sin(a.time * 2.0) * 0.003;\n\n        // Echo for motion trails\n        a.echo_alpha = 0.25 + a.bass * 0.1;\n        a.echo_zoom = 0.992;\n      ",pixel_eqs_str:"\n        // Add wave distortion based on position\n        var wave_x = Math.sin(a.x * 10.0 + a.time * 2.0) * 0.5 + 0.5;\n        a.sx = a.sx + wave_x * 0.01 * a.bass;\n        a.sy = a.sy + (1.0 - wave_x) * 0.01 * a.mid;\n      ",waves:[{baseVals:{enabled:1,thick:1,additive:1,scaling:1.5,smoothing:.75,r:1,g:.5,b:.2,a:1},init_eqs_str:"",frame_eqs_str:"",point_eqs_str:""}],shapes:[{baseVals:{enabled:1,sides:4,additive:1,thickoutline:0,x:.5,y:.5,rad:.3,ang:0,r:.5,g:.8,b:1,a:.3,r2:.5,g2:.8,b2:1,a2:0,border_r:1,border_g:1,border_b:1,border_a:0},init_eqs_str:"",frame_eqs_str:""}],warp:"",comp:""}}getCrowdPleaserPreset(){return{id:"emergency_crowd_pleaser",name:"Emergency: Crowd Pleaser",init_eqs_str:"\n        a.decay = 0.92;\n        a.wave_r = 0.5;\n        a.wave_g = 0.5;\n        a.wave_b = 0.5;\n        a.wave_a = 1.0;\n        a.wave_mystery = 0.5;\n        a.wave_mode = 3;\n        a.wave_dots = 0;\n        a.wave_thick = 1;\n        a.wave_brighten = 1;\n        a.wave_x = 0.5;\n        a.wave_y = 0.5;\n        a.zoom = 1.0;\n        a.rot = 0.0;\n        a.cx = 0.5;\n        a.cy = 0.5;\n        a.dx = 0.0;\n        a.dy = 0.0;\n        a.warp = 0.0;\n        a.sx = 1.0;\n        a.sy = 1.0;\n        a.echo_alpha = 0.5;\n        a.echo_zoom = 1.01;\n        a.echo_orient = 0;\n        a.b1n = 0.0;\n        a.b2n = 0.0;\n        a.b3n = 0.0;\n        a.b1x = 1.0;\n        a.b1y = 1.0;\n      ",frame_eqs_str:"\n        // Update beat detection\n        a.b1n = a.bass * 1.2;\n        a.b2n = a.mid * 1.2;\n        a.b3n = a.treb * 1.2;\n\n        // Color rings that pulse with music\n        var ring_time = a.time * 3.0;\n        var ring = Math.sin(ring_time) * 0.5 + 0.5;\n        var ring2 = Math.cos(ring_time * 0.7) * 0.5 + 0.5;\n\n        // Rich, vibrant colors\n        a.wave_r = ring * 0.4 + a.bass * 0.8 + 0.1;\n        a.wave_g = (1.0 - ring) * 0.3 + a.mid * 0.6 + 0.1;\n        a.wave_b = ring2 * 0.3 + a.treb * 0.7 + 0.2;\n\n        // Spiral warp with bass response\n        a.warp = 0.3 + Math.sin(a.time * 0.7) * 0.2 + a.bass * 0.3;\n\n        // Dynamic zoom with breathing effect\n        a.zoom = 0.99 + Math.sin(a.time * 0.5) * 0.005 + a.bass * 0.02 - a.treb * 0.01;\n\n        // Rotation creates swirl effect\n        a.rot = a.rot + 0.002 + a.bass * 0.01 - a.treb * 0.005;\n\n        // Center drift for organic movement\n        a.cx = 0.5 + Math.sin(a.time * 0.413) * 0.08;\n        a.cy = 0.5 + Math.cos(a.time * 0.533) * 0.08;\n\n        // Slight drift\n        a.dx = Math.sin(a.time * 0.911) * 0.002 + (a.bass - a.treb) * 0.001;\n        a.dy = Math.cos(a.time * 1.131) * 0.002 + (a.mid - a.bass) * 0.001;\n\n        // Decay creates trails\n        a.decay = 0.92 + a.bass * 0.03 - a.treb * 0.01;\n\n        // Echo for psychedelic trails\n        a.echo_alpha = 0.3 + a.bass * 0.2;\n        a.echo_zoom = 1.01 + a.bass * 0.01;\n        a.echo_orient = Math.sin(a.time * 0.1) * 2;\n\n        // Wave position moves with beat\n        a.wave_x = 0.5 + Math.sin(a.time * 1.7) * 0.1 * a.bass;\n        a.wave_y = 0.5 + Math.cos(a.time * 1.3) * 0.1 * a.mid;\n\n        // Mystery creates texture variation\n        a.wave_mystery = Math.sin(a.time * 11.0) * 0.5 + a.treb * 0.3;\n\n        // Brightness pulsing\n        a.b1x = 1.0 + a.bass * 0.2;\n        a.b1y = 1.0 + a.mid * 0.2;\n      ",pixel_eqs_str:"\n        // Spiral distortion with multiple layers\n        var angle = Math.atan2(a.y - 0.5, a.x - 0.5);\n        var dist = Math.sqrt((a.x - 0.5) * (a.x - 0.5) + (a.y - 0.5) * (a.y - 0.5));\n\n        // Multi-frequency spiral\n        angle = angle + Math.sin(a.time + dist * 10.0) * a.bass * 0.2;\n        angle = angle + Math.cos(a.time * 0.7 + dist * 5.0) * a.mid * 0.1;\n\n        // Apply spiral warp\n        var new_dist = dist * (1.0 + Math.sin(angle * 6.0 + a.time * 2.0) * 0.05 * a.bass);\n\n        a.x = 0.5 + Math.cos(angle) * new_dist;\n        a.y = 0.5 + Math.sin(angle) * new_dist;\n\n        // Color shift based on position\n        a.sx = a.sx * (1.0 + Math.sin(dist * 20.0 - a.time * 3.0) * 0.02);\n        a.sy = a.sy * (1.0 + Math.cos(dist * 20.0 - a.time * 2.0) * 0.02);\n\n        // Add sparkle/noise\n        var sparkle = Math.sin(a.x * 127.1 + a.y * 311.7 + a.time * 10.0) *\n                      Math.cos(a.x * 269.5 + a.y * 183.3 + a.time * 15.0);\n        a.dx = a.dx + sparkle * 0.0005 * a.treb;\n        a.dy = a.dy + sparkle * 0.0005 * a.treb;\n      ",waves:[{baseVals:{enabled:1,thick:1,additive:1,scaling:2,smoothing:.9,r:.9,g:.2,b:.4,a:1},init_eqs_str:"",frame_eqs_str:"",point_eqs_str:""},{baseVals:{enabled:1,thick:0,additive:0,scaling:1,smoothing:.5,r:.2,g:.6,b:.9,a:.7},init_eqs_str:"",frame_eqs_str:"",point_eqs_str:""}],shapes:[{baseVals:{enabled:1,sides:32,additive:1,thickoutline:1,x:.5,y:.5,rad:.3,ang:0,tex_ang:0,tex_zoom:1,r:1,g:.3,b:.5,a:.4,r2:.5,g2:.3,b2:1,a2:.2,border_r:1,border_g:1,border_b:1,border_a:.3},init_eqs_str:"",frame_eqs_str:"\n            a.rad = 0.2 + 0.15 * a.bass;\n            a.ang = a.time * 0.5;\n            a.r = 0.5 + 0.5 * Math.sin(a.time * 2.1);\n            a.g = 0.5 + 0.5 * Math.sin(a.time * 1.7);\n            a.b = 0.5 + 0.5 * Math.sin(a.time * 1.3);\n            a.a = 0.2 + 0.3 * a.bass;\n          "},{baseVals:{enabled:1,sides:6,additive:1,thickoutline:0,x:.5,y:.5,rad:.1,ang:0,r:.3,g:.6,b:.9,a:.2,r2:.9,g2:.6,b2:.3,a2:0,border_r:0,border_g:0,border_b:0,border_a:0},init_eqs_str:"",frame_eqs_str:"\n            a.x = 0.5 + 0.3 * Math.cos(a.time * 0.7);\n            a.y = 0.5 + 0.3 * Math.sin(a.time * 0.9);\n            a.rad = 0.05 + 0.1 * a.mid;\n            a.ang = a.time * -1.0;\n            a.r = a.bass;\n            a.g = a.mid;\n            a.b = a.treb;\n          "},{baseVals:{enabled:1,sides:4,additive:1,thickoutline:1,x:.5,y:.5,rad:.25,ang:0,r:1,g:.5,b:.2,a:.1,r2:.2,g2:.5,b2:1,a2:.1,border_r:1,border_g:.8,border_b:.6,border_a:.2},init_eqs_str:"",frame_eqs_str:"\n            a.ang = a.time * 0.3;\n            a.rad = 0.2 + 0.1 * Math.sin(a.time * 1.1);\n            a.x = 0.5 + 0.1 * Math.sin(a.time * 0.53);\n            a.y = 0.5 + 0.1 * Math.cos(a.time * 0.47);\n            a.border_a = 0.1 + 0.2 * a.treb;\n          "}],warp:"",comp:""}}isEmergencyPreset(t){return!!t&&(t.id&&t.id.startsWith("emergency_"))}getUsageStats(){return{...this.usage}}resetUsage(){this.usage={minimal:0,basic_reactive:0,crowd_pleaser:0,lastUsed:null,lastSwitchTime:0}}};class te{constructor(t={}){this.settings=this.deepMerge(this.getDefaults(),t),this.loadUserPreferences()}getDefaults(){return{deviceTiers:{highEnd:{minMemory:8,minCores:4},midRange:{minMemory:4,minCores:2},lowEnd:{maxMemory:4,maxCores:2}},frameAnalysis:{thresholds:{blackFrame:60,stuckFrame:120,solidColor:180},sensitivity:{blackThreshold:.95,colorVariance:10,frameChangeThreshold:.01},deviceAdjustments:{mobile:{blackFrame:1.5,stuckFrame:1.5,solidColor:1.33},lowEnd:{blackFrame:1.25,stuckFrame:1.25,solidColor:1.17},highEnd:{blackFrame:.5,stuckFrame:.5,solidColor:.67}}},presetFailures:{autoBlocklist:{failureRateThreshold:.8,totalFailuresThreshold:50},sessionLogRetention:5,aggregateLogMaxAge:6048e5},performance:{cacheTimeout:3e5,frameAnalysisSampleSize:1e3,autoSaveInterval:3e4},renderingStrategies:{highEnd:{resolution:1920,targetFPS:60,meshSize:64,enableFXAA:!0},midRange:{resolution:1280,targetFPS:60,meshSize:48,enableFXAA:!1},lowEnd:{resolution:800,targetFPS:30,meshSize:32,enableFXAA:!1},mobile:{resolution:640,targetFPS:30,meshSize:24,enableFXAA:!1}},presetSelection:{minSwitchInterval:2e3,maxSwitchInterval:3e4,warmupBufferTime:2e3,musicalEvents:{dropDetectionThreshold:.8,buildupDetectionThreshold:.3,structureChangeThreshold:.5},scoringWeights:{energyMatch:.3,frequencyMatch:.25,rhythmMatch:.2,dynamicsMatch:.15,continuity:.1}},emergencyPresets:{maxEmergencyTime:1e4,transitionTime:2e3},userPreferences:{preferHighQuality:!1,preferredGenres:[],skipProblematicPresets:!0,allowExperimental:!1}}}deepMerge(t,e){const s={...t};return this.isObject(t)&&this.isObject(e)&&Object.keys(e).forEach(i=>{this.isObject(e[i])?i in t?s[i]=this.deepMerge(t[i],e[i]):Object.assign(s,{[i]:e[i]}):Object.assign(s,{[i]:e[i]})}),s}isObject(t){return t&&"object"==typeof t&&!Array.isArray(t)}get(t,e=null){const s=t.split(".");let i=this.settings;for(const t of s){if(void 0===i[t])return e;i=i[t]}return i}set(t,e){const s=t.split("."),i=s.pop();let r=this.settings;for(const t of s)r[t]||(r[t]={}),r=r[t];r[i]=e,this.saveUserPreferences()}getDeviceConfig(t){const e=this.settings,s=e.renderingStrategies[t]||e.renderingStrategies.midRange,i=e.frameAnalysis.deviceAdjustments[t];let r={...e.frameAnalysis.thresholds};return i&&Object.keys(r).forEach(t=>{i[t]&&(r[t]=Math.round(r[t]*i[t]))}),{rendering:s,frameAnalysis:{...e.frameAnalysis,thresholds:r},performance:e.performance}}loadUserPreferences(){try{const t=localStorage.getItem("butterchurn-user-config");if(t){const e=JSON.parse(t);this.settings.userPreferences={...this.settings.userPreferences,...e}}}catch(t){console.warn("[Config] Failed to load user preferences:",t)}}saveUserPreferences(){try{localStorage.setItem("butterchurn-user-config",JSON.stringify(this.settings.userPreferences))}catch(t){console.warn("[Config] Failed to save user preferences:",t)}}reset(){this.settings=this.getDefaults(),this.saveUserPreferences()}export(){return JSON.stringify(this.settings,null,2)}import(t){try{const e=JSON.parse(t);return this.settings=this.deepMerge(this.getDefaults(),e),this.saveUserPreferences(),!0}catch(t){return console.error("[Config] Failed to import configuration:",t),!1}}}const ee=new te;const se=new class{constructor(){this.logger=Zt,this.uiContainer=null,this.isVisible=!1}initializeUI(t="butterchurn-blocklist-manager"){let e=document.getElementById(t);e||(e=document.createElement("div"),e.id=t,e.className="butterchurn-blocklist-manager",document.body.appendChild(e)),this.uiContainer=e,this.createUI(),this.attachEventHandlers(),this.hide()}createUI(){this.uiContainer.innerHTML='\n      <div class="blocklist-panel">\n        <div class="blocklist-header">\n          <h3>Preset Blocklist Manager</h3>\n          <button class="close-btn" data-action="close"></button>\n        </div>\n\n        <div class="blocklist-tabs">\n          <button class="tab-btn active" data-tab="overview">Overview</button>\n          <button class="tab-btn" data-tab="permanent">Permanent</button>\n          <button class="tab-btn" data-tab="conditional">Conditional</button>\n          <button class="tab-btn" data-tab="settings">Settings</button>\n        </div>\n\n        <div class="blocklist-content">\n          \x3c!-- Overview Tab --\x3e\n          <div class="tab-content active" id="tab-overview">\n            <div class="stats-grid">\n              <div class="stat-card">\n                <div class="stat-value" id="stat-permanent">0</div>\n                <div class="stat-label">Permanent Blocks</div>\n              </div>\n              <div class="stat-card">\n                <div class="stat-value" id="stat-conditional">0</div>\n                <div class="stat-label">Conditional Blocks</div>\n              </div>\n              <div class="stat-card">\n                <div class="stat-value" id="stat-failures">0</div>\n                <div class="stat-label">Total Failures</div>\n              </div>\n              <div class="stat-card">\n                <div class="stat-value" id="stat-sessions">0</div>\n                <div class="stat-label">Sessions Logged</div>\n              </div>\n            </div>\n\n            <div class="actions-row">\n              <button class="action-btn" data-action="export">Export Blocklist</button>\n              <button class="action-btn" data-action="import">Import Blocklist</button>\n              <button class="action-btn danger" data-action="clear">Clear All</button>\n            </div>\n\n            <input type="file" id="import-file" style="display: none" accept=".json">\n          </div>\n\n          \x3c!-- Permanent Blocklist Tab --\x3e\n          <div class="tab-content" id="tab-permanent">\n            <div class="blocklist-controls">\n              <input type="text" id="search-permanent" placeholder="Search presets...">\n              <button class="btn-small" data-action="refresh-permanent">Refresh</button>\n            </div>\n            <div class="blocklist-items" id="permanent-list">\n              \x3c!-- Populated dynamically --\x3e\n            </div>\n          </div>\n\n          \x3c!-- Conditional Blocklist Tab --\x3e\n          <div class="tab-content" id="tab-conditional">\n            <div class="condition-selector">\n              <label>\n                <input type="radio" name="condition" value="mobile" checked>\n                Mobile\n              </label>\n              <label>\n                <input type="radio" name="condition" value="low_memory">\n                Low Memory\n              </label>\n              <label>\n                <input type="radio" name="condition" value="integrated_gpu">\n                Integrated GPU\n              </label>\n            </div>\n            <div class="blocklist-items" id="conditional-list">\n              \x3c!-- Populated dynamically --\x3e\n            </div>\n          </div>\n\n          \x3c!-- Settings Tab --\x3e\n          <div class="tab-content" id="tab-settings">\n            <div class="settings-form">\n              <div class="setting-group">\n                <label for="auto-blocklist">\n                  <input type="checkbox" id="auto-blocklist" checked>\n                  Enable Auto-Blocklist\n                </label>\n                <small>Automatically block presets with high failure rates</small>\n              </div>\n\n              <div class="setting-group">\n                <label for="failure-threshold">\n                  Failure Rate Threshold\n                  <input type="number" id="failure-threshold" min="0" max="100" value="80">\n                  <span>%</span>\n                </label>\n                <small>Block presets when failure rate exceeds this</small>\n              </div>\n\n              <div class="setting-group">\n                <label for="failure-count">\n                  Failure Count Threshold\n                  <input type="number" id="failure-count" min="1" max="1000" value="50">\n                </label>\n                <small>Block presets after this many failures</small>\n              </div>\n\n              <div class="setting-group">\n                <label for="debug-mode">\n                  <input type="checkbox" id="debug-mode">\n                  Debug Mode\n                </label>\n                <small>Show detailed failure information</small>\n              </div>\n\n              <button class="action-btn" data-action="save-settings">Save Settings</button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <style>\n        .butterchurn-blocklist-manager {\n          position: fixed;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n          z-index: 10000;\n          font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n        }\n\n        .blocklist-panel {\n          background: white;\n          border-radius: 8px;\n          box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n          width: 600px;\n          max-height: 80vh;\n          overflow: hidden;\n          display: flex;\n          flex-direction: column;\n        }\n\n        .blocklist-header {\n          padding: 16px 20px;\n          border-bottom: 1px solid #e0e0e0;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        }\n\n        .blocklist-header h3 {\n          margin: 0;\n          font-size: 18px;\n          font-weight: 600;\n        }\n\n        .close-btn {\n          background: none;\n          border: none;\n          font-size: 24px;\n          cursor: pointer;\n          color: #666;\n          padding: 0;\n          width: 30px;\n          height: 30px;\n        }\n\n        .blocklist-tabs {\n          display: flex;\n          border-bottom: 1px solid #e0e0e0;\n          padding: 0 20px;\n        }\n\n        .tab-btn {\n          background: none;\n          border: none;\n          padding: 12px 16px;\n          cursor: pointer;\n          font-size: 14px;\n          color: #666;\n          border-bottom: 2px solid transparent;\n          transition: all 0.2s;\n        }\n\n        .tab-btn.active {\n          color: #007AFF;\n          border-bottom-color: #007AFF;\n        }\n\n        .blocklist-content {\n          padding: 20px;\n          overflow-y: auto;\n          flex: 1;\n        }\n\n        .tab-content {\n          display: none;\n        }\n\n        .tab-content.active {\n          display: block;\n        }\n\n        .stats-grid {\n          display: grid;\n          grid-template-columns: repeat(2, 1fr);\n          gap: 16px;\n          margin-bottom: 20px;\n        }\n\n        .stat-card {\n          background: #f5f5f5;\n          padding: 16px;\n          border-radius: 6px;\n          text-align: center;\n        }\n\n        .stat-value {\n          font-size: 24px;\n          font-weight: 600;\n          color: #333;\n        }\n\n        .stat-label {\n          font-size: 12px;\n          color: #666;\n          margin-top: 4px;\n        }\n\n        .actions-row {\n          display: flex;\n          gap: 10px;\n        }\n\n        .action-btn {\n          flex: 1;\n          padding: 10px 16px;\n          background: #007AFF;\n          color: white;\n          border: none;\n          border-radius: 6px;\n          cursor: pointer;\n          font-size: 14px;\n          transition: background 0.2s;\n        }\n\n        .action-btn:hover {\n          background: #0051D5;\n        }\n\n        .action-btn.danger {\n          background: #FF3B30;\n        }\n\n        .action-btn.danger:hover {\n          background: #D70015;\n        }\n\n        .blocklist-items {\n          max-height: 300px;\n          overflow-y: auto;\n          margin-top: 16px;\n        }\n\n        .blocklist-item {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          padding: 12px;\n          background: #f9f9f9;\n          margin-bottom: 8px;\n          border-radius: 4px;\n        }\n\n        .blocklist-item-hash {\n          font-family: \'Courier New\', monospace;\n          font-size: 12px;\n          color: #666;\n        }\n\n        .blocklist-item-stats {\n          font-size: 11px;\n          color: #999;\n        }\n\n        .remove-btn {\n          background: #FF3B30;\n          color: white;\n          border: none;\n          padding: 4px 8px;\n          border-radius: 3px;\n          cursor: pointer;\n          font-size: 12px;\n        }\n\n        .settings-form {\n          display: flex;\n          flex-direction: column;\n          gap: 20px;\n        }\n\n        .setting-group {\n          display: flex;\n          flex-direction: column;\n          gap: 4px;\n        }\n\n        .setting-group label {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          font-size: 14px;\n        }\n\n        .setting-group small {\n          font-size: 12px;\n          color: #666;\n          margin-left: 24px;\n        }\n\n        .setting-group input[type="number"] {\n          width: 60px;\n          padding: 4px 8px;\n          border: 1px solid #ddd;\n          border-radius: 4px;\n        }\n\n        .hidden {\n          display: none !important;\n        }\n      </style>\n    ',this.addAccessibilityAttributes()}addAccessibilityAttributes(){const t=this.uiContainer.querySelector(".blocklist-tabs");t&&(t.setAttribute("role","tablist"),t.setAttribute("aria-label","Blocklist management sections")),this.uiContainer.querySelectorAll(".tab-btn").forEach((t,e)=>{const s=t.dataset.tab,i=`tab-${s}`;t.setAttribute("role","tab"),t.setAttribute("aria-controls",i),t.setAttribute("aria-selected",t.classList.contains("active")?"true":"false"),t.setAttribute("tabindex",t.classList.contains("active")?"0":"-1"),t.id=`tab-btn-${s}`,t.addEventListener("keydown",t=>{this.handleTabKeydown(t,e)})}),this.uiContainer.querySelectorAll(".tab-content").forEach(t=>{t.setAttribute("role","tabpanel"),t.setAttribute("aria-labelledby",`tab-btn-${t.id.replace("tab-","")}`),t.setAttribute("tabindex","0")}),this.uiContainer.querySelectorAll("input, button").forEach(t=>{if(!t.hasAttribute("aria-label")&&!t.hasAttribute("aria-labelledby")){if(t.closest("label")&&!t.id){const e=`control-${Math.random().toString(36).substr(2,9)}`;t.id=e}}});this.uiContainer.querySelectorAll(".stat-value").forEach(t=>{t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true")});this.uiContainer.querySelectorAll(".blocklist-items").forEach(t=>{t.setAttribute("role","list"),t.setAttribute("aria-label","Blocked presets")});const e=this.uiContainer.querySelector(".close-btn");e&&e.setAttribute("aria-label","Close blocklist manager")}handleTabKeydown(t,e){const s=Array.from(this.uiContainer.querySelectorAll(".tab-btn"));let i=e;switch(t.key){case"ArrowLeft":i=e>0?e-1:s.length-1;break;case"ArrowRight":i=e<s.length-1?e+1:0;break;case"Home":i=0;break;case"End":i=s.length-1;break;case"Enter":case" ":return t.preventDefault(),void this.switchTab(s[e].dataset.tab);default:return}t.preventDefault(),s[i].focus(),this.switchTab(s[i].dataset.tab)}attachEventHandlers(){this.uiContainer.querySelectorAll(".tab-btn").forEach(t=>{t.addEventListener("click",t=>{this.switchTab(t.target.dataset.tab)})}),this.uiContainer.addEventListener("click",t=>{const e=t.target.dataset.action;e&&this.handleAction(e,t.target)});this.uiContainer.querySelector("#import-file").addEventListener("change",t=>{this.handleImport(t.target.files[0])}),this.uiContainer.querySelectorAll('input[name="condition"]').forEach(t=>{t.addEventListener("change",()=>{this.loadConditionalList()})});this.uiContainer.querySelector("#search-permanent").addEventListener("input",t=>{this.filterPermanentList(t.target.value)})}switchTab(t){this.uiContainer.querySelectorAll(".tab-btn").forEach(e=>{const s=e.dataset.tab===t;e.classList.toggle("active",s),e.setAttribute("aria-selected",s?"true":"false"),e.setAttribute("tabindex",s?"0":"-1")}),this.uiContainer.querySelectorAll(".tab-content").forEach(e=>{e.classList.toggle("active",e.id===`tab-${t}`)}),"permanent"===t?this.loadPermanentList():"conditional"===t?this.loadConditionalList():"overview"===t?this.updateStats():"settings"===t&&this.loadSettings()}handleAction(t,e){switch(t){case"close":this.hide();break;case"export":this.exportBlocklist();break;case"import":this.uiContainer.querySelector("#import-file").click();break;case"clear":this.clearBlocklist();break;case"refresh-permanent":this.loadPermanentList();break;case"remove":this.removeFromBlocklist(e.dataset.hash,e.dataset.type);break;case"save-settings":this.saveSettings()}}updateStats(){const t=this.logger.getStatistics();this.uiContainer.querySelector("#stat-permanent").textContent=t.blocklist.permanent,this.uiContainer.querySelector("#stat-conditional").textContent=t.blocklist.mobile+t.blocklist.low_memory+t.blocklist.integrated_gpu,this.uiContainer.querySelector("#stat-failures").textContent=t.aggregate.total_failures;const e=Object.keys(localStorage).filter(t=>t.startsWith("preset-failures-")).length;this.uiContainer.querySelector("#stat-sessions").textContent=e}loadPermanentList(){const t=this.logger.blocklist,e=this.uiContainer.querySelector("#permanent-list"),s=Array.from(t.permanent).map(e=>{const s=t.metadata[e]||{};return`\n        <div class="blocklist-item" data-hash="${e}">\n          <div>\n            <div class="blocklist-item-hash">${e}</div>\n            <div class="blocklist-item-stats">\n              Added: ${new Date(s.added).toLocaleDateString()}\n              ${s.auto_blocked?"(Auto)":"(Manual)"}\n            </div>\n          </div>\n          <button class="remove-btn" data-action="remove" data-hash="${e}" data-type="permanent">\n            Remove\n          </button>\n        </div>\n      `}).join("");e.innerHTML=s||"<p>No permanently blocked presets</p>"}loadConditionalList(){const t=this.uiContainer.querySelector('input[name="condition"]:checked').value,e=this.logger.blocklist,s=this.uiContainer.querySelector("#conditional-list"),i=(e.conditional[t]||[]).map(e=>`\n        <div class="blocklist-item" data-hash="${e}">\n          <div>\n            <div class="blocklist-item-hash">${e}</div>\n            <div class="blocklist-item-stats">Blocked for: ${t}</div>\n          </div>\n          <button class="remove-btn" data-action="remove" data-hash="${e}" data-type="${t}">\n            Remove\n          </button>\n        </div>\n      `).join("");s.innerHTML=i||`<p>No presets blocked for ${t}</p>`}filterPermanentList(t){const e=this.uiContainer.querySelectorAll("#permanent-list .blocklist-item"),s=t.toLowerCase();e.forEach(t=>{const e=t.dataset.hash.toLowerCase();t.style.display=e.includes(s)?"flex":"none"})}removeFromBlocklist(t,e){if(confirm(`Remove ${t} from blocklist?`)){if("permanent"===e)this.logger.blocklist.permanent.delete(t);else{const s=this.logger.blocklist.conditional[e].indexOf(t);s>-1&&this.logger.blocklist.conditional[e].splice(s,1)}this.logger.saveToFile(),"permanent"===e?this.loadPermanentList():this.loadConditionalList(),this.updateStats()}}exportBlocklist(){const t=this.logger.exportBlocklist(),e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(e),i=document.createElement("a");i.href=s,i.download=`butterchurn-blocklist-${Date.now()}.json`,i.click(),URL.revokeObjectURL(s),alert(`Blocklist exported with ${t.stats.total_blocked} entries`)}async handleImport(t){if(t)try{const e=await t.text(),s=JSON.parse(e);this.logger.importBlocklist(s)?(alert("Successfully imported blocklist entries"),this.updateStats(),this.loadPermanentList()):alert("Import failed")}catch(t){alert(`Failed to import blocklist: ${t.message}`)}}clearBlocklist(){confirm("Clear all preset failure logs and blocklists? This cannot be undone.")&&(this.logger.clearAllLogs(),alert("All logs and blocklists cleared"),this.updateStats(),this.loadPermanentList())}loadSettings(){const t=!1!==ee.get("userPreferences.autoBlocklistEnabled"),e=ee.get("presetFailures.autoBlocklist.failureRateThreshold")||.8,s=ee.get("presetFailures.autoBlocklist.totalFailuresThreshold")||50,i=ee.get("userPreferences.debugMode")||!1;this.uiContainer.querySelector("#auto-blocklist").checked=t,this.uiContainer.querySelector("#failure-threshold").value=100*e,this.uiContainer.querySelector("#failure-count").value=s,this.uiContainer.querySelector("#debug-mode").checked=i}saveSettings(){const t=this.uiContainer.querySelector("#auto-blocklist").checked,e=this.uiContainer.querySelector("#failure-threshold").value/100,s=parseInt(this.uiContainer.querySelector("#failure-count").value),i=this.uiContainer.querySelector("#debug-mode").checked;ee.set("userPreferences.autoBlocklistEnabled",t),ee.set("presetFailures.autoBlocklist.failureRateThreshold",e),ee.set("presetFailures.autoBlocklist.totalFailuresThreshold",s),ee.set("userPreferences.debugMode",i),alert("Settings saved")}show(){this.uiContainer&&(this.uiContainer.classList.remove("hidden"),this.isVisible=!0,this.updateStats())}hide(){this.uiContainer&&(this.uiContainer.classList.add("hidden"),this.isVisible=!1)}toggle(){this.isVisible?this.hide():this.show()}createToggleButton(t=null){const e=document.createElement("button");if(e.textContent="Blocklist Manager",e.className="butterchurn-blocklist-toggle",e.style.cssText="\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      padding: 10px 20px;\n      background: #007AFF;\n      color: white;\n      border: none;\n      border-radius: 20px;\n      cursor: pointer;\n      font-size: 14px;\n      z-index: 9999;\n    ",e.addEventListener("click",()=>this.toggle()),t){const s=document.getElementById(t);s?s.appendChild(e):document.body.appendChild(e)}else document.body.appendChild(e);return e}isBlocked(t,e=null){return this.logger.isBlocked(t,e)}getStats(){return this.logger.getStatistics()}showUI(){return this.show()}};class ie{constructor(t,e){this.butterchurn=t,this.db=e,this.currentHash=null,this.currentPreset=null,this.lastSwitch=0,this.currentWarmupTime=0,this.minSwitchInterval=void 0!==te&&te?.get?te.get("presetSelection.minSwitchInterval",2e3):2e3,this.maxSwitchInterval=void 0!==te&&te?.get?te.get("presetSelection.maxSwitchInterval",3e4):3e4,this.frameAnalyzer=Kt||null,this.presetLogger=Zt||null,this.emergencyManager=$t||null,this.blocklistManager=se||null,this.deviceTier=this.detectDeviceTier(),this.frameAnalyzer&&this.frameAnalyzer.adjustForDevice(this.deviceTier),this.isEmergencyMode=!1,this.emergencyStartTime=0,this.presetPack=null,this.problematicPresets=new Set,this.detectProblematic=void 0===te||!te?.get||te.get("userPreferences.skipProblematicPresets",!0),this.frameCheckInterval=100,this.lastFrameCheck=0,this.audioHistory=[],this.historySize=30,this.weights=void 0!==te&&te?.get?te.get("presetSelection.scoringWeights",{energyMatch:.3,frequencyMatch:.25,rhythmMatch:.2,dynamicsMatch:.15,continuity:.1,bassMatch:.15,performance:.1,variety:.05}):{energyMatch:.3,frequencyMatch:.25,rhythmMatch:.2,dynamicsMatch:.15,continuity:.1,bassMatch:.15,performance:.1,variety:.05},this.recentPresets=[],this.recentPresetsMax=10}setPresetPack(t){this.presetPack=t,console.log("Preset pack loaded with",Object.keys(t).length,"presets")}pause(){this.isPaused=!0,console.log("[IntelligentSelector] Paused - no more preset switches")}resume(){this.isPaused=!1,this.lastSwitch=performance.now(),console.log("[IntelligentSelector] Resumed")}detectDeviceTier(){const t=navigator.deviceMemory||4,e=navigator.hardwareConcurrency||2;return/Mobile|Android|iPhone/i.test(navigator.userAgent)?"mobile":t>=8&&e>=4?"high_end":t<=4&&e<=2?"low_end":"mid_range"}async initialize(){if(this.presetLogger&&await this.presetLogger.initialize(),"string"==typeof this.db){const t=await fetch(this.db);this.db=await t.json()}if(this.db&&(console.log(`Intelligent selector initialized with ${Object.keys(this.db.presets).length} unique presets`),!this.db.presets||!this.db.indices))throw new Error("Invalid fingerprint database structure");if(this.presetLogger){const t=this.presetLogger.getStatistics();console.log(`[IntelligentSelector] Loaded blocklist with ${t.blocklist.permanent} permanent blocks`)}}update(t,e=null){if(this.isPaused)return null;const s=performance.now();e&&this.detectProblematic&&s-this.lastFrameCheck>this.frameCheckInterval&&(this.checkFrameForProblems(e),this.lastFrameCheck=s),this.audioHistory.push({...t,timestamp:s}),this.audioHistory.length>this.historySize&&this.audioHistory.shift();const i=this.calculateAudioFeatures(),r=s-this.lastSwitch,a=this.shouldSwitchPreset(i,r);void 0===this.updateCount&&(this.updateCount=0),this.updateCount++,this.updateCount<=5&&console.log(`[Update ${this.updateCount}] timeSinceSwitch: ${r}ms, shouldSwitch: ${a}, currentPreset: ${this.currentPreset}`);let o=null;if(a){if(this.isEmergencyMode){s-this.emergencyStartTime>(void 0!==te&&te?.get?te.get("emergencyPresets.maxEmergencyTime",1e4):1e4)&&this.exitEmergencyMode()}if(!this.isEmergencyMode){const t=this.selectBestPresetWithLogic(i);if(t&&t.bestHash!==this.currentHash){const e=this.blocklistManager?.isBlocked(t.bestHash)||{blocked:!1};e.blocked?(console.log(`[IntelligentSelector] Preset ${t.bestHash} is blocked: ${e.reason}`),this.selectAlternativePreset(i)):(this.switchToPreset(t.bestHash),o=t.logic)}}}return{currentPreset:this.currentHash,features:i,nextSwitch:Math.max(0,this.minSwitchInterval-r),selectionLogic:o,isEmergencyMode:this.isEmergencyMode,deviceTier:this.deviceTier}}selectRandomPreset(){if(console.log(`[selectRandomPreset] Called - currentPreset: ${this.currentPreset}, recentPresets: ${this.recentPresets.length}`),!this.presetPack)return;const t=Object.keys(this.presetPack).filter(t=>!this.recentPresets.includes(t)&&!this.isProblematic(t));if(t.length>0){const e=t[Math.floor(Math.random()*t.length)];this.switchToPresetPack(e)}}calculateAudioFeatures(){if(0===this.audioHistory.length)return{energy:.5,bassEnergy:.5,trebleEnergy:.5,isDrop:!1,isBuildup:!1,trend:"stable"};const t=this.audioHistory.slice(-10),e=this.audioHistory.slice(0,10),s=t.reduce((t,e)=>t+(e.bass||0),0)/t.length,i=t.reduce((t,e)=>t+(e.mid||0),0)/t.length,r=t.reduce((t,e)=>t+(e.treb||0),0)/t.length,a=(s+i+r)/3,o=e.length>0?e.reduce((t,e)=>t+(e.bass||0),0)/e.length:s,n=e.length>0?e.reduce((t,e)=>t+(e.bass+e.mid+e.treb||0),0)/(3*e.length):a,h=a-n;return{energy:a,bassEnergy:s,trebleEnergy:r,isDrop:s-o>.3&&s>.7,isBuildup:h>.1&&a>n,isChill:a<.3&&Math.abs(h)<.1,trend:h>.1?"rising":h<-.1?"falling":"stable"}}shouldSwitchPreset(t,e){const s=Math.max(this.minSwitchInterval,1e3*(this.currentWarmupTime||0)+2e3);if(e>this.maxSwitchInterval)return!0;if(e<s)return!1;if(t.isDrop)return!0;if(t.isBuildup&&e>.7*this.minSwitchInterval)return!0;if(this.currentHash){const e=this.db.presets[this.currentHash]?.fingerprint;if(e){if(Math.abs(e.energy-t.energy)>.5)return!0}}const i=(e-this.minSwitchInterval)/(this.maxSwitchInterval-this.minSwitchInterval);return Math.random()<.3*i}selectBestPresetWithLogic(t){const e={targetEnergy:t.energy,candidates:[],topScores:[],reason:""},s=this.getCandidates(t);if(!s||0===s.length)return e.reason="No suitable candidates",{bestHash:null,logic:e};e.candidates=s.slice(0,5).map(t=>t.substring(0,8));const i=s.map(e=>({hash:e,score:this.scorePreset(e,t)}));i.sort((t,e)=>e.score-t.score),e.topScores=i.slice(0,3).map(t=>`${t.hash.substring(0,8)}: ${t.score.toFixed(2)}`),t.isDrop||t.energy>.8?e.reason=" Drop detected - high energy":t.isChill||t.energy<.3?e.reason=" Chill mode - calm visuals":t.bassEnergy>.7?e.reason=" Bass heavy - reactive presets":e.reason=" Balanced - mixed selection";const r=i.slice(0,3);if(r.length>0){const t=r.map(t=>t.score),s=this.weightedRandom(r,t);return e.reason+=`  ${s.hash.substring(0,8)}`,{bestHash:s.hash,logic:e}}const a=i[0].hash;return e.reason+=`  ${a.substring(0,8)}`,{bestHash:a,logic:e}}selectBestPreset(t){const e=this.getCandidates(t);if(0===e.length)return console.warn("No suitable preset candidates found"),null;const s=e.map(e=>({hash:e,score:this.scorePreset(e,t)}));s.sort((t,e)=>e.score-t.score);const i=s.slice(0,3);if(i.length>0){const t=i.map(t=>t.score);return this.weightedRandom(i,t).hash}return s[0].hash}getCandidates(t,e=30){let s=[];return s=t.isDrop||t.energy>.8?[...this.db.indices.high]:t.isChill||t.energy<.3?[...this.db.indices.calm]:t.bassEnergy>.7?[...this.db.indices.bass]:[...this.pickRandom(this.db.indices.high,5),...this.pickRandom(this.db.indices.bass,5),...this.pickRandom(this.db.indices.particle,5),...this.pickRandom(this.db.indices.fractal,5),...this.pickRandom(this.db.indices.organic,5)],s=s.filter(t=>!this.recentPresets.includes(t)),this.currentHash&&(s=s.filter(t=>t!==this.currentHash)),s=s.filter(t=>!this.problematicPresets.has(t)),this.shuffle(s).slice(0,e)}scorePreset(t,e){const s=this.db.presets[t];if(!s||!s.fingerprint)return 0;const i=s.fingerprint;let r=0;if(r+=(1-Math.abs(i.energy-e.energy))*this.weights.energyMatch,e.bassEnergy>.6&&i.bass>.6?r+=this.weights.bassMatch:e.bassEnergy<.3&&i.bass<.3&&(r+=.5*this.weights.bassMatch),this.currentHash){const t=this.db.presets[this.currentHash]?.fingerprint;if(t){r+=(1-Math.abs(i.complexity-t.complexity))*this.weights.continuity}}return r+=i.fps/60*this.weights.performance,i.styles&&i.styles.length>0&&(e.isDrop&&i.styles.includes("particle")||e.isChill&&i.styles.includes("organic"))&&(r+=this.weights.variety),r}async switchToPreset(t){const e=this.db.presets[t];if(!e)return void console.error(`Preset ${t} not found in database`);const s=e.names[0];this.currentWarmupTime=e.fingerprint.warmupTime||0,console.log(`Switching to preset ${t}: ${s.substring(0,40)}...`),console.log(`  Energy: ${e.fingerprint.energy.toFixed(2)}, Bass: ${e.fingerprint.bass.toFixed(2)}, FPS: ${e.fingerprint.fps}`),this.currentWarmupTime>0&&console.log(`  Warmup time: ${this.currentWarmupTime}s (will display for at least ${this.currentWarmupTime+2}s)`),this.detectSolidColor&&!this.solidColorChecks.has(t)&&setTimeout(()=>{this.checkForSolidColor(t,!1)},1e3*(this.currentWarmupTime+1)),this.butterchurn&&this.butterchurn.loadPreset&&await this.loadPresetByHash(t),this.currentHash=t,this.currentPreset=e,this.lastSwitch=performance.now(),this.recentPresets.push(t),this.recentPresets.length>this.recentPresetsMax&&this.recentPresets.shift()}switchToPresetPack(t){if(!this.presetPack||!this.presetPack[t])return;if(this.db&&this.db.nameIndex&&this.db.nameIndex[t]){const e=this.db.nameIndex[t],s=this.db.presets[e];s&&s.fingerprint&&(this.currentWarmupTime=s.fingerprint.warmupTime||0,this.currentWarmupTime>0&&console.log(`Preset needs ${this.currentWarmupTime}s warmup, will display for at least ${this.currentWarmupTime+2}s`))}else this.currentWarmupTime=0;console.log("Switching to preset:",t);let e=2;this.recentPresets.length<2?e=0:this.currentWarmupTime>0&&(e=Math.min(1,2-.5*this.currentWarmupTime)),console.log(`Loading preset with ${e}s blend time (warmup: ${this.currentWarmupTime}s)`),this.butterchurn.loadPreset(this.presetPack[t],e),this.detectSolidColor&&!this.solidColorChecks.has(t)&&setTimeout(()=>{this.checkForSolidColor(t,!0)},1e3*(this.currentWarmupTime+1)),this.currentPreset=t,this.lastSwitch=performance.now(),this.recentPresets.push(t),this.recentPresets.length>this.recentPresetsMax&&this.recentPresets.shift()}markProblematic(t){if(this.problematicPresets.add(t),console.warn(`Marked preset ${t} as problematic due to rendering issues`),"undefined"!=typeof localStorage){const t=Array.from(this.problematicPresets);localStorage.setItem("problematicPresets",JSON.stringify(t))}}checkFrameForProblems(t){if(!t||!this.currentHash)return;const e=this.butterchurn?.canvas?.width||800,s=this.butterchurn?.canvas?.height||600;if(!this.frameAnalyzer)return;const i=this.frameAnalyzer.analyzeFrame(t,e,s);if(i.isProblematic){const t={audioLevel:this.audioHistory[this.audioHistory.length-1]?.energy||0,fps:this.butterchurn?.fps||60,frameData:i};this.presetLogger&&this.presetLogger.logFailure(this.currentHash,i.reason,t),i.confidence>.8&&(console.warn(`[IntelligentSelector] Detected ${i.reason} - entering emergency mode`),this.enterEmergencyMode(t))}}enterEmergencyMode(t){if(!this.emergencyManager)return void console.warn("[IntelligentSelector] Emergency manager not available");const e=this.emergencyManager.getEmergencyPreset({deviceTier:this.deviceTier,audioLevel:t.audioLevel||0});e&&e.preset&&(console.log(`[IntelligentSelector] Switching to emergency preset: ${e.key}`),this.isEmergencyMode=!0,this.emergencyStartTime=performance.now(),this.butterchurn&&"function"==typeof this.butterchurn.loadPreset&&(this.butterchurn.loadPreset(e.preset,.5),this.currentHash=e.preset.id,this.currentPreset=e.preset.name,this.lastSwitch=performance.now()))}exitEmergencyMode(){console.log("[IntelligentSelector] Exiting emergency mode"),this.isEmergencyMode=!1,this.emergencyStartTime=0;const t=this.calculateAudioFeatures(),e=this.selectBestPreset(t);e&&this.switchToPreset(e)}selectAlternativePreset(t){const e=this.getCandidates(t,50);for(const t of e){if(!(this.blocklistManager?.isBlocked(t)||{blocked:!1}).blocked)return console.log(`[IntelligentSelector] Using alternative preset: ${t}`),void this.switchToPreset(t)}console.warn("[IntelligentSelector] All candidates blocked - using emergency preset"),this.enterEmergencyMode({audioLevel:t.energy})}isProblematic(t){if(this.blocklistManager){const e=this.blocklistManager.isBlocked(t);if(e&&e.blocked)return!0}return this.problematicPresets.has(t)}markProblematic(t){this.problematicPresets.add(t);const e={audioLevel:this.audioHistory[this.audioHistory.length-1]?.energy||0,fps:this.butterchurn?.fps||60};this.presetLogger&&this.presetLogger.logFailure(t,"solid_color_detected",e),console.warn(`[IntelligentSelector] Marked preset ${t} as problematic`)}markProblematicPack(t){if(this.problematicPresets.add(t),console.warn(`Marked preset "${t}" as problematic due to rendering issues`),"undefined"!=typeof localStorage){const t=Array.from(this.problematicPresets);localStorage.setItem("problematicPresets",JSON.stringify(t))}}checkForSolidColor(t){if(this.currentHash!==t)return;this.solidColorChecks.set(t,!0);const e=this.butterchurn?.canvas||document.querySelector("canvas");if(e)try{const s=e.getContext("2d")||e.getContext("webgl");if(!s)return;let i=!1;if(s instanceof WebGLRenderingContext||s instanceof WebGL2RenderingContext){const t=new Uint8Array(400),r=Math.floor(e.width*e.height/100);for(let i=0;i<100;i++){const a=i*r%e.width,o=Math.floor(i*r/e.width);s.readPixels(a,o,1,1,s.RGBA,s.UNSIGNED_BYTE,t.subarray(4*i,4*i+4))}i=this.checkPixelVariance(t)}else{const t=s.getImageData(0,0,Math.min(100,e.width),Math.min(100,e.height)).data;i=this.checkPixelVariance(t)}i?(console.warn(` Detected solid color for preset ${t} - marking as problematic`),this.markProblematic(t),setTimeout(()=>{const e=this.calculateAudioFeatures(),s=this.selectBestPreset(e);s&&s!==t&&this.switchToPreset(s)},500)):console.log(` Preset ${t} rendering correctly with color variation`)}catch(t){console.error("Error checking for solid color:",t)}}checkForSolidColorPack(t){if(this.currentPreset!==t)return;this.solidColorChecks.set(t,!0);const e=document.querySelector("canvas");if(e)try{const s=e.getContext("2d")||e.getContext("webgl");if(!s)return;let i=!1;if(s instanceof WebGLRenderingContext||s instanceof WebGL2RenderingContext){const t=new Uint8Array(400),r=Math.floor(e.width*e.height/100);for(let i=0;i<100;i++){const a=i*r%e.width,o=Math.floor(i*r/e.width);s.readPixels(a,o,1,1,s.RGBA,s.UNSIGNED_BYTE,t.subarray(4*i,4*i+4))}i=this.checkPixelVariance(t)}else{const t=s.getImageData(0,0,Math.min(100,e.width),Math.min(100,e.height)).data;i=this.checkPixelVariance(t)}i?(console.warn(` Detected solid color for preset "${t}" - marking as problematic`),this.markProblematicPack(t),setTimeout(()=>{this.selectRandomPreset()},500)):console.log(` Preset "${t}" rendering correctly with color variation`)}catch(t){console.error("Error checking for solid color:",t)}}checkPixelVariance(t){if(t.length<4)return!0;let e=255,s=0,i=255,r=0,a=255,o=0;for(let n=0;n<t.length;n+=4){const h=t[n],l=t[n+1],A=t[n+2];e=Math.min(e,h),s=Math.max(s,h),i=Math.min(i,l),r=Math.max(r,l),a=Math.min(a,A),o=Math.max(o,A)}const n=s-e+(r-i)+(o-a),h=n<30;if(h){const t=Math.floor((e+s)/2),h=Math.floor((i+r)/2),l=Math.floor((a+o)/2);console.log(`Solid color detected: RGB(${t}, ${h}, ${l}), variance: ${n}`)}return h}async loadPresetByHash(t){const e=this.db.presets[t].names[0];if(console.log(`Loading preset: ${e}`),this.butterchurn&&"function"==typeof this.butterchurn.loadPreset&&this.presetPack){let t=Object.keys(this.presetPack).find(t=>{if(t===e)return!0;if(t.includes(e))return!0;if(e.includes(t))return!0;return t.split(/[\[\(]/)[0].trim().toLowerCase()===e.split(/[\[\(]/)[0].trim().toLowerCase()});if(!t){const s=Object.keys(this.presetPack);s.length>0&&(console.warn("[IntelligentSelector] Could not find preset, using random fallback:",e),t=s[Math.floor(Math.random()*s.length)])}if(t&&this.presetPack[t]){const e=this.presetPack[t];if(!e||"object"!=typeof e)return void console.error("[IntelligentSelector] Invalid preset object:",t);console.log("[IntelligentSelector] Actually loading preset:",t),this.butterchurn.loadPreset(e,2),this.currentPreset=t,this.lastSwitch=performance.now()}else console.warn("[IntelligentSelector] Could not find preset in collection:",e)}else console.warn("[IntelligentSelector] Cannot load - missing butterchurn or presetPack")}pickRandom(t,e){return this.shuffle([...t]).slice(0,e)}shuffle(t){const e=[...t];for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}weightedRandom(t,e){const s=e.reduce((t,e)=>t+e,0),i=Math.random()*s;let r=0;for(let s=0;s<t.length;s++)if(r+=e[s],i<=r)return t[s];return t[t.length-1]}getState(){const t=this.presetLogger?.getStatistics(),e=this.frameAnalyzer?.getState();return{currentPreset:this.currentHash,presetName:this.db?.presets[this.currentHash]?.names?.[0]||this.currentPreset,timeSinceSwitch:performance.now()-this.lastSwitch,recentPresets:this.recentPresets,audioHistorySize:this.audioHistory.length,isEmergencyMode:this.isEmergencyMode,deviceTier:this.deviceTier,blocklist:t?.blocklist||{},frameAnalysis:e?.lastAnalysis||null,problematicDetected:this.problematicPresets.size}}nextPreset(){const t=this.calculateAudioFeatures(),e=this.selectBestPreset(t);e&&this.switchToPreset(e)}setWeights(t){this.weights={...this.weights,...t}}}"undefined"!=typeof window&&(window.IntelligentPresetSelector=ie);class re{static createVisualizer(t,e,s){return new jt(t,e,s)}}re.IntelligentPresetSelector=ie,t.IntelligentPresetSelector=ie,t.default=re,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=butterchurn.min.js.map
